/*!
 * downstream-electron,0.4.0,2020-04-21 10:48:36.851,castlabs GmbH
 * 
 * Copyright (C) 2017 Castlabs GmbH.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("electron"),require("underscore"),require("xmldom"),require("mkdirp"),require("jsonfile"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("base64-js"),require("url-parse"),require("get-folder-size"));else if("function"==typeof define&&define.amd)define(["electron","underscore","xmldom","mkdirp","jsonfile","flake-idgen","biguint-format","moment/moment","base64-js","url-parse","get-folder-size"],e);else{var n="object"==typeof exports?e(require("electron"),require("underscore"),require("xmldom"),require("mkdirp"),require("jsonfile"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("base64-js"),require("url-parse"),require("get-folder-size")):e(t.electron,t.underscore,t.xmldom,t.mkdirp,t.jsonfile,t["flake-idgen"],t["biguint-format"],t["moment/moment"],t["base64-js"],t["url-parse"],t["get-folder-size"]);for(var o in n)("object"==typeof exports?exports:t)[o]=n[o]}}(global,function(n,o,r,s,i,a,l,u,d,f,c){return m={},h.m=p=[function(t,e,n){"use strict";function p(t){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var o=n(17),r=n(18),s=n(6),m=/%[A-Za-z0-9_-]+%/g,i={};function a(t,e){var n=t;return"object"===p(n)&&(n=n.msg),n=n?function(t,e){if((e=e||"")instanceof Array)for(var n=g(t.match(m)),o=0,r=Math.min(n.length,e.length);o<r;o++)t=t.replace(new RegExp(n[o],"g"),e[o]);else if("object"===p(e)){for(var s in e)e.hasOwnProperty(s)&&(t=t.replace(new RegExp("%"+s+"%","g"),e[s]));t=t.replace(m,e)}else"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e||(t=t.replace(m,e));return t}(n,e):"Internal Error"}function l(t){for(var e=[],n=1,o=t.length;n<o;n++)e.push(t[n]);return 0===e.length?e=void 0:1===e.length&&(e=e[0]),e}function g(t){for(var e={},n=[],o=0,r=(t=t||[]).length;o<r;o++)e[t[o]]||(e[t[o]]=!0,n.push(t[o]));return n}i.getError=function(t){var e=l(arguments),n=function(t,e){var n=t,o=[];if("object"===p(n)&&(n=n.msg),n)if(e instanceof Array)for(var r=g(n.match(m)),s=0,i=Math.min(r.length,e.length);s<i;s++){var a={};a[r[s].replace(/%/g,"")]=e[s],o.push(a)}else if("object"===p(e)){for(var l in e)if(e.hasOwnProperty(l)){var u={};u[l]=e[l],o.push(u)}}else if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)for(var d=n.match(m)||[],f=0,c=d.length;f<c;f++){var h={};h[d[f].replace(/%/g,"")]=e,o.push(h)}return o&&!o.length&&(o=void 0),o}(t,e),o=a(t,e);return{code:function(t){var e=(t=t||{}).code;return e=e||s.GENERAL}(t),msg:o,keys:n}},i.getTranslation=function(t){return a(t,l(arguments))},i.e=o,i.t=r,t.exports=i},function(t,e,n){"use strict";var l=n(2).app,u=n(4),d={downloadingThreadsRules:{items:[{max:10,files:5},{max:100,files:10},{max:1e3,files:30},{max:1e5,files:50}],threads:[{size:10,number:1},{size:100,number:3},{size:1e3,number:4},{size:1e5,number:5}]},MAX_ERRORS_DOWNLOAD_RETRY:5,MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY:100,MAX_ERRORS_DOWNLOAD_CHUNK_RETRY:5,offlineDomain:"http://127.0.0.1",offlineContentPortStart:3010,maxOfflineContentPortRange:3030,numberOfManifestsInParallel:2,stopOnError:!1,stores:{DOWNLOADS:{LEFT:"left",DOWNLOADING:"downloading",DOWNLOADED:"downloaded",ERRORS:"errors"},STATUS:"status",PARAMS:"params",MANIFEST:"manifest",PERSISTENT:"persistent",DATA:"data"},saveToDisk:!0,times:{DOWNLOAD_TIMEOUT:5e3,RETRY_TIMEOUT:5e3},useChunkedEncoding:!1,useHeadRequests:!0,noCache:!1,defaultManifestRequestOptions:{headers:{Accept:"*/*","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Electron/1.8.6 Safari/537.36"},timeout:5e3},customManifestIdFolderRegex:/^([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\-|\_){1,1}([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\ |\,|\.|\;|\'|\[|\]|\{|\}|\!|\@|\#|\$|\%|\&|\*|\(|\)|\-|\_|\=|\+?){0,49}$/i,openingTagForInvalidCustomManifestIdCharacter:"<span style='background-color:blue;'>",closingTagForInvalidCustomManifestIdCharacter:"</span>"};e.load=function(t){var e=l.getPath("userData"),n="settings",o="public",r="movies";t&&(t.appDir&&(e=t.appDir),t.settingsName&&(n=t.settingsName),t.publicName&&(o=t.publicName),t.downloadsName&&(r=t.downloadsName),t.offlineDomain&&(d.offlineDomain=t.offlineDomain),t.offlineContentPortStart&&(d.offlineContentPortStart=t.offlineContentPortStart),t.maxOfflineContentPortRange&&(d.maxOfflineContentPortRange=t.maxOfflineContentPortRange),t.numberOfManifestsInParallel&&(d.numberOfManifestsInParallel=t.numberOfManifestsInParallel),void 0!==t.stopOnError&&(d.stopOnError=t.stopOnError),t.customManifestIdFolderRegex&&(d.customManifestIdFolderRegex=t.customManifestIdFolderRegex),t.openingTagForInvalidCustomManifestIdCharacter&&(d.openingTagForInvalidCustomManifestIdCharacter=t.openingTagForInvalidCustomManifestIdCharacter),t.closingTagForInvalidCustomManifestIdCharacter&&(d.closingTagForInvalidCustomManifestIdCharacter=t.closingTagForInvalidCustomManifestIdCharacter),void 0!==t.useHeadRequests&&(d.useHeadRequests=t.useHeadRequests),t.times&&t.times.RETRY_TIMEOUT&&(d.times.RETRY_TIMEOUT=t.times.RETRY_TIMEOUT),t.MAX_ERRORS_DOWNLOAD_RETRY&&(d.MAX_ERRORS_DOWNLOAD_RETRY=t.MAX_ERRORS_DOWNLOAD_RETRY),t.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY&&(d.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY=t.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY),t.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY&&(d.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY=t.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY),t.noCache&&(d.noCache=t.noCache)),e=u.join(u.resolve(e),"/");var s=u.join(u.resolve(e+n)+"/","/"),i=u.join(u.resolve(e+o)+"/","/"),a=u.join(u.resolve(i+r)+"/","/");d.appDir=e,d.downloadsFolderPath=a,d.downloadsName=r,d.publicFolderPath=i,d.settingsFolder=s},e.getSettings=function(){return d}},function(t,e){t.exports=n},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("path")},function(t,e){t.exports=o},function(t,e,n){"use strict";t.exports={GENERAL:-1,ERRORS:{INTERNAL_ERROR:1,BROKEN:11,FINISHED:12,UNFINISHED:13,STOPPED:14,CREATED:15,MISSING:16,RESUMED:17,STARTED:18,LOADING:19,REMOVED:20,INFO:21,EXISTS:22,NOT_FOUND:100}}},function(t,e,n){var o=n(3),r=n(1),s=Object.assign({start:0,end:null},r.getSettings().defaultManifestRequestOptions);t.exports={checkForLocalFile:function(t,n){o.stat(t,function(t,e){t?n(!1):n(!0,e.size)})},defaultOptions:s,errors:{ABORTED:"ABORTED",CHUNK_ERROR:"CHUNK_ERROR",CHUNK_SIZE_ERROR:"CHUNK_SIZE_ERROR",FILE_CREATING_ERROR:"FILE_CREATING_ERROR",FILE_WRITING_ERROR:"FILE_WRITING_ERROR",NO_SPACE_LEFT_ERROR:"NO_SPACE_LEFT_ERROR",INTERNET:"INTERNET",TIMEOUT:"TIMEOUT"}}},function(t,e,n){"use strict";t.exports={CREATED:"CREATED",STARTED:"STARTED",ERROR:"ERROR",STOPPED:"STOPPED",FINISHED:"FINISHED",BROKEN:"BROKEN",QUEUED:"QUEUED"}},function(t,e,n){"use strict";var o=n(40),r=n(41),s=new o,i=(a.getUUID=function(){var t=s.next();return r(t,"dec")},a);function a(){}e.SnowflakeId=i},function(t,e){t.exports=r},function(t,e,n){"use strict";t.exports=function(t,e,n){if(void 0!==n)for(var o=0,r=e.length;o<r;o++){var s=e[o],i=s.defaultValue,a=s.name||s;t[a]=void 0!==n[a]?n[a]:i}}},function(t,e,n){"use strict";var s=n(13),i=n(1),a=n(29),l=n(73);function o(t,e,n){this.manifestId=t,this.storageKey=e,this.items=n}o.prototype._saveToDisk=function(e,n){var o=this,t=i.getSettings().settingsFolder+this.manifestId+"/",r=t+(this.storageKey+".json");s(t).then(function(){var t=u(o.storageKey,o.items);a.writeFile(r,t,function(t){t?n(t):e()})},function(t){n(t)})},o.prototype.save=function(){return new Promise(this._saveToDisk.bind(this))},t.exports=o;var u=function(t,e){var n,o=[];if("downloading"===t){for(var r in o=[],e)o.push(e[r]);e=o}if(e instanceof Array){n=[];for(var s=0,i=e.length;s<i;s++)n.push(new l(e[s]))}else n=e;return n}},function(t,e){t.exports=s},function(t,e){t.exports=require("events")},function(t,e,n){"use strict";var o=n(44),s=n(45),i=n(46),r=n(55),a=n(9),l=n(56),u=n(57),d=new o.ManifestLoader,f=n(58),c=n(59),h=(p.prototype._setUpUrl=function(t){var e=f(t).pathname;this.url=t,this.url_domain=t.substring(0,t.lastIndexOf("/")+1),this.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length)},p.prototype.load=function(t){var s=this;return new Promise(function(o,r){s._setUpUrl(t),d.load(t).then(function(t){var e=c.isUTF16(t.response);t.response=t.response.toString(e?"utf16le":"utf-8");var n=t.response;s.manifestXML=new i.ManifestXML,s.manifestXML.parse(n,function(){o()},function(t){throw r(t),new Error("Manifest parsing error")})},function(t){r(t)})})},p.prototype.loadWithManifest=function(n,o){var r=this;return new Promise(function(t,e){r._setUpUrl(n),r.manifestXML=new i.ManifestXML,r.manifestXML.parse(o,function(){t()},function(t){throw e(t),new Error("Manifest parsing error")})})},p.prototype.loadFromLocal=function(t,o){var r=this;return new Promise(function(e,n){o&&t?s(t).then(function(t){r._setUpUrl(o),r.manifestXML=new i.ManifestXML,r.manifestXML.parse(t,function(){e()},function(t){n(t)})},function(t){n(t)}):n("wrong parameter")})},p.prototype.loadFromStr=function(t,e){this.url_domain=e.substring(0,e.lastIndexOf("/")+1),this.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length),this.manifestXML=new i.ManifestXML,this.manifestXML.parse(t)},p.prototype.getAdaptationSets=function(){var t=this.manifestXML.getVideoAdaptation(),e=this.manifestXML.getAudioAdaptation(),n=this.manifestXML.getTextAdaptation();return new r.AllAdaptationSets(t,e,n)},p.prototype.getVideoRepresentations=function(){return this.manifestXML.getVideoAdaptation()},p.prototype.getAudioRepresentations=function(){return this.manifestXML.getAudioAdaptation()},p.prototype.getTextRepresentations=function(){return this.manifestXML.getTextAdaptation()},p.prototype.getProtections=function(){var t={};return t.video=u(this.getVideoRepresentations()),t.audio=u(this.getAudioRepresentations()),t.text=u(this.getTextRepresentations()),t},p.prototype.getRemoteDomain=function(){return this.url_domain},p.prototype.getManifestName=function(){return this.manifest_name},p.prototype.getManifestUrl=function(){return this.url},p.prototype.getManifestXML=function(){return this.manifestXML.getManifestXML()},p.prototype.removeNode=function(){this.manifestXML.removeNode()},p.prototype.getJsonInfo=function(){var t={};return t.id=this.id,t.audio=l(this.getAudioRepresentations()),t.video=l(this.getVideoRepresentations()),t.text=l(this.getTextRepresentations()),t.protections=this.getProtections(),t},p);function p(t){this.id=t||String(a.SnowflakeId.getUUID())}e.Manifest=h},function(t,e,n){"use strict";var o=n(9),r=(s.prototype.setParentNode=function(t){this.parentNode=t},s.prototype.setChildCollection=function(t){this.childCollection=t},s.prototype.setCurrentNode=function(t){this.currentNode=t},s.prototype.buildAttributeList=function(t,e){this.writeAttributesToList(t,e)},s.prototype.writeAttributesToList=function(t,e){var n=t.attributes;for(var o in n)e[n[o].nodeName]||(e[n[o].nodeName]=n[o].nodeValue);null!==t.parentNode&&this.buildAttributeList(t.parentNode,e)},s.prototype.getCurrentNode=function(){return this.currentNode},s.prototype.markNodeForDownload=function(t){var e=this.xml.createAttribute("markForDownload");t?(e.value=t.toString(),this.currentNode.setAttributeNode(e)):this.currentNode.removeAttribute("markForDownload")},s.prototype.getAttributeList=function(){return this.attributeList},s);function s(t,e){this.childCollection=[],this.attributeList={},this.setCurrentNode(t),this.setChildCollection(t.childNodes),this.buildAttributeList(t,this.attributeList),this.setParentNode(t.parentNode),this.xml=e,this.id=o.SnowflakeId.getUUID()}e.ManifestNode=r},function(t,e,n){"use strict";var o=n(6),r={downloads:{_GENERAL:{code:o.ERRORS.INTERNAL_ERROR,msg:"Sorry we are unable to process your request - some internal error occurred"},ALREADY_FINISHED:{code:o.ERRORS.FINISHED,msg:"This download '%manifestId%' has been already finished."},ALREADY_REMOVED_ALL_UNFINISHED:{code:o.ERRORS.REMOVED,msg:"All unfinished downloads have been already removed, nothing left."},ALREADY_RESUMED:{code:o.ERRORS.RESUMED,msg:"This download '%manifestId%' has been already resumed."},ALREADY_STOPPED:{code:o.ERRORS.STOPPED,msg:"This download '%manifestId%' has been already stopped or has been already downloaded."},ALREADY_STOPPED_ALL:{code:o.ERRORS.STOPPED,msg:"There are no downloads to be stopped."},ALREADY_STARTED:{code:o.ERRORS.STARTED,msg:"This download '%manifestId%' has been already started."},BROKEN_CANNOT_BE_RESUMED:{code:o.ERRORS.BROKEN,msg:"This download '%manifestId%' is broken and cannot be resumed."},INFO_FAILED:{code:o.ERRORS.INFO,msg:"Gettting info of download '%manifestId%' failed."},REMOVING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all downloads failed."},REMOVING_ALL_UNFINISHED_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all unfinished downloads failed."},REMOVING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of download '%manifestId%' failed."},RESUMING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Resuming of download '%manifestId%' failed."},UPDATE_DOWNLOAD_FOLDER_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Updating of download folder for '%manifestId%' failed."},STOPPING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping of download '%manifestId%' failed."},SAVING_PERSISTENT_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving persistent info for download '%manifestId%' failed."},SAVING_DATA_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving data for download '%manifestId%' failed."},STOPPING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping all downloads failed."},UNFINISHED:{code:o.ERRORS.UNFINISHED,msg:"This download is not ready yet."}},manifests:{NOT_FOUND:{code:o.ERRORS.NOT_FOUND,msg:"Manifest with id='%manifestId%' not found."},LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load manifest from url '%manifestUrl%'."},LIST_LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load list of manifests."},FOLDER_ALREADY_EXISTS:{code:o.ERRORS.EXISTS,msg:"Folder for manifest with id ='%manifestId%' already exists."},INVALID_ID:{code:o.ERRORS.BROKEN,msg:"Provided custom id for manifest is not valid: ('%invalid%')"}}};t.exports=r},function(t,e,n){"use strict";t.exports={test:"Hello world"}},function(t,e,n){"use strict";t.exports={regexpProtocolRemove:/^https{0,1}\:\/\//i}},function(t,e,n){"use strict";var o,r=this&&this.__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},s=n(16),l=n(48),i=(o=s.ManifestNode,r(a,o),a.prototype.parse=function(){for(var t=this.currentNode.getElementsByTagName("Representation"),e=0;e<t.length;e++){var n=new l.RepresentationNode(t[e],this.xml);this.representationColl[e]=n,this.representationColl[0].hasMimeType()&&(this.attributeList.mimeType=this.representationColl[0].getMimeType())}for(var o=this.currentNode.getElementsByTagName("ContentProtection"),r=0;r<o.length;r++){var s=o[r].attributes,i=o[r].getElementsByTagName("cenc:pssh");if(s.getNamedItem("schemeIdUri")&&i.length){var a={schemeIdUri:s.getNamedItem("schemeIdUri").value,cencPSSH:i[0].childNodes[0].data};this.contentProtections.push(a)}}},a.prototype.getContentProtections=function(){return this.contentProtections},a.prototype.getWidevineProtection=function(){return this.contentProtections.filter(function(t){return"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===t.schemeIdUri})},a.prototype.isMimeType=function(t){return-1!=this.attributeList.mimeType.indexOf(t)},a.prototype.isContentType=function(t){return!(!this.attributeList.contentType||-1==this.attributeList.contentType.indexOf(t))},a);function a(t,e){o.call(this,t,e),this.representationColl=[],this.contentProtections=[],this.parse()}e.AdaptationSetNode=i},function(t,e,n){"use strict";var h,o,f=n(49),p=n(22);(o=h=h||{})[o.FROM_TEMPLATE=0]="FROM_TEMPLATE",o[o.FROM_TIMELINE=1]="FROM_TIMELINE",o[o.FROM_SEGMENTLIST=2]="FROM_SEGMENTLIST",o[o.FROM_SEGMENT_BASE=3]="FROM_SEGMENT_BASE";var r=(m.prototype.createFragmentUrlsFromTimeline=function(t){var e=this.segmentTemplate.attributes.getNamedItem("presentationTimeOffset");e=e?parseInt(e.nodeValue,10):0;for(var n=!1,o=0,r=0;r<t.length;r++){0<r&&t[r].attributes.getNamedItem("t")&&void 0!==t[r].attributes.getNamedItem("t").nodeValue?(n=!0,o=parseInt(t[r].attributes.getNamedItem("t").nodeValue)):n=!1;for(var s=t[r].attributes.getNamedItem("d")&&void 0!==t[r].attributes.getNamedItem("d").nodeValue?parseInt(t[r].attributes.getNamedItem("d").nodeValue):0,i=t[r].attributes.getNamedItem("r")&&void 0!==t[r].attributes.getNamedItem("r").nodeValue?parseInt(t[r].attributes.getNamedItem("r").nodeValue):0,a=1;a<=i;a++){var l=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;l=this.replace$RepresentationID$(l,this.representationID),l=this.replace$Time$(l,e),l=this.replace$Bandwidth$(l,this.bandwidth),this.mediaUrls.push(new p.MediaUrl(this.baseUrl,l,this.mimeType)),n?e=o:e+=s}var u=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;u=this.replace$RepresentationID$(u,this.representationID),u=this.replace$Time$(u,e),u=this.replace$Bandwidth$(u,this.bandwidth),this.mediaUrls.push(new p.MediaUrl(this.baseUrl,u,this.mimeType)),n?e=o:e+=s}},m.prototype.createFragmentFromUrlList=function(t){for(var e=0;e<t.length;e++){var n=t[e].attributes.getNamedItem("media").nodeValue;this.mediaUrls.push(new p.MediaUrl(this.baseUrl,n,this.mimeType))}},m.prototype.createFragmentsFromTemplate=function(){for(var t,e=parseInt(this.segmentTemplate.attributes.getNamedItem("duration").nodeValue),n=this.segmentTemplate.attributes.getNamedItem("timescale")?parseInt(this.segmentTemplate.attributes.getNamedItem("timescale").nodeValue):1,o=Math.ceil(this.presentationDuration/(e/n)/1e3),r=this.mediaTemplate.split("$"),s=this.startNumber||0,i=0;i<r.length;i++)-1!=r[i].indexOf("Number")&&(t="$"+r[i]+"$");for(var a=f.ZeroPadding.getPaddingAmount(t),l=s;l<o+s;l++){var u=f.ZeroPadding.addPadding(l,a),d=void 0;d=0===a?this.replace$Number$(this.mediaTemplate,l):this.mediaTemplate.replace(t,u),this.mediaUrls.push(new p.MediaUrl(this.baseUrl,d,this.mimeType))}},m.prototype.replace$RepresentationID$=function(t,e){return t.replace(new RegExp("\\$RepresentationID\\$","g"),e)},m.prototype.replace$Number$=function(t,e){return t.replace(new RegExp("\\$Number\\$","g"),e.toString())},m.prototype.replace$Bandwidth$=function(t,e){return t.replace(new RegExp("\\$Bandwidth\\$","g"),e.toString())},m.prototype.replace$Time$=function(t,e){return t.replace(new RegExp("\\$Time\\$","g"),e.toString())},m.prototype.createInitSegment=function(t){return t=this.replace$Bandwidth$(t,this.bandwidth),t=this.replace$RepresentationID$(t,this.representationID)},m.prototype.getMediaUrlList=function(){return this.mediaUrls},m.count=-1,m);function m(t,e,n,o,r,s,i,a,l,u,d){this.hasSegmentBase=!1,this.baseUrl="",this.presentationDuration=0,this.bandwidth=0,this.startNumber=0,this.mediaUrls=[],this.whichUseCase=-1,this.mimeType="",m.count+=1,this.presentationDuration=t,this.mimeType=r,n&&(this.baseUrl=n),e&&(this.bandwidth=e),o&&(this.representationID=o),s&&(this.segmentBase=s,this.hasSegmentBase=!0,this.whichUseCase=h.FROM_SEGMENT_BASE),i&&(this.segmentTemplate=i,this.mediaTemplate=this.segmentTemplate.attributes.getNamedItem("media").nodeValue,this.mediaTemplate=this.replace$RepresentationID$(this.mediaTemplate,this.representationID),this.mediaTemplate=this.replace$Bandwidth$(this.mediaTemplate,this.bandwidth),this.startNumber=this.segmentTemplate.attributes.getNamedItem("startNumber")?parseInt(this.segmentTemplate.attributes.getNamedItem("startNumber").nodeValue):0,this.whichUseCase=h.FROM_TEMPLATE),a&&(this.segmentTimeline=a),l&&(this.timelineItemList=l,this.whichUseCase=h.FROM_TIMELINE),u&&(this.segmentList=u),d&&(this.segmentUrlList=d,this.whichUseCase=h.FROM_SEGMENTLIST);var f=!1,c="";switch(this.whichUseCase){case h.FROM_SEGMENTLIST:this.createFragmentFromUrlList(this.segmentUrlList),c=this.createInitSegment(this.segmentList.getElementsByTagName("Initialization")[0].attributes.getNamedItem("sourceURL").nodeValue),this.mediaUrls.unshift(new p.MediaUrl(this.baseUrl,c,this.mimeType));break;case h.FROM_SEGMENT_BASE:try{f=-1!==this.baseUrl.indexOf(".")}catch(t){}f&&this.mediaUrls.push(new p.MediaUrl(this.baseUrl,this.baseUrl,this.mimeType));break;case h.FROM_TEMPLATE:this.createFragmentsFromTemplate(),c=this.createInitSegment(this.segmentTemplate.attributes.getNamedItem("initialization").nodeValue),this.mediaUrls.unshift(new p.MediaUrl(this.baseUrl,c,this.mimeType));break;default:try{f=-1!==this.baseUrl.indexOf(".")}catch(t){}f&&this.mediaUrls.push(new p.MediaUrl("",this.baseUrl,this.mimeType))}}e.SegmentInformation=r},function(t,e,n){"use strict";var o=(r.prototype.truncateMediaFilePath=function(t){var e=t.lastIndexOf("/"),n=t.substring(0,e),o=t.substring(e+1,t.length);return this.baseURL+=n,o},r.prototype.getFileAddress=function(){return this.baseURL+this.mediaFile},r);function r(t,e,n,o){void 0===o&&(o=""),this.baseURL="",!1===t.startsWith("http")&&(this.baseURL=t),this.mediaFile=-1!==e.indexOf("/")?this.truncateMediaFilePath(e):e,this.url_domain=o,this.mimeType=n}e.MediaUrl=o},function(t,e,n){"use strict";var o=n(50),r=(s.getDuration=function(t){return o.duration(t).asMilliseconds()},s.getDurationAsS=function(t){return o.duration(t).asSeconds()},s.getMoment=function(){return o},s);function s(){}e.IsoDurationParser=r},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["audioSamplingRate","bandwidth","id","lang","durationInS"],t)}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["bandwidth","id","height","lang","width","durationInS"],t)}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["bandwidth","id","lang","durationInS"],t)}},function(t,e,n){"use strict";var i=n(3),a=n(4),l=n(1);t.exports=function(t,e){var o=a.resolve(l.getSettings().settingsFolder+"/"+t+"/"),r=a.resolve(l.getSettings().downloadsFolderPath+"/"+t+"/");function s(t){return new Promise(function(n){i.stat(t,function(t,e){t?n():e.isDirectory()?n("Folder already exists"):n()})})}return e&&(r=a.resolve(e+"/"+t+"/")),new Promise(function(e,n){Promise.all([s(o),s(r)]).then(function(t){(t=t||[]).filter(function(t){return void 0!==t}).length?n(t):e()},n)})}},function(t,e,n){"use strict";var f=n(3),c=n(4),h=n(7);t.exports=function o(r,e,n){n=n||0;var s=10,i=500;if("string"!=typeof r)throw new Error("directory path required");if(void 0!==e&&"function"!=typeof e)throw new Error("callback must be function");var a,l,u=this;function d(t){if(t&&"ENOTEMPTY"===t.code&&n<s)return n++,console.error("ERROR ENOTEMPTY",r,n),void setTimeout(function(){o(r,e,n)},i);t&&"ENOENT"===t.code&&(arguments[0]=null),l=l||arguments,e&&!a&&(a=!0,e.apply(u,l))}h.checkForLocalFile(r,function(t){if(!t)return d(null);function n(t,e){if(t)return d(t);var n=e.length;if(0===n)return f.rmdir(r,d);e.forEach(function(t){o(c.resolve(r,t),function(t){return t?d(t):0==--n?f.rmdir(r,d):void 0})})}f.stat(r,function(t,e){return t?d(t):e.isDirectory()?void f.readdir(r,n):f.unlink(r,d)})})}},function(t,e){t.exports=i},function(t,e){t.exports=require("util")},function(t,e,n){"use strict";function o(){this._items=[]}o.prototype.clear=function(){this._items=[]},o.prototype.concat=function(t){this._items=this._items.concat(t)},o.prototype.count=function(){return this._items.length},o.prototype.getItems=function(){return this._items},o.prototype.push=function(t){this._items.push(t)},o.prototype.shift=function(){return this._items.shift()},o.prototype.unshift=function(){return this._items.unshift.apply(this,arguments)},t.exports=o},function(t,e,n){"use strict";t.exports=function(t,e){function n(){var t,e,n=[];for(t=0,e=arguments.length;t<e;t++)n.push(arguments[t]);return n.unshift(this._storageKey),this._parent._itemAction.apply(this._parent,n)}for(var o in e.prototype)e.prototype.hasOwnProperty(o)&&(t[o]=n.bind(t,o))}},function(t,e,n){"use strict";function o(){this._items={}}o.prototype.clear=function(){this._items={}},o.prototype.count=function(){return this.getKeys().length},o.prototype.decrease=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]--},o.prototype.getItem=function(t){return this._items[t]},o.prototype.getItems=function(){return this._items},o.prototype.getKeys=function(){return Object.keys(this._items)},o.prototype.increase=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]++},o.prototype.removeItem=function(t){delete this._items[t]},o.prototype.setItem=function(t,e){this._items[t]=e},o.prototype.setItems=function(t){for(var e in t)t.hasOwnProperty(e)&&this.setItem(e,t[e])},t.exports=o},function(t,e,n){"use strict";function o(){for(var t="",e=0,n=arguments.length;e<n;e++)t+=arguments[e].replace(/^\.\//g,"/"),e<n-1&&(t+="/");return t=(t=(t=(t=t.replace(/\/{2,}/g,"/")).replace("https:/","https://")).replace("http:/","http://")).replace("file:/","file://")}t.exports={joinPath:function(){return o.apply(null,arguments)+"/"},joinPathWithFile:function(){return o.apply(null,arguments)}}},function(t,e,n){"use strict";var o=n(29),r=n(4),s=n(1);function i(t,e){if(!t)throw new Error("manifestId is missing");return this._manifestId=t,this._itemName=e,new Promise(this._read.bind(this))}i.prototype._read=function(n){var t=r.resolve(s.getSettings().settingsFolder+"/"+this._manifestId+"/"+this._itemName+".json");o.readFile(t,function(t,e){t?n():n(e)})},t.exports=i},,,function(t,e,n){t.exports=n(39)},function(t,e,s){"use strict";var n,d=s(5),f=s(9),o=s(1),i=s(42),r=s(83),a=s(95),l=s(98),u=s(101),c=s(102);(n=function(){this._offlineContentPort=o.getSettings().offlineContentPortStart,d.bindAll(this,"_onApiRequest","processSubscriber"),this._createControllers(),this._serveOfflineContent(),this._attachEvents()}).prototype.stop=function(){this.server.stop()},n.prototype._apiMethods=function(r,t,s,i){var a=this,l=s[0],u={};u.promiseId=t;(s=s||[]).unshift(i),s.unshift(function(t,e){var n=String(f.SnowflakeId.getUUID()),o=d.clone({errorId:n,methodName:r,args:s.slice(4),err:t,internalError:e});u.manifestId=l,u.status="ERROR",u.error=t||{},u.error.errorId=n,u.error.details=e,a._send(u,i);try{console.error(new Date,"Error occurred",JSON.stringify(o))}catch(t){}}),s.unshift(function(t,e){u.subscribersId=e,u.status="OK",u.result=t,u.manifestId=l,a._send(u,i)}),s.unshift(this);var e=this._getMethod(r);"function"==typeof e?e.apply(null,s):(u.status="ERROR",u.error="Provided method '"+r+"' doesn't exists",this._send(u,i),console.error("ERROR","Provided method '"+r+"' doesn't exists"))},n.prototype._attachEvents=function(){s(2).ipcMain.on("downstreamElectronBE",this._onApiRequest)},n.prototype._createControllers=function(){this.manifestController=new a,this.offlineController=new l(this.manifestController),this.downloadsController=new r(this.manifestController,this.offlineController),this.subscribersController=new u},n.prototype._getMethod=function(t){var e,n,o,r=t.split(".");for(o=i[r[0]],e=1,n=r.length;e<n;e++)o=o[r[e]];return o},n.prototype._onApiRequest=function(t,e,n){var o=e.promiseId,r=e.args||{},s=e.method;n=e.windowId;for(var i=[],a=0;r.hasOwnProperty(a);)i.push(r[a]),a++;this._apiMethods(s,o,i,n)},n.prototype._send=function(t,e){try{for(var n=s(2).BrowserWindow.getAllWindows(),o=0,r=n.length;o<r;o++)if(n[o].id===e){n[o].webContents.send("downstreamElectronFE",t);break}}catch(t){console.error("internal error ocurred",t)}},n.prototype._serveOfflineContent=function(){var e=this,t=o.getSettings().maxOfflineContentPortRange;this.server=new c(this.offlineController,this.downloadsController,t,this._offlineContentPort),this.server.serveOfflineContent(function(t){e._offlineContentPort=t})},n.prototype.getOfflinePath=function(t){var e=o.getSettings().offlineDomain,n=this._offlineContentPort;return n&&(e+=":"+n),e+="/"+encodeURIComponent(o.getSettings().downloadsName)+"/"+encodeURIComponent(t)+"/"},n.prototype.processSubscriber=function(t,e,n,o,r){var s={};s.subscriberId=t,s.status=e?"ERROR":"OK",s.err=e,s.result=n,s.subscriberFinished=r,this._send(s,o),r&&this.subscribersController.removeAllManifestSubscribersById(t)},t.exports={init:function(t){return o.load(t),new n}}},function(t,e){t.exports=a},function(t,e){t.exports=l},function(t,e,n){"use strict";var o={};o.create=n(43),o.createPersistent=n(61),o.getFolderInfo=n(62),o.getList=n(63),o.getListWithInfo=n(64),o.getOfflineLink=n(65),o.info=n(66),o.remove=n(67),o.removeAll=n(68),o.removeAllUnfinished=n(69),o.removePersistent=n(70),o.resume=n(71),o.saveData=n(72),o.savePersistent=n(74),o.start=n(75),o.stop=n(76),o.stopAll=n(77),o.subscribe=n(78),o.unsubscribe=n(80),o.updateDownloadFolder=n(81);var r=n(82);t.exports={downloads:o,removeSubscribers:r}},function(t,e,n){"use strict";var f=n(15).Manifest,c=n(0),h=n(27),p=n(60),m=n(1);t.exports=function(t,e,n,o,r,s,i){var a=!0;if(void 0!==s&&""!==s&&null!==s||(a=!1),a){if(void 0!==s&&"number"!=typeof s&&"string"!=typeof s)return void n(c.getError(c.e.manifests.INVALID_ID,s));var l=m.getSettings().customManifestIdFolderRegex;if(!s.match(l)){var u=p(s,l,m.getSettings().openingTagForInvalidCustomManifestIdCharacter,m.getSettings().closingTagForInvalidCustomManifestIdCharacter);return void n(c.getError(c.e.manifests.INVALID_ID,u))}}var d=new f(s);(i?d.loadWithManifest(r,i):d.load(r)).then(function(){a?h(s).then(function(){t.manifestController.cacheManifest(d),e(d.getJsonInfo())},function(t){n(c.getError(c.e.manifests.FOLDER_ALREADY_EXISTS,s),t)}):(t.manifestController.cacheManifest(d),e(d.getJsonInfo()))},function(t){n(c.getError(c.e.manifests.LOADING_FAILED,r),t)})}},function(t,e,n){"use strict";var i=n(2).net,a=n(1),o=(r.prototype.load=function(t){return this.sendXMLHttpRequest(t)},r.prototype.sendXMLHttpRequest=function(s){var e=Object.assign({url:s,method:"GET"},a.getSettings().defaultManifestRequestOptions);return new Promise(function(o,r){var t=i.request(e);t.chunkedEncoding=a.getSettings().useChunkedEncoding,t.on("error",function(t){r(t)}),t.on("response",function(t){var e;if(t.on("error",function(t){r(new Error("MANIFEST LOAD FAILURE "+t))}),400<=t.statusCode&&(e=t.statusMessage),e)r(new Error("MANIFEST LOAD FAILURE "+e));else{var n=[];t.on("data",function(t){n.push(t)}).on("end",function(){n=Buffer.concat(n),o({response:n,url:s})})}}),t.end()})},r);function r(){}e.ManifestLoader=o},function(t,e,n){"use strict";var r=n(3),s=n(4);t.exports=function(t){return new Promise(function(n,o){r.readFile(s.resolve(t),"utf-8",function(t,e){t?o(t):n(e)})})}},function(t,e,n){"use strict";var o=n(47),r=n(51);o.ManifestXML.prototype.getManifestType=function(t){return 0!==t.getElementsByTagName("SmoothStreamingMedia").length?"MSS":"DASH"},o.ManifestXML.prototype.getAdaptationSetNodeName=function(){return"MSS"===this.manifestType?"StreamIndex":"AdaptationSet"},o.ManifestXML.prototype.getRepresentationNodeName=function(){return"MSS"===this.manifestType?"QualityLevel":"Representation"},o.ManifestXML.prototype.parseStreams=function(){for(var t=this.xml.getElementsByTagName("StreamIndex"),e=0;e<t.length;e++){var n=new r.StreamIndexNode(t[e],this.xml);this.adaptationSetColl[e]=n}},o.ManifestXML.prototype._parseAdaptations=o.ManifestXML.prototype.parseAdaptations,o.ManifestXML.prototype.parseAdaptations=function(){return this.manifestType=this.getManifestType(this.xml),"MSS"===this.manifestType?this.parseStreams():this._parseAdaptations()},e.ManifestXML=o.ManifestXML},function(t,e,n){"use strict";var o=n(20),r=n(10).DOMParser,s=(i.prototype.parse=function(t,e,n){var o;o="function"==typeof e&&"function"==typeof n?new r({errorHandler:{warning:function(){},error:n,fatalError:n}}):new r,this.adaptationSetColl=[],this.xml=o.parseFromString(t,"application/xml"),this.parseAdaptations(),"function"==typeof e&&e()},i.prototype.getAdaptationSetNodeName=function(){return"AdaptationSet"},i.prototype.getRepresentationNodeName=function(){return"Representation"},i.prototype.parseAdaptations=function(){for(var t=this.xml.getElementsByTagName("AdaptationSet"),e=0;e<t.length;e++){var n=new o.AdaptationSetNode(t[e],this.xml);this.adaptationSetColl[e]=n}},i.prototype.getVideoAdaptation=function(){return this.getAdaptations("video")},i.prototype.getAudioAdaptation=function(){return this.getAdaptations("audio")},i.prototype.getTextAdaptation=function(){return this.getAdaptations("text")},i.prototype.getManifestXML=function(){return this.xml},i.prototype.getAdaptations=function(e){return this.adaptationSetColl.map(function(t){return t}).filter(function(t){if(t.isMimeType(e)||t.isContentType(e))return!0})},i.cloneXML=function(t){var e=t.implementation.createDocument(t.namespaceURI,null,null),n=e.importNode(t.documentElement,!0);return e.appendChild(n),e},i.prototype.removeNode=function(){for(var e=this,t=this.xml.documentElement.getElementsByTagName(this.getRepresentationNodeName()),n=this.xml.documentElement.getElementsByTagName(this.getAdaptationSetNodeName()),o=[],r=[],s=0;s<t.length;s++)o[s]=t[s];o.forEach(function(t){t.attributes.getNamedItem("markForDownload")&&"true"==t.attributes.getNamedItem("markForDownload").value||t.parentNode.removeChild(t),t.removeAttribute("markForDownload")},this);for(var i=0;i<n.length;i++)r[i]=n[i];r.forEach(function(t){t.getElementsByTagName(e.getRepresentationNodeName()).length||t.parentNode.removeChild(t)})},i);function i(){}e.ManifestXML=s},function(t,e,n){"use strict";var s,o=this&&this.__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(16),i=n(21),a=n(23),l=(s=r.ManifestNode,o(u,s),u.prototype.createSegmentInformation=function(){var t,e,n,o=a.IsoDurationParser.getDuration(this.attributeList.mediaPresentationDuration),r=this.attributeList.id;if(this.segmentTemplate&&this.segmentTemplate.hasChildNodes())for(var s=0;s<this.segmentTemplate.childNodes.length;s++)"SegmentTimeline"==this.segmentTemplate.childNodes[s].nodeName&&(t=this.segmentTemplate.childNodes[s]);try{e=t.getElementsByTagName("S")}catch(t){}try{n=this.segmentList.getElementsByTagName("SegmentURL")}catch(t){}this.bandwidth=this.attributeList.bandwidth?parseInt(this.attributeList.bandwidth):-1,this.segmentInformation=new i.SegmentInformation(o,this.bandwidth,this.baseURL,r,this.attributeList.mimeType,this.segmentBase,this.segmentTemplate,t,e,this.segmentList,n)},u.prototype.writeAttributesToList=function(t,e){for(var n=t.attributes,o=0;o<t.childNodes.length;o++)this.baseURL||"BaseURL"!=t.childNodes[o].nodeName||(this.baseURL=t.childNodes[o].firstChild.nodeValue),this.segmentBase||"SegmentBase"!=t.childNodes[o].nodeName||(this.segmentBase=t.childNodes[o]),this.segmentTemplate||"SegmentTemplate"!=t.childNodes[o].nodeName||(this.segmentTemplate=t.childNodes[o]),this.segmentList||"SegmentList"!=t.childNodes[o].nodeName||(this.segmentList=t.childNodes[o]);for(var r in n)e[n[r].nodeName]||(e[n[r].nodeName]=n[r].nodeValue);void 0!==e.mediaPresentationDuration&&(e.durationInS=a.IsoDurationParser.getDurationAsS(this.attributeList.mediaPresentationDuration)),null!==t.parentNode?this.buildAttributeList(t.parentNode,e):this.segmentInformation||this.createSegmentInformation(),s.prototype.writeAttributesToList.call(this,t,e)},u.prototype.getMimeType=function(){return this.attributeList.mimeType||this.attributeList.contentType},u.prototype.hasMimeType=function(){return!(!this.attributeList.mimeType&&!this.attributeList.contentType)},u.prototype.getMediaUrlList=function(){return this.segmentInformation.getMediaUrlList()},u.prototype.getRepresentationId=function(){return this.id},u);function u(t,e){s.call(this,t,e),this.markNodeForDownload(!1)}e.RepresentationNode=l},function(t,e,n){"use strict";var o=(r.addPadding=function(t,e){for(var n=t.toString().split("");n.length<e;)n.unshift("0");return n.join("")},r.getPaddingAmount=function(t){var e=t.indexOf("%"),n=t.lastIndexOf("$"),o=parseInt(t.substring(e+1,n-1));return o=isNaN(o)?0:o},r);function r(){}e.ZeroPadding=o},function(t,e){t.exports=u},function(t,e,n){"use strict";var o,s=n(52),r=n(10).DOMParser,i=this&&this.__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},a=n(20),u=n(53),l=(o=a.AdaptationSetNode,i(d,o),d.prototype.parse=function(){for(var t=this.currentNode.getElementsByTagName("QualityLevel"),e=0;e<t.length;e++){var n=new u.QualityLevelNode(t[e],this.xml);this.representationColl[e]=n,this.representationColl[0].hasMimeType()&&(this.attributeList.mimeType=this.representationColl[0].getMimeType()),this.representationColl[0].hasContentType()&&(this.attributeList.mimeType=this.representationColl[0].getContentType())}var o=this.xml.getElementsByTagName("Protection")[0];if(void 0!==o){var r=o.getElementsByTagName("ProtectionHeader")[0],s=r.firstChild.data.replace(/\n|\r/g,""),i=this.getKIDFromProtectionHeader(r),a={schemeIdUri:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",cencPSSH:s};this.contentProtections.push(a);var l={schemeIdUri:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",cencPSSH:this.createWidevinePssh(i)};this.contentProtections.push(l)}},d.prototype.getKIDFromProtectionHeader=function(t){var e,n,o;return e=s.toByteArray(t.firstChild.data),n=this.getWRMHeaderFromPRHeader(e),n=new Uint16Array(n.buffer),n=String.fromCharCode.apply(null,n),o=(new r).parseFromString(n,"application/xml").getElementsByTagName("KID")[0].textContent,o=s.toByteArray(o),this.convertUuidEndianness(o),o},d.prototype.convertUuidEndianness=function(t){this.swapBytes(t,0,3),this.swapBytes(t,1,2),this.swapBytes(t,4,5),this.swapBytes(t,6,7)},d.prototype.swapBytes=function(t,e,n){var o=t[e];t[e]=t[n],t[n]=o},d.prototype.getWRMHeaderFromPRHeader=function(t){var e,n,o,r=0;for(r+=4,r+=2;r<t.length;)if(e=256*t[r+1]+t[r],r+=2,1===e)return n=256*t[r+1]+t[r],r+=2,(o=new Uint8Array(n)).set(t.subarray(r,r+n)),o;return null},d.prototype.createWidevinePssh=function(t){var e=new Uint8Array(2+t.length);e[0]=18,e[1]=16,e.set(t,2);var n=32+e.length,o=new Uint8Array(n),r=0;return o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=n,o.set([112,115,115,104,0,0,0,0],r),r+=8,o.set([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237],r),r+=16,o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=e.length,o.set(e,r),o=s.fromByteArray(o)},d);function d(t,e){o.call(this,t,e)}e.StreamIndexNode=l},function(t,e){t.exports=d},function(t,e,n){"use strict";var i,o=this&&this.__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(16),s=n(23),a=n(54),l=(i=r.ManifestNode,o(u,i),u.prototype.createSegmentInformation=function(){var t=s.IsoDurationParser.getDuration(parseFloat(this.attributeList.Duration/1e7)),e=this.attributeList.id;this.bandwidth=this.attributeList.bandwidth?parseInt(this.attributeList.bandwidth):-1,this.segmentTemplate=this.mapMssSegmentTemplate(),this.segmentInformation=new a.FragmentInformation(t,this.bandwidth,this.baseURL,e,this.attributeList.mimeType,this.segmentTemplate)},u.prototype.mapMssSegmentTemplate=function(){var t,e={};return t=(t=this.attributeList.Url.replace("{bitrate}","$Bandwidth$")).replace("{start time}","$Time$"),e.media=t,e.timescale=1e7,e.SegmentTimeline=this.mapMssSegmentTimeline(),e},u.prototype.mapMssSegmentTimeline=function(){var t,e,n,o,r={},s=this.currentNode.parentNode.getElementsByTagName("c"),i=[],a=0;for(o=0;o<s.length;o++)t={},n=s[o].getAttribute("t"),t.tManifest=parseFloat(n),t.t=parseFloat(n),t.d=parseFloat(s[o].getAttribute("d")),0!==o||t.t||(t.t=0),0<o&&((e=i[i.length-1]).d||(e.tManifest?e.d=parseFloat(n)-parseFloat(e.tManifest):e.d=t.t-e.t),t.t||(e.tManifest?(t.tManifest=parseFloat(e.tManifest)+e.d,t.t=parseFloat(t.tManifest)):t.t=e.t+e.d)),a+=t.d,i.push(t);return r.S=i,r.S_asArray=i,r.duration=a/1e7,r},u.prototype.writeAttributesToList=function(t,e){for(var n=t.attributes,o=0;o<t.childNodes.length;o++)this.baseURL||"BaseURL"!=t.childNodes[o].nodeName||(this.baseURL=t.childNodes[o].firstChild.nodeValue),this.segmentBase||"SegmentBase"!=t.childNodes[o].nodeName||(this.segmentBase=t.childNodes[o]),this.segmentTemplate||"SegmentTemplate"!=t.childNodes[o].nodeName||(this.segmentTemplate=t.childNodes[o]),this.segmentList||"SegmentList"!=t.childNodes[o].nodeName||(this.segmentList=t.childNodes[o]);for(var r in n)e[n[r].nodeName]||(e[n[r].nodeName]=n[r].nodeValue);if(void 0!==e.Type){e.contentType=e.Type,e.mimeType={video:"video/mp4",audio:"audio/mp4",text:"application/mp4"}[e.contentType],e.bandwidth=e.Bitrate,e.width=e.MaxWidth,e.height=e.MaxHeight,e.lang=e.Language||"und";var s=e.Name?e.Name:e.Type;e.id=s+"_"+e.Index,"audio"===e.Type&&(e.audioSamplingRate=e.SamplingRate)}void 0!==e.Duration&&(e.durationInS=this.attributeList.Duration/1e7),null!==t.parentNode?this.buildAttributeList(t.parentNode,e):this.segmentInformation||this.createSegmentInformation(),i.prototype.writeAttributesToList.call(this,t,e)},u.prototype.getMimeType=function(){return this.attributeList.mimeType},u.prototype.hasMimeType=function(){return!!this.attributeList.mimeType},u.prototype.getContentType=function(){return this.attributeList.contentType},u.prototype.hasContentType=function(){return!!this.attributeList.contentType},u);function u(t,e){i.call(this,t,e)}e.QualityLevelNode=l},function(t,e,n){"use strict";var i,o=this&&this.__extends||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(22),s=n(21),a=(i=s.SegmentInformation,o(l,i),l.prototype.createFragmentUrlsFromTimeline=function(t){for(var e=0;e<t.S.length;e++){var n=this.mediaTemplate;n=this.replace$Time$(n,t.S[e].t),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,n,this.mimeType))}},l);function l(t,e,n,o,r,s){i.call(this,t,e,n,o,r),s&&(this.segmentTemplate=s,this.mediaTemplate=this.segmentTemplate.media,this.mediaTemplate=this.replace$Bandwidth$(this.mediaTemplate,this.bandwidth)),this.segmentTemplate.media&&(this.timelineItemList=this.segmentTemplate.SegmentTimeline),this.createFragmentUrlsFromTimeline(this.timelineItemList)}e.FragmentInformation=a},function(t,e,n){"use strict";function o(t,e,n){this.videoAdaptation=t,e&&(this.audioAdaptation=e),n&&(this.textAdaptation=n)}e.AllAdaptationSets=o},function(t,e,n){"use strict";var u=n(24),d=n(25),f=n(26);t.exports=function(t){for(var e=[],n=0,o=t.length;n<o;n++)for(var r=t[n].representationColl,s=0,i=r.length;s<i;s++){var a=r[s].attributeList,l=a.contentType||a.mimeType;switch(l=0<=l.indexOf("video")?"video":0<=l.indexOf("audio")?"audio":"text"){case"audio":e.push(new u(a));break;case"video":e.push(new d(a));break;default:e.push(new f(a))}}return e}},function(t,e,n){"use strict";var u=n(24),d=n(25),f=n(26);t.exports=function(t){for(var e=[],n=0,o=t.length;n<o;n++)for(var r=t[n].representationColl,s=0,i=r.length;s<i;s++){var a=r[s].attributeList,l=a.contentType||a.mimeType;switch(l=0<=l.indexOf("video")?"video":0<=l.indexOf("audio")?"audio":"text"){case"audio":e.push(new u(a));break;case"video":e.push(new d(a));break;default:e.push(new f(a))}e[s].protections=t[n].contentProtections.slice()}return e}},function(t,e){t.exports=f},function(t,e,n){"use strict";t.exports={isUTF16:function(t){var e,n,o,r,s=0,i=t&&t.length,a=null;if(i<2){if(255<t[0])return!1}else{if(e=t[0],n=t[1],255===e&&254===n)return!0;if(254===e&&255===n)return!0;for(;s<i;s++){if(0===t[s]){a=s;break}if(255<t[s])return!1}if(null===a)return!1;if(void 0!==(o=t[a+1])&&0<o&&o<128)return!0;if(void 0!==(r=t[a-1])&&0<r&&r<128)return!0}return!1}}},function(t,e,n){"use strict";t.exports=function(t,e,n,o){for(var r,s,i,a=String(t),l=!0,u=1;l;){a.substr(0,u).match(e)?u++:(s=u,i=void 0,i=(r=a).substr(0,s-1),r.length>s&&(i+=r.substr(s,r.length)),a=i),u>a.length&&(l=!1)}for(var d=a.split(""),f=0,c=t.length;f<c;f++)(f>=d.length||t[f]!==d[f])&&d.splice(f,0,n+t[f]+o);return d.join("")}},function(t,e,n){"use strict";t.exports=function(t,e){e()}},function(t,e,n){"use strict";var s=n(0);t.exports=function(t,n,o,e,r){t.offlineController.getManifestFolderInfo(r,function(t,e){t?o(s.getError(s.e.manifests.INFO_FAILED,r),t):n(e)})}},function(t,e,n){"use strict";var r=n(0);t.exports=function(t,n,o){t.offlineController.getManifestsList(function(t,e){t?o(r.getError(r.e.manifests.LIST_LOADING_FAILED),t):n(e)})}},function(t,e,n){"use strict";var s=n(0);t.exports=function(t,n,o,e,r){t.offlineController.getManifestsListWithInfo(function(t,e){t?o(s.getError(s.e.manifests.LIST_LOADING_FAILED),t):n(e)},r)}},function(t,e,n){"use strict";var i=n(0);t.exports=function(n,o,r,t,s){n.offlineController.getManifestInfo(s,function(t,e){t?r(i.getError(i.e.downloads._GENERAL),t):o({offlineLink:n.getOfflinePath(s)+e.manifest.name,persistent:e.persistent})})}},function(t,e,n){"use strict";var i=n(0);t.exports=function(t,n,o,e,r,s){t.offlineController.getManifestInfo(r,function(t,e){t?o(i.getError(i.e.manifests.INFO_FAILED,r),t):n(e)},s)}},function(t,e,n){"use strict";var i=n(0);t.exports=function(n,o,r,t,s){n.offlineController.getManifestInfo(s,function(t,e){n.downloadsController.removePromise(s).then(function(){n.offlineController.removePromise(s).then(function(){n.subscribersController.unsubscribe(s),n.manifestController.removeFromCache(s),o(e)},function(t){r(i.getError(i.e.downloads.REMOVING_FAILED,s),t)})},function(t){r(i.getError(i.e.downloads.REMOVING_FAILED,s),t)})})}},function(t,e,n){"use strict";var u=n(0);t.exports=function(i,a,l){i.offlineController.getManifestsListWithInfo(function(t,e){if(t)l(u.getError(u.e.downloads.REMOVING_ALL_FAILED),t);else{for(var n=e.map(function(t){return t.manifestInfo.id}),o=[],r=0,s=n.length;r<s;r++)o.push(i.downloadsController.removePromise(n[r]));Promise.all(o).then(function(){i.offlineController.removeAllPromise().then(function(){i.subscribersController.unsubscribeAll(),i.manifestController.removeFromCacheAll(),a(e)},function(t){l(u.getError(u.e.downloads.REMOVING_ALL_FAILED),t)})},function(t){l(u.getError(u.e.downloads.REMOVING_ALL_FAILED),t)})}})}},function(t,e,n){"use strict";var f=n(0),c=n(8);t.exports=function(l,u,d){l.offlineController.getManifestsListWithInfo(function(t,e){if(t)d(f.getError(f.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t);else{var n=[],o=[];if(!e.length)return void d(f.getError(f.e.downloads.ALREADY_REMOVED_ALL_UNFINISHED));for(var r=0,s=e.length;r<s;r++){var i=e[r].status,a=e[r].manifestInfo.id;i!==c.FINISHED&&(o.push(a),n.push(l.downloadsController.removePromise(a)))}Promise.all(n).then(function(){for(var t=[],e=0,n=o.length;e<n;e++)t.push(l.offlineController.removePromise(o[e]));Promise.all(t).then(function(){l.subscribersController.unsubscribe(o),l.manifestController.removeFromCache(o),u(o)},function(t){d(f.getError(f.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})},function(t){d(f.getError(f.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})}})}},function(t,e,n){"use strict";var i=n(1),a=n(0),l=n(28);t.exports=function(t,o,r,e,s){t.offlineController.getManifestInfo(s,function(t,e){if(t)r(a.getError(a.e.manifests.NOT_FOUND,s),t);else{var n=i.getSettings().settingsFolder+s+"/"+i.getSettings().stores.PERSISTENT+".json";l(n,function(t){t&&"ENOENT"!==t.code?r(a.getError(a.e.downloads.REMOVING_PERSISTENT_FAILED,s),t):o(e)})}})}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r,s){t.downloadsController.resume(r,s,e,n)}},function(t,e,n){"use strict";var i=n(1),a=n(0),l=n(12);t.exports=function(t,e,n,o,r,s){t.offlineController.getManifestInfo(r,function(t){t?n(a.getError(a.e.manifests.NOT_FOUND,r),t):new l(r,i.getSettings().stores.DATA,s).save().then(function(){e()},function(t){n(a.getError(a.e.downloads.SAVING_DATA_FAILED,r),t)})})}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["id","contentType","bandwidth","remoteUrl","stats","localUrl"],t)}},function(t,e,n){"use strict";var i=n(1),a=n(0),l=n(12);t.exports=function(t,e,n,o,r,s){t.offlineController.getManifestInfo(r,function(t){t?n(a.getError(a.e.manifests.NOT_FOUND,r),t):new l(r,i.getSettings().stores.PERSISTENT,s).save().then(function(){e()},function(t){n(a.getError(a.e.downloads.SAVING_PERSISTENT_FAILED,r),t)})})}},function(t,e,n){"use strict";var l=n(0),u=n(27);t.exports=function(n,e,o,t,r,s,i){function a(){n.downloadsController.storage.getItem(r).then(function(t){t?o(l.getError(l.e.downloads.ALREADY_STARTED,r)):n.downloadsController.start(r,s,i,e,function(t){o(l.getError(l.e.downloads._GENERAL),t)})},function(t){o(l.getError(l.e.downloads._GENERAL),t)})}n.manifestController.getManifestById(r)?u(r,i).then(function(){a()},function(t){var e=(t=t||[])[1];t.length&&e?o(l.getError(l.e.manifests.FOLDER_ALREADY_EXISTS,r)):n.offlineController.getManifestDataFile(r,function(t){t?o(l.getError(l.e.manifests.FOLDER_ALREADY_EXISTS,r)):a()})}):o(l.getError(l.e.manifests.NOT_FOUND,r))}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.downloadsController.stop(r,e,n)}},function(t,e,n){"use strict";var f=n(0),c=n(8);t.exports=function(l,u,d){l.offlineController.getManifestsListWithInfo(function(t,e){if(t)d(f.getError(f.e.downloads.STOPPING_ALL_FAILED),t);else{for(var n=[],o=[],r=0,s=e.length;r<s;r++){var i=e[r].status,a=e[r].manifestInfo.id;i!==c.FINISHED&&(o.push(a),n.push(l.downloadsController.stopPromise(a,!0)))}0<o.length?Promise.all(n).then(function(){u(o)},function(t){d(f.getError(f.e.downloads.STOPPING_ALL_FAILED),t)}):d(f.getError(f.e.downloads.ALREADY_STOPPED_ALL))}})}},function(t,e,n){"use strict";var d=n(0),f=n(79);t.exports=function(t,e,n,o,r,s){"string"==typeof r?function(t,e,n,o,r,s){var i,a,l,u=t.manifestController.getManifestById(r);u?(l=[],i=new f(function(){return t.downloadsController.downloadStats.getStats(r)},t.processSubscriber,o,r,s),l.push(t.subscribersController.addSubscriber(i)),(a=new f(function(){return t.downloadsController.isDownloadFinishedAndSynced(r)},t.processSubscriber,o,r,s,!0)).onFinish(function(n){i.remove(),t.offlineController.getManifestInfo(r,function(t,e){n(t,e)})}),l.push(t.subscribersController.addSubscriber(a)),e(u.getJsonInfo(),l)):n(d.getError(d.e.manifests.NOT_FOUND,r))}(t,e,n,o,r,s):function(r,t,e,n,s,o){var i,a,l,u=s.sort().join(",");l=[],i=new f(function(){return r.downloadsController.downloadStats.getStats(s)},r.processSubscriber,n,u,o),l.push(r.subscribersController.addSubscriber(i)),(a=new f(function(){for(var t=!0,e=0,n=s.length;e<n;e++)t=t&&r.downloadsController.isDownloadFinishedAndSynced(s[e]);return t},r.processSubscriber,n,u,o,!0)).onFinish(function(e){i.remove();for(var t=[],n=0,o=s.length;n<o;n++)t.push(r.offlineController.getManifestInfoPromise(s[n]));Promise.all(t).then(function(t){e(null,t)},function(t){e(t)})}),l.push(r.subscribersController.addSubscriber(a)),t(null,l)}(t,e,0,o,r,s)}},function(t,e,n){"use strict";var i=n(9),a=n(5);function o(t,e,n,o,r,s){this._process=t,this._callback=e,this._manifestId=o,this._id=String(i.SnowflakeId.getUUID()),this._onceOnly=s,this._target=n,this.onInterval=function(){var t=this._process(),n=this;t&&(this._onceOnly?(this.remove(),"function"==typeof this._callbackOnFinish?this._callbackOnFinish(function(t,e){n._callback(n._id,t,e,n._target,!0)}):this._callback(this._id,null,t,n._target)):this._callback(this._id,null,t,n._target))},a.bindAll(this,"onInterval"),this._intervalTimer=setInterval(this.onInterval,r)}o.prototype.getId=function(){return this._id},o.prototype.getManifestId=function(){return this._manifestId},o.prototype.onFinish=function(t){this._callbackOnFinish=t},o.prototype.remove=function(){clearInterval(this._intervalTimer)},t.exports=o},function(t,e,n){"use strict";var s=n(0);t.exports=function(t,e,n,o,r){"string"==typeof r?function(t,e,n,o,r){t.manifestController.getManifestById(r)?(t.subscribersController.unsubscribe(r),e()):n(s.getError(s.e.manifests.NOT_FOUND,r))}(t,e,n,0,r):(t.subscribersController.unsubscribe(r),t.subscribersController.unsubscribe(r.sort().join(",")))}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r,s){t.downloadsController.updateDownloadFolder(r,s,e,n)}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.subscribersController.removeSubscribersById(r),e()}},function(t,e,n){"use strict";var L=n(5),o=n(13),M=n(1),P=n(0),i=n(84),r=n(89),F=n(93),s=n(94),C=n(8),a=n(6),x=n(19),U=n(34),u=n(4),l=n(35),d=n(12),f=n(7);function c(t,e){this._manifestsDownloadOrder=[],this._manifestsDownloadOrderObj={},this._manifestController=t,this._offlineController=e,this.storage=new r,this._offlineController.setDownloadStorage(this.storage),this._names={downloadInProgress:"downloadInProgress",options:"options",maxDownloadInProgress:"maxDownloadInProgress"},this._STATS_TIME_GENERATION=1e3,this.downloadStats=new s(this.storage),L.bindAll(this,"_onDownloadEnd","_onDownloadError","isDownloadFinished")}c.prototype._addDownloads=function(t,e,n,o){var r=!0;for(this._prepareStartOptions(t,e,n,o);r;){var s=e.length?Math.round(n.length/e.length):1,i=e.length?Math.round(o.length/e.length):1;this._addNextItemToQueue(t,o,i),this._addNextItemToQueue(t,n,s),this._addNextItemToQueue(t,e),r=!!(o.length||e.length||n.length)}},c.prototype._addNextItemToQueue=function(t,e,n){var o;if(n=n||1,e.length)for(;0<n;)(o=e.shift()).manifestId=t,this.storage.left.push(t,o),n--},c.prototype._downloadOrderAddManifest=function(t,e){return!this._downloadOrderManifestExists(t)&&(this._manifestsDownloadOrderObj[t]=!0,e?this._manifestsDownloadOrder.unshift(t):this._manifestsDownloadOrder.push(t),!0)},c.prototype._downloadOrderGetManifestId=function(t){return this._manifestsDownloadOrder[t]},c.prototype._indexOfManifest=function(t){return this._manifestsDownloadOrder.indexOf(t)},c.prototype._downloadOrderManifestExists=function(t){return this._manifestsDownloadOrderObj[t]},c.prototype._downloadOrderRemoveManifest=function(t){var e,n,o=!1;for(delete this._manifestsDownloadOrderObj[t],e=0,n=this._manifestsDownloadOrder.length;e<n;e++)if(this._manifestsDownloadOrder[e]===t){this._manifestsDownloadOrder.splice(e,1),o=!0;break}return o},c.prototype._finish=function(t,e,n){this.downloadStats.refresh(),this._downloadOrderRemoveManifest(t),this._manifestsDownloadOrder.length||this.downloadStats.stop(),this.storage.removeItem(t).then(e,n)},c.prototype._getDownloadHash=function(t){return t.remoteUrl+"-"+t.localUrl},c.prototype._markDownloadItem=function(t){var e,n=this,o=t.manifestId,r=n._getDownloadHash(t),s=[];t.events.removeListener("end",n._onDownloadEnd),t.events.removeListener("error",n._onDownloadError),1===n.storage.downloading.count(o)&&0===n.storage.left.count(o)&&(this.downloadStats.refresh(),e=!0),t.status===C.FINISHED?(n.storage.downloaded.push(o,t),s.push(this.storage.stores.DOWNLOADS.DOWNLOADED)):n.storage.errors.push(o,t),n.storage.downloading.removeItem(o,r),n.isDownloadFinished(o)&&(0===n.storage.errors.count(o)?n.storage.status.setItem(o,"status",C.FINISHED):n.storage.status.setItem(o,"status",C.ERROR),s.push(this.storage.stores.STATUS)),n.storage.sync(o,s).then(function(){n.storage.params.decrease(o,n._names.downloadInProgress),e?n._finish(o,function(){n.startQueue(),console.info("FINISHED",o)},function(){n.startQueue()}):n.startQueue()},function(t){console.error("ERROR",t)})},c.prototype._stopWithStatus=function(i,a,l,u,d){var f=this;f._downloadOrderRemoveManifest(i),f.storage.getItem(i).then(function(t){if(t){var e,n=f.storage.downloading.getKeys(i);console.info("STOPPING",i,n.length);for(var o=[],r=0,s=n.length;r<s;r++)(e=f.storage.downloading.getItem(i,n[r])).events.removeListener("end",f._onDownloadEnd),e.events.removeListener("error",f._onDownloadError),o.push(e.stopPromise());f.storage.status.setItem(i,"status",u),d&&f.storage.status.setItem(i,"details",d),o.push(f.storage.sync(i,[f.storage.stores.DOWNLOADS.DOWNLOADED,f.storage.stores.STATUS])),Promise.all(o).then(function(){f._finish(i,a,l)},function(t){l(P.getError(P.e.downloads.STOPPING_FAILED,i),t)})}else l(P.getError(P.e.downloads.ALREADY_STOPPED,i))},function(t){l(P.getError(P.e.downloads.STOPPING_FAILED,i),t)})},c.prototype._onDownloadError=function(t,e){console.error("ERROR",t.remoteUrl,e),this._markDownloadItem(t),e!==f.errors.NO_SPACE_LEFT_ERROR&&!M.getSettings().stopOnError||this._stopWithStatus(t.manifestId,function(){console.info("stopped")},function(t){console.info(t)},C.ERROR,e)},c.prototype._onDownloadEnd=function(t){this._markDownloadItem(t)},c.prototype._prepareStartOptions=function(t,e,n,o){var r=e.length+n.length+o.length;console.info("ADDING ->>> ",t+",",r,"fragments");var s,i={};this.storage.params.setItem(t,this._names.downloadInProgress,0);for(var a=M.getSettings().downloadingThreadsRules,l=0,u=a.items.length;l<u;l++)if(r<=a.items[l].max){i[a.threadName]=a.items[l].threads,s=a.items[l].files;break}this.storage.params.setItem(t,this._names.options,i),this.storage.params.setItem(t,this._names.maxDownloadInProgress,s),this._downloadOrderAddManifest(t)},c.prototype.isDownloadFinished=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)},c.prototype.isDownloadFinishedAndSynced=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)&&!this.storage.keyExists(t)},c.prototype.getDownloading=function(t,e){var n=this.storage.downloading.getItems(t);if(!n)return null;for(var o in n)if(n.hasOwnProperty(o)){var r=n[o];if(u.normalize(r.localUrl)===u.normalize(e))return r}return null},c.prototype.waitForDownload=function(t,n){function o(t){t.events.removeListener("end",e),t.events.removeListener("error",r)}var e,r;e=function(t){o(t),n()},r=function(t,e){o(t),n(e)},t.events.on("end",e),t.events.on("error",r)},c.prototype.performSeek=function(t,e,n){var o,r=this;if(o=r.getDownloading(t,e))r.waitForDownload(o,n);else{var s=r.storage.left.getItems(t);if(s){var i=s.findIndex(function(t){return u.normalize(t.localUrl)===u.normalize(e)});if(-1<i){var a=s.slice(0,i),l=s.slice(i);r.storage.left.clear(t),r.storage.left.concat(t,l),r.storage.left.concat(t,a),s=r.storage.left.getItems(t),r.startQueue(r._indexOfManifest(t),!0),(o=r.getDownloading(t,e))?r.waitForDownload(o,n):n("No download found")}else n("No download found")}else n("No download found")}},c.prototype.start=function(p,t,e,m,g,_,v){var E=this;this.downloadStats.start();var R=this._manifestController.getManifestById(p);if(R){var y=(t=t||{}).video||[];Array.isArray(y)||(y=[y]);var I=t.audio||[];Array.isArray(I)||(I=[I]);var w=t.text||[];Array.isArray(w)||(w=[w]);var S=R.getVideoRepresentations(),T=R.getAudioRepresentations(),N=R.getTextRepresentations(),O=u.resolve(M.getSettings().downloadsFolderPath);e&&(O=u.resolve(e));var D=u.resolve(O+"/"+p+"/"),b=R.getManifestUrl(),A=R.getManifestName();Promise.all([this._offlineController.getManifestInfoPromise(p,!0),this.storage.getItem(p),o(D)]).then(function(t){var e=t[0];if(!t[1]||E.isDownloadFinished(p)){e.manifest.video&&(y=L.union(y,e.manifest.video)),e.manifest.audio&&(I=L.union(I,e.manifest.audio)),e.manifest.text&&(w=L.union(w,e.manifest.text));for(var n=e.downloadedFiles||[],o={},r=0,s=n.length;r<s;r++)o[n[r].localUrl]=n[r];var i=function(t,e){var n,o=t.getElementsByTagName("MPD")[0];if(o)for(var r=0,s=o.childNodes.length;r<s;r++)if("BaseURL"===o.childNodes[r].nodeName){(n=o.childNodes[r].textContent).match(x.regexpProtocolRemove)||(n=U.joinPath(e,n));break}return n=n||e}(R.manifestXML.xml,R.url_domain),a=F.getDownloadLinks(p,D,i,y,S,o),l=F.getDownloadLinks(p,D,i,I,T,o),u=F.getDownloadLinks(p,D,i,w,N,o),d=F.getAllLinks(p,D,i,y,S),f=F.getAllLinks(p,D,i,I,T),c=F.getAllLinks(p,D,i,w,N),h=d.concat(f,c);E.storage.createIfNotExists(p).then(function(){E.storage.manifest.setItem(p,"ts",(new Date).getTime()),E.storage.manifest.setItem(p,"url",b),E.storage.manifest.setItem(p,"name",A),E.storage.manifest.setItem(p,"video",y),E.storage.manifest.setItem(p,"audio",I),E.storage.manifest.setItem(p,"text",w),E.storage.manifest.setItem(p,"files",h),E.storage.manifest.setItem(p,"folder",O),E.storage.downloaded.clear(p),E.storage.downloaded.concat(p,n),E.storage.errors.clear(p),_?E.storage.status.setItem(p,"status",v):E.storage.status.setItem(p,"status",C.CREATED),Promise.all([E.storage.sync(p,[E.storage.stores.MANIFEST,E.storage.stores.STATUS]),E._manifestController.saveOriginalManifestOnceOnly(p),E._manifestController.saveManifestWithChosenRepresentations(p,{video:y,audio:I,text:w},D)]).then(function(){E._addDownloads(p,a,l,u),E._indexOfManifest(p)>M.getSettings().numberOfManifestsInParallel-1?E.storage.status.setItem(p,"status",C.QUEUED):E.storage.status.setItem(p,"status",C.STARTED),E.storage.status.setItem(p,"left",E.storage.left.count(p)),E.storage.sync(p,[E.storage.stores.DOWNLOADS.DOWNLOADED,E.storage.stores.STATUS]).then(function(){E.downloadStats.refresh(),E.isDownloadFinished(p)?(E.storage.status.setItem(p,"status",C.FINISHED),E.storage.sync(p,E.storage.stores.STATUS).then(function(){E._finish(p,m,g)},g)):(E.downloadStats.start(),E.startQueue(),m())},g)},g)},g)}else g(_?P.getError(P.e.downloads.ALREADY_RESUMED,p):P.getError(P.e.downloads.ALREADY_STARTED,p))})}else g(P.getError(P.e.manifests.NOT_FOUND,p))},c.prototype.resume=function(o,r,s,i){var a=this;this._offlineController.getManifestInfo(o,function(t,e){if(t)i(P.getError(P.e.downloads.RESUMING_FAILED,o),t);else{var n=e.manifest.folder;n=n||u.resolve(M.getSettings().downloadsFolderPath),a.start(o,r,n,s,i,!0,e.status)}})},c.prototype.updateDownloadFolder=function(n,o,r,s){Promise.all([new l(n,M.getSettings().stores.MANIFEST)]).then(function(t){var e=t[0];e?(e.folder=o,new d(n,M.getSettings().stores.MANIFEST,e).save().then(function(){r()},function(t){s(P.getError(P.e.downloads.SAVING_DATA_FAILED,n),t)})):s(P.getError(P.e.manifests.NOT_FOUND,n))},function(t){s(P.getError(P.e.downloads.UPDATE_DOWNLOAD_FOLDER_FAILED,n),t)})},c.prototype.stop=function(t,e,n){this._stopWithStatus(t,e,n,C.STOPPED)},c.prototype.stopPromise=function(t,o){var r=this;return new Promise(function(e,n){r.stop(t,e,function(t){if(t){if(o&&t.code===a.ERRORS.STOPPED)return void e();n(t)}else e()})})},c.prototype.removePromise=function(o){var r=this;return new Promise(function(e,n){r.stopPromise(o).then(function(){r.storage.removeItem(o).then(e,n)},function(t){t&&t.code===a.ERRORS.STOPPED?r.storage.removeItem(o).then(e,n):n(t)})})},c.prototype._addLinkToDownload=function(t,e){var n=this,o=Object.assign({},e),r=new i(o,n.storage.params.getItem(t,n._names.options)),s=n._getDownloadHash(e);return n.storage.downloading.setItem(t,s,r),n.storage.status.setItem(t,"left",n.storage.left.count(t)+n.storage.errors.count(t)),n.storage.sync(t,n.storage.stores.STATUS),r.events.on("end",n._onDownloadEnd),r.events.on("error",n._onDownloadError),r.start(),r},c.prototype.startQueue=function(t,e){var n,o,r;if(void 0===t&&(t=0),!(r=this._downloadOrderGetManifestId(t))||!this.isDownloadFinished(r))if(t>=M.getSettings().numberOfManifestsInParallel)r&&this.storage.status.setItem(r,"status",C.QUEUED);else if(this.storage.status.setItem(r,"status",C.STARTED),r)this.storage.params.getItem(r,this._names.downloadInProgress)<this.storage.params.getItem(r,this._names.maxDownloadInProgress)-1||e?((o=this.storage.left.shift(r))?(this.storage.params.increase(r,this._names.downloadInProgress),this._addLinkToDownload(r,o)):t++,this.startQueue(t)):1<M.getSettings().numberOfManifestsInParallel&&t<M.getSettings().numberOfManifestsInParallel&&(t++,this.startQueue(t));else{var s,i,a;for(s=n=0,i=(a=this.storage.getKeys()).length;s<i;s++)n+=this.storage.params.count(a[s],this._names.downloadInProgress);0===n&&this.downloadStats.stop()}},t.exports=c},function(t,e,n){"use strict";var o=n(5),r=n(85),s=n(86),i=n(87),a=n(13),l=n(1),u=n(14).EventEmitter,d=n(8);function f(t,e){this._defaults={},this._defaults.threads=l.getSettings().downloadingThreadsRules.threads,this.status=d.CREATED,Object.assign(this,t),this._options=Object.assign(this._defaults,e),this._options.maxDownloadRetry=l.getSettings().MAX_ERRORS_DOWNLOAD_RETRY,this._options.maxDownloadChunkRetry=l.getSettings().MAX_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.maxDownloadChunkInternetRetry=l.getSettings().MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.timeout=l.getSettings().times.DOWNLOAD_TIMEOUT,this._options.retryTimeout=l.getSettings().times.RETRY_TIMEOUT,this._options.useChunkedEncoding=l.getSettings().useChunkedEncoding,this._options.useHeadRequests=l.getSettings().useHeadRequests,this._options.noCache=l.getSettings().noCache,this.stats={available:0,downloaded:0,file_size:0,writeProgress:0},o.bindAll(this,"_onError","_onEnd","_onData","_updateStats","_attachEvents","_removeEvents","_removeEventsOnStop"),this.events=new u}f.prototype._attachEvents=function(){this._dl.on("error",this._onError),this._dl.on("end",this._onEnd),this._dl.on("data",this._onData)},f.prototype._createLocalPath=function(e){var t=this.localUrl.split("/");t=(t=t.slice(0,t.length-1)).join("/"),a(t).then(function(){e()},function(t){e(t)})},f.prototype._onData=function(){this._updateStats()},f.prototype._onEnd=function(){this.status=d.FINISHED,this._updateStats(),this._removeEvents(),this.events.emit("end",this)},f.prototype._onError=function(t){var e=this;this.status=d.ERROR;var n=(t=t||{}).message||"";e._removeEvents(),e._updateStats(),e.events.listeners("error").length&&e.events.emit("error",e,n)},f.prototype._onDomainError=function(t){var e=this,n=(t=t||{}).message||"";e._dl?"net::ERR_NETWORK_CHANGED"===n?e.stop(function(){e.start()}):e.stop(function(){e._onError(t)}):e._onError(t)},f.prototype._removeEvents=function(){"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd),this._dl.removeListener("data",this._onData))},f.prototype._removeEventsOnStop=function(){this._dl&&"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd))},f.prototype._updateStats=function(){this.status===d.FINISHED?(this.stats.available=this._dl.file_size,this.stats.writeProgress=1):(this.stats.available=this._dl.available,this.stats.writeProgress=this._dl.writeProgress),this.stats.downloaded=this._dl.downloaded,this.stats.file_size=this._dl.file_size},f.prototype.start=function(){var o=this;this.status=d.STARTED,this._createLocalPath(function(t){if(t)o._onError(t);else{var n=r.create();n.on("error",function(t){var e="";t&&(e=t.code||t.message||""),"function"==typeof n.dispose&&n.dispose(),o._onDomainError({message:e})}),n.run(function(){o._dl=o.createDownloader(o.remoteUrl,o.localUrl,o._options),o._attachEvents(),o._dl.start()})}})},f.prototype.createDownloader=function(t,e,n){return this._options.useHeadRequests?new i(t,e,n):new s(t,e,n)},f.prototype.stop=function(t){var e=this;if(this.status=d.STOPPED,this._removeEventsOnStop(),"function"!=typeof t&&(t=function(){}),this._dl){var n=r.create();n.on("error",function(){t()}),n.run(function(){e._dl.on("error",function(){t()}),e._dl.on("end",function(){t()}),e._dl.stop()})}else t()},f.prototype.stopPromise=function(){var e=this;return new Promise(function(t){e.stop(function(){t()})})},t.exports=f},function(t,e){t.exports=require("domain")},function(t,e,n){var o=n(3),r=n(2).net,s=n(14).EventEmitter,i=n(30),a=n(7);function l(t,e,n){this._url=t,this._destFile=e,this._options=n,this._resetValues()}i.inherits(l,s),l.prototype._reset=function(t){var e=this;t=t||function(){},e._closeStreamAndRequest(function(){e._resetValues(),t()})},l.prototype._resetValues=function(){this.available=0,this.downloaded=0,this.file_size=0,this.writeProgress=0},l.prototype._createFileStream=function(t){var n=this;if(this.fileStream)t();else{var e=this._destFile;n.fileStream=o.createWriteStream(e,{flags:"w"}),n.fileStream.on("error",t),n.fileStream.on("open",function(){(n.fileStream=this).removeListener("error",t),this.on("error",function(e){"ENOSPC"===e.code?n.emit("error",{message:a.errors.NO_SPACE_LEFT_ERROR,data:e}):n._retry(a.errors.FILE_WRITING_ERROR,function(t){t||n.emit("error",{message:a.errors.FILE_WRITING_ERROR,data:e})})}),this.on("finish",function(){n.isDownloaded()?(n.writeProgress=1,n.emit("end")):n._retry(a.errors.CHUNK_SIZE_ERROR,function(t){t||n._closeStreamAndRequest(function(){n.emit("error",{message:a.errors.CHUNK_SIZE_ERROR})})})}),t()})}},l.prototype.isDownloaded=function(){return this.downloaded===this.file_size},l.prototype._retry=function(t,e){var n,o=this;this._errors=this._errors||{},this._errors[t]=this._errors[t]||0,this._errors[t]++,n=t===a.errors.INTERNET?this._options.maxDownloadChunkInternetRetry:this._options.maxDownloadRetry,this._errors[t]<=n?(o._timer&&clearTimeout(o._timer),e(!0),o._timer=setTimeout(function(){o._reset(function(){o.start()})},o._options.retryTimeout)):e(!1)},l.prototype._closeStreamAndRequest=function(t){var e,n=this;function o(){clearTimeout(e),n.fileStream&&(n.fileStream.destroy(),delete n.fileStream),delete n._req,t()}this._req&&this._req.removeAllListeners(),this.fileStream&&this.fileStream.removeAllListeners(),this._req&&(this._req.abort(),this._req.timeoutTimer&&(clearTimeout(this._req.timeoutTimer),this._req.timeoutTimer=null)),this.fileStream?(e=setTimeout(function(){o()},300),this.fileStream.end(),this.fileStream.close(o)):(delete this._req,t())},l.prototype.start=function(){var n=this,e={timeout:this._options.timeout,url:this._url};return this._options.noCache&&(e.headers={"Cache-Control":"no-cache"}),n._createFileStream(function(t){t?n._retry(a.errors.FILE_CREATING_ERROR,function(t){t||n._closeStreamAndRequest(function(){n.emit("error",{message:a.errors.FILE_CREATING_ERROR})})}):(e.headers=e.headers||{},n._req=r.request(e),n._req.on("response",function(e){e.on("error",function(e){console.error("ERROR ("+n._url+") :"+e),"ESOCKETTIMEDOUT"===e.code||"ENOTFOUND"===e.code||"ETIMEDOUT"===e.code?n._retry(a.errors.INTERNET,function(t){t||n._closeStreamAndRequest(function(){n.emit("error",{message:a.errors.TIMEOUT,data:e})})}):n._retry(a.errors.INTERNET,function(t){t||n._closeStreamAndRequest(function(){n.emit("error",{message:a.errors.CHUNK_ERROR,data:e})})})}),e&&400<=e.statusCode?n._retry(a.errors.INTERNET,function(t){t||n._closeStreamAndRequest(function(){console.error("HTTP DOWNLOAD ERROR url: ".concat(n._url,", statusCode: ").concat(e.statusCode)),n.emit("error",{message:a.errors.CHUNK_ERROR,data:e})})}):(n._headers=e.headers,n.file_size=Number(n._headers["content-length"]),e.on("data",function(t){200!==e.statusCode&&206!==e.statusCode||(n.available+=t.length,n.downloaded+=t.length)}),e.pipe(n.fileStream))}),n._req.end())}),this._promise},l.prototype.stop=function(){var t=this;this._reset(function(){t.emit("error",{message:a.errors.ABORTED})})},t.exports=l},function(t,e,n){var f=n(3),o=n(2).net,r=n(14).EventEmitter,s=n(30),i=n(7),a=n(88);function l(t,e,n){this._url=t,this._destFile=e,this._options=n,this._resetValues()}s.inherits(l,r),l.prototype._calculateChunksNumber=function(t){for(var e=0,n=this._options.threads.length;e<n;e++)if(t<1048576*this._options.threads[e].size)return this._options.threads[e].number;return 1},l.prototype._concatChunks=function(){var i=this,a=500;function l(){i.writeProgress=i._chunks.reduce(function(t,e){return t+e.writeProgress},0)/i._chunksNumber,i.emit("data")}function u(){return f.createWriteStream(i._chunks[0].destFile,{flags:"a"})}function d(t,e){i._chunks[e].writeProgress=t.bytesWritten/i._chunks[e].available,1<i._chunks[e].writeProgress&&(i._chunks[e].writeProgress=1),l()}(i._chunks[0].writeProgress=1)<i._chunks.length?function e(n,o){var t=i._chunks[o];if(t){var r=setInterval(function(){d(n,o)},a),s=f.createReadStream(t.destFile);s.pipe(n),n.on("close",function(){clearInterval(r),d(n,o),n.removeAllListeners(),s.unpipe(n),s.destroy(),f.unlink(t.destFile,function(t){t?i.emit("error",t):(n.destroy(),e(u(),o+1))})})}else l(),n.removeAllListeners(),n.destroy(),f.rename(i._chunks[0].destFile,i._destFile,function(t){t?i.emit("error",t):i.emit("end")})}(u(),1):(l(),i.emit("end"))},l.prototype._initChunk=function(t){var e={};e.bytesRangeNotAvailable=this._bytesRangeNotAvailable,e.destFile=this._destFile,e.maxDownloadRetry=this._options.maxDownloadChunkRetry,e.maxDownloadInternetRetry=this._options.maxDownloadChunkInternetRetry,e.timeout=this._options.timeout,e.retryTimeout=this._options.retryTimeout,e.useChunkedEncoding=this._options.useChunkedEncoding;var n=this.file_size;if(1<this._chunksNumber){var o=parseInt(n/this._chunksNumber,10);e.startPosition=t*o,e.multiChunks=!0,t===this._chunksNumber-1?e.endPosition=n-1:e.endPosition=e.startPosition+o-1}else e.startPosition=0,e.endPosition=n-1;var r=new a(this._url,e);r.events.on("download",this._onChunkDownload.bind(this)),this._chunks.push(r)},l.prototype._onDownloadFailure=function(t,e){if(this._promises=null,e){for(var n=!1,o=0,r=t.length;o<r;o++)if(t[o]&&t[o]===i.errors.NO_SPACE_LEFT_ERROR){n=!0;break}n&&(t={message:i.errors.NO_SPACE_LEFT_ERROR}),this.emit("error",t)}else this._errors=this._errors||0,this._errors++,this._errors<=this._options.maxDownloadRetry?this._retryDownload():this.emit("error",t)},l.prototype._onDownloadSuccess=function(t){var e,n;this._promises=null;for(var o=0,r=(t=t||[]).length;o<r;o++)t[o]&&(t[o]!==i.errors.ABORTED&&t[o]!==i.errors.NO_SPACE_LEFT_ERROR||(e=!0),n=!0);n?this._onDownloadFailure(t,e):this._concatChunks()},l.prototype._onChunkDownload=function(t){this.downloaded+=t,this.available=this._chunks.reduce(function(t,e){return t+e.available},0),this.emit("data")},l.prototype._retryDownload=function(){this._resetValues(),this.start()},l.prototype._resetValues=function(){this.available=0,this.downloaded=0,this.progress=0,this.file_size=0,this.writeProgress=0,this._chunks=[]},l.prototype._startChunks=function(){for(var t=[],e=0,n=this._chunks.length;e<n;e++)t.push(this._chunks[e].start());this._promises=t,Promise.all(this._promises).then(this._onDownloadSuccess.bind(this),this._onDownloadFailure.bind(this))},l.prototype._startAllChunks=function(){for(var t=0,e=this._chunksNumber;t<e;t++)this._initChunk(t);this._startChunks()},l.prototype.start=function(){var n=this,t=Object.assign({url:this._url,method:"HEAD"},i.defaultOptions);this._options.noCache&&(t.headers=t.headers||{},t.headers["Cache-Control"]="no-cache");var e=o.request(t);e.chunkedEncoding=this._options.useChunkedEncoding,e.on("response",function(t){if(t&&400<=t.statusCode){var e=t.statusMessage;if(e)return void n._onDownloadFailure(e,!1)}t.on("error",function(t){t&&n._onDownloadFailure(t,!1)}),n._headers=t.headers,n.file_size=Number(n._headers["content-length"]),n._chunksNumber=n._calculateChunksNumber(n.file_size),i.checkForLocalFile(n._destFile,function(t,e){t?e===n.file_size?n.emit("end"):(e>n.file_size?f.unlink(n._destFile,function(t){if(t)throw t}):e<n.file_size&&1<n._chunksNumber&&f.unlink(n._destFile,function(t){if(t)throw t}),n._startAllChunks()):n._startAllChunks()})}),e.end()},l.prototype.stop=function(){for(var t=[],e=0,n=this._chunks.length;e<n;e++)this._chunks[e].stop(),this._chunks[e]._promise&&t.push(this._chunks[e]._promise);function o(){this.emit("end","")}this._promises||Promise.all(t).then(o.bind(this),o.bind(this))},t.exports=l},function(t,e,n){var s=n(7),i=n(3),o=n(2).net,r=n(14).EventEmitter;function a(t,e){var n=this;return this.url=t,this.options=e,this.endPosition=e.endPosition,this.startPosition=e.startPosition,this.bytesRangeNotAvailable=e.bytesRangeNotAvailable,this.reset(),this.events=new r,this._promise=new Promise(function(t,e){n.resolve=t,n.reject=e}),this}a.prototype._retry=function(t,e){var n,o=this;this._errors=this._errors||{},this._errors[t]=this._errors[t]||0,this._errors[t]++,n=t===s.errors.INTERNET?this.options.maxDownloadInternetRetry:this.options.maxDownloadRetry,this._errors[t]<=n?(o._timer&&clearTimeout(o._timer),e(!0),o._timer=setTimeout(function(){o.reset(function(){o.start()})},o.options.retryTimeout)):e(!1)},a.prototype.createFileStream=function(n){var o=this;if(this.fileStream)n();else{var r=this.options.destFile;this.options.multiChunks&&(r=r+"."+this.startPosition+"."+this.endPosition),s.checkForLocalFile(r,function(t,e){o.destFile=r,t&&e<=o.endPosition-o.startPosition&&(o.resumeFile=t,o.available=e,o.offsetStartPosition=e),o.fileStream=i.createWriteStream(r,{flags:o.resumeFile?"a":"w"}),o.fileStream.on("error",n),o.fileStream.on("open",function(){(o.fileStream=this).removeListener("error",n),this.on("error",function(e){"ENOSPC"===e.code?o.resolve(s.errors.NO_SPACE_LEFT_ERROR,e):o._retry(s.errors.FILE_WRITING_ERROR,function(t){t||o.resolve(s.errors.FILE_WRITING_ERROR,e)})}),this.on("finish",function(){o.isDownloaded()?o.closeStreamAndRequest(o.resolve):o._retry(s.errors.CHUNK_SIZE_ERROR,function(t){t||o.closeStreamAndRequest(function(){o.resolve(s.errors.CHUNK_SIZE_ERROR)})})}),n()})})}},a.prototype.isDownloaded=function(){return this.endPosition-this.startPosition-this.offsetStartPosition+1===this.downloaded},a.prototype.start=function(){var n=this,t={timeout:this.options.timeout,url:this.url};return n.createFileStream(function(e){e?n._retry(s.errors.FILE_CREATING_ERROR,function(t){t||n.closeStreamAndRequest(function(){n.resolve(s.errors.FILE_CREATING_ERROR,e)})}):(t.headers=t.headers||{},n.bytesRangeNotAvailable||(t.headers.range="bytes="+(n.startPosition+n.offsetStartPosition)+"-"+n.endPosition),n._req=o.request(t),n._req.chunkedEncoding=n.options.useChunkedEncoding,n._req.on("response",function(e){e.on("error",function(e){"ESOCKETTIMEDOUT"===e.code||"ENOTFOUND"===e.code||"ETIMEDOUT"===e.code?n._retry(s.errors.INTERNET,function(t){t||n.closeStreamAndRequest(function(){n.resolve(s.errors.TIMEOUT,e)})}):n.closeStreamAndRequest(function(){n.resolve(s.errors.CHUNK_ERROR)})}),e.on("data",function(t){200!==e.statusCode&&206!==e.statusCode||(n.available+=t.length,n.downloaded+=t.length,n.events.emit("download",t.length))}),e.pipe(n.fileStream)}),n._req.end())}),this._promise},a.prototype.closeStreamAndRequest=function(t){var e,n=this;function o(){clearTimeout(e),n.fileStream&&(n.fileStream.destroy(),delete n.fileStream),delete n._req,t()}this._req&&this._req.removeAllListeners(),this.fileStream&&this.fileStream.removeAllListeners(),this._req&&(this._req.abort(),this._req.timeoutTimer&&(clearTimeout(this._req.timeoutTimer),this._req.timeoutTimer=null)),this.fileStream?(e=setTimeout(function(){o()},300),this.fileStream.end(),this.fileStream.close(o)):(delete this._req,t())},a.prototype.reset=function(t){var e=this;t=t||function(){},e.closeStreamAndRequest(function(){e.offsetStartPosition=0,e.available=0,e.downloaded=0,e.writeProgress=0,e.resumeFile=!1,t()})},a.prototype.stop=function(){var t=this;this.reset(function(){t.resolve(s.errors.ABORTED)})},t.exports=a},function(t,e,n){"use strict";var o=n(5),s=n(1),r=n(31),i=n(90),p=n(12),a=n(33),l=n(91),u=n(92);function d(){this.stores=s.getSettings().stores,this._items={},this._syncItems=[],this._FLUSH_TIME=50,this._flushThrottled=o.throttle(this._flush,this._FLUSH_TIME,{leading:!1}),this._createDummyStorageBridge()}d.prototype._createArrayStorage=function(t,e){this[e]||this._createArrayStorageBridge(e),this._items[t][e]=new r},d.prototype._createArrayStorageBridge=function(t){this[t]=new i(this,t)},d.prototype._createDummyStorageBridge=function(){this._createArrayStorageBridge(this.stores.DOWNLOADS.LEFT),this._createArrayStorageBridge(this.stores.DOWNLOADS.DOWNLOADED),this._createStorageBridge(this.stores.DOWNLOADS.DOWNLOADING),this._createArrayStorageBridge(this.stores.DOWNLOADS.ERRORS),this._createStorageBridge(this.stores.PARAMS),this._createStorageBridge(this.stores.MANIFEST),this._createStorageBridge(this.stores.STATUS)},d.prototype._createStorage=function(t,e){this[e]||this._createStorageBridge(e),this._items[t][e]=new a},d.prototype._createStorageBridge=function(t){this[t]=new l(this,t)},d.prototype._flush=function(){var t,e,n,o,r,s,i,a,l,u,d,f,c=this,h=this._syncItems.splice(0,this._syncItems.length);for(u={},n=0,r=h.length;n<r;n++)for(u[(o=h[n]).manifestId]=u[o.manifestId]||{},s=0,i=o.storageKeys.length;s<i;s++)u[o.manifestId][o.storageKeys[s]]=!0;for(a in e=[],u)for(l in u[a])try{t=new p(a,l,(d=a,f=l,c._items[d]&&c._items[d][f]?c._items[d][f].getItems():[])),e.push(t.save())}catch(t){console.error("ERROR",l)}Promise.all(e).then(function(){var t,e;for(t=0,e=h.length;t<e;t++)h[t].resolve()},function(){var t,e;for(t=0,e=h.length;t<e;t++)h[t].reject()})},d.prototype._getAllStorageKeys=function(t){var e=[];for(var n in t=t||this.stores)t.hasOwnProperty(n)&&("string"==typeof t[n]?n!==this.stores.PARAMS&&e.push(t[n]):e=e.concat(this._getAllStorageKeys(t[n])));return e},d.prototype._itemAction=function(t,e,n){var o,r,s=[];for(o=3,r=arguments.length;o<r;o++)s.push(arguments[o]);return this._items[n]&&this._items[n][t]&&this._items[n][t][e]?this._items[n][t][e].apply(this._items[n][t],s):void(this._items[n]&&console.error("ERROR",n,t,e,s))},d.prototype.clear=function(s,i){var a=this;return new Promise(function(t,e){if(i=i||a._getAllStorageKeys(),a._items[s])for(var n=0,o=i.length;n<o;n++){var r=a._items[s][i[n]];r&&r.clear()}delete a._items[s],a.sync(s,i).then(t,e)})},d.prototype.create=function(n){var o=this;return new Promise(function(t,e){o._items[n]={},o._createArrayStorage(n,o.stores.DOWNLOADS.LEFT),o._createArrayStorage(n,o.stores.DOWNLOADS.DOWNLOADED),o._createStorage(n,o.stores.DOWNLOADS.DOWNLOADING),o._createArrayStorage(n,o.stores.DOWNLOADS.ERRORS),o._createStorage(n,o.stores.PARAMS),o._createStorage(n,o.stores.MANIFEST),o._createStorage(n,o.stores.STATUS),o.sync(n,[o.stores.DOWNLOADS.DOWNLOADED,o.stores.MANIFEST,o.stores.STATUS]).then(t,e)})},d.prototype.createIfNotExists=function(o){var r=this;return new Promise(function(e,n){r.getItem(o).then(function(t){t?e():r.create(o).then(e,n)},n)})},d.prototype.getItem=function(e){var n=this;return new Promise(function(t){t(n._items[e])})},d.prototype.getKeys=function(){return Object.keys(this._items)},d.prototype.keyExists=function(t){return!!this._items[t]},d.prototype.removeItem=function(e){var n=this;return new Promise(function(t){delete n._items[e],t()})},d.prototype.sync=function(n,o){var r=this;return new Promise(function(t,e){void 0!==o?("string"==typeof o&&(o=[o]),s.getSettings().saveToDisk?(r._syncItems.push(new u(t,e,n,o)),r._flushThrottled()):t()):e("Storage key is missing")})},d.prototype.syncAll=function(o){var r=this;return new Promise(function(t,e){if(s.getSettings().saveToDisk){var n=r._getAllStorageKeys();r._syncItems.push(new u(t,e,o,n)),r._flushThrottled()}else t()})},t.exports=d},function(t,e,n){"use strict";var o=n(31),r=n(32);t.exports=function(t,e){this._parent=t,this._storageKey=e,r(this,o)}},function(t,e,n){"use strict";var o=n(33),r=n(32);t.exports=function(t,e){this._parent=t,this._storageKey=e,r(this,o)}},function(t,e,n){"use strict";t.exports=function(t,e,n,o){this.resolve=t,this.reject=e,this.manifestId=n,this.storageKeys=o}},function(t,e,n){"use strict";var y=n(19),I=n(34),w={getAllLinks:function(t,e,n,o,r){return w.getDownloadLinks(t,e,n,o,r)},getDownloadLinks:function(t,e,n,o,r,s){var i,a,l,u,d,f,c,h,p,m,g,_,v,E,R=w.getChosenRepresentations(o,r);for(p=[],s=s||{},u=0,f=R.length;u<f;u++)for(a=R[u].attributeList.mimeType,i=+R[u].attributeList.bandwidth,a=0===a.indexOf("video")?"video":0===a.indexOf("audio")?"audio":"text",_=(E=R[u].segmentInformation).mediaUrls,d=E.representationID,c=0,h=_.length;c<h;c++)(m=_[c].mediaFile)!==(g=(g=(g=_[c].baseURL).replace(/\.\.\//g,"")).replace(/\.\./g,""))&&n!==g||(g=""),s[l=g.match(y.regexpProtocolRemove)?(v=I.joinPathWithFile(g,m),I.joinPathWithFile(e,g.replace(y.regexpProtocolRemove,""),m)):(v=I.joinPathWithFile(n,g,m),I.joinPathWithFile(e,g,m))]&&(s[l]||s[l].remoteUrl===v)||(p[c]||(p[c]=[]),p[c].push({id:d,bandwidth:i,contentType:a,remoteUrl:v,localUrl:l}));return p.reduce(function(t,e){return t.concat(e)},[])},getChosenRepresentations:function(t,e){var n=[],o={};e=e||[];for(var r=0,s=(t=t||[]).length;r<s;r++)o[String(t[r])]=!0;for(var i=0,a=e.length;i<a;i++)for(var l=e[i].representationColl,u=0,d=l.length;u<d;u++){var f=l[u];o[String(f.attributeList.id)]&&n.push(f)}return n}};t.exports=w},function(t,e,n){"use strict";var H=n(5);function o(t){this._storage=t,this._stats={},this._statsPrevious={},this._STATS_TIME_GENERATION=1e3,H.bindAll(this,"_generate")}o.prototype._convertToBytes=function(t,e,n,o){return n=void 0!==n?n:e,o=void 0!==o?o:e,t<1e5?this._convertToKB(t,e):t<1073741824?this._convertToMB(t,n):this._convertToGB(t,o)},o.prototype._convertToKB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1024)/n+"kB"},o.prototype._convertToMB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1048576)/n+"MB"},o.prototype._convertToGB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1073741824)/n+"GB"},o.prototype._clearSpeed=function(){for(var t=Object.keys(this._stats)||[],e=0,n=t.length;e<n;e++){var o=t[e];!this._storage.keyExists(o)&&this._stats[o]&&this._stats[o].speed&&(this._stats[o].speed=0,this._stats[o].speedBytes=this._convertToBytes(this._stats[o].speed,3,2))}},o.prototype._generate=function(t){var e={},n=this._storage.getKeys();function o(t){for(var e=0,n=0,o=t.length;n<o;n++){e+=t[n].bandwidth||1}return e}function r(t,e){var n=0;for(var o in t)if(t.hasOwnProperty(o)){var r=t[o];n+=(e?r.stats.available/(r.stats.file_size||1):1)*(r.bandwidth||1)}return n}function s(t){var e=[];for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];e.push(o)}return e}this._clearSpeed();var i={downloading:0,downloaded:0,available:0,left:0,downloadingAvailableBytes:0,downloading_file_size:0,downloadingBytes:0,downloadedBytes:0,availableBytes:0,writeProgress:0,writeProgressDownloading:0,writeProgressDownloaded:0,errors:0,progress:0,speed:0,status:""},a=(new Date).getTime();this._statsTime||(this._statsTime=a);for(var l=0,u=n.length;l<u;l++){var d=n[l];e[d]=H.clone(i),e[d].left=this._storage.left.count(d),e[d].leftI=this._storage.left.getItems(d),e[d].errors=this._storage.errors.count(d),e[d].errorsI=this._storage.errors.getItems(d);var f=this._storage.downloading.getKeys(d);e[d].downloading=f.length,e[d].downloadingI=this._storage.downloading.getItems(d);for(var c=f.length,h=0,p=f.length;h<p;h++){var m=this._storage.downloading.getItem(d,f[h]);e[d].downloadingBytes+=m.stats.downloaded,e[d].downloading_file_size+=m.stats.file_size,e[d].downloadingAvailableBytes+=m.stats.available,e[d].writeProgressDownloading+=m.stats.writeProgress}f=this._storage.downloaded.getItems(d),e[d].downloaded=f.length;for(var g=(e[d].downloadedI=f).length,_=0,v=f.length;_<v;_++){var E=f[_];e[d].downloadedBytes+=E.stats.downloaded,e[d].writeProgressDownloaded+=E.stats.writeProgress}e[d].writeProgressDownloading=e[d].writeProgressDownloading*(e[d].downloadingAvailableBytes/(e[d].downloadedBytes+e[d].downloading_file_size)||1),e[d].writeProgressDownloading=e[d].writeProgressDownloading/(c||1),e[d].writeProgressDownloaded=e[d].writeProgressDownloaded*(e[d].downloadedBytes/(e[d].downloadedBytes+e[d].downloading_file_size)||1),e[d].writeProgressDownloaded=e[d].writeProgressDownloaded/(g||1),e[d].writeProgress=e[d].writeProgressDownloading+e[d].writeProgressDownloaded;var R=this._getDiff("downloadingBytes",d,e,this._statsPrevious);R=1e3*(R+=this._getDiff("downloadedBytes",d,e,this._statsPrevious))/(a-this._statsTime||1),e[d].speed=R,e[d].status=this._storage.status.getItem(d,"status"),e[d].details=this._storage.status.getItem(d,"details");var y=o(e[d].leftI),I=o(e[d].downloadedI),w=r(e[d].downloadingI),S=r(e[d].downloadingI,!0),T=y+I+w+r(e[d].errorsI);e[d].progress=(I+S)/(T||1),e[d].progress=.9*e[d].progress,e[d].progress+=.1*e[d].writeProgress,e[d].downloadedBytesTotal=Math.round(1e4*e[d].progress)/100,e[d].downloadedBytesTotal+="%";var N=function(t,e){return t[e.id]||(t[e.id]=[]),t[e.id].push(e),t},O=e[d].downloadedI.reduce(N,{}),D=s(e[d].downloadingI).reduce(N,{}),b=e[d].leftI.reduce(N,{}),A=s(e[d].errorsI).reduce(N,{}),L=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]||(t[n]=[]),t[n]=t[n].concat(e[n]));return t},M={};L(M,O),L(M,D),L(M,b),L(M,A);var P={},F=void 0;for(F in M)M.hasOwnProperty(F)&&(P[F]=r(O[F])/(r(M[F])||1));var C={};for(F in P)P.hasOwnProperty(F)&&(C[F]=Math.round(1e4*P[F])/100+"%");e[d].progressById=P,e[d].progressByIdPercent=C}for(var x={},U=0,k=n.length;U<k;U++){var B=n[U];x[B]={};var q=e[B].downloadedBytes+e[B].downloadingAvailableBytes;x[B].progress=e[B].progress,x[B].progressPercentage=e[B].downloadedBytesTotal,x[B].progressById=e[B].progressById,x[B].progressByIdPercent=e[B].progressByIdPercent,x[B].downloadedBytesTotal=this._convertToBytes(q,1,2,2),x[B].downloaded=e[B].downloaded,x[B].left=e[B].left,x[B].errors=e[B].errors,e[B].speed<0&&(e[B].speed=0),x[B].speed=e[B].speed,x[B].speedBytes=this._convertToBytes(e[B].speed,3,2),x[B].status=e[B].status,x[B].details=e[B].details}for(var W in x)x.hasOwnProperty(W)&&(this._stats[W]=x[W]);if(!t)for(var G in this._statsTime=a,e)e.hasOwnProperty(G)&&(this._statsPrevious[G]=e[G])},o.prototype._getDiff=function(t,e,n,o){return(n[e]&&n[e][t]||0)-(o[e]&&o[e][t]||0)},o.prototype.getStats=function(t){var e;if(this._stats)if("string"==typeof t)e=this._stats[t];else{e=[];for(var n=0,o=t.length;n<o;n++){var r=this._stats[t[n]];r&&e.push(r)}}return e},o.prototype.refresh=function(){this._generate(!0)},o.prototype.start=function(){this._interval||(this._interval=setInterval(this._generate,this._STATS_TIME_GENERATION),this._generate())},o.prototype.stop=function(){clearInterval(this._interval),this._interval=null,this._generate(),this._statsPrevious={}},t.exports=o},function(t,e,n){"use strict";var a=n(10).XMLSerializer,o=n(1),l=n(96),u=n(7),d=n(97),f=n(0);function r(){this._manifests={}}r.prototype.cacheManifest=function(t){this._manifests[t.id]=t},r.prototype.getManifests=function(t){var e;if(void 0===t)e=this._manifests;else if("number"==typeof t||"string"==typeof t)e=[this._manifests[String(t)]];else{e=[];for(var n=0,o=t.length;n<o;n++)this._manifests[t[n]]&&e.push(this._manifests[t[n]])}return e},r.prototype.getManifestById=function(t){if("number"==typeof t||"string"==typeof t)return this._manifests[String(t)]},r.prototype.getManifestsInfo=function(t){for(var e=[],n=this.getManifests(t),o=0,r=n.length;o<r;o++)e.push(n[o].getJsonInfo());return e},r.prototype.getOriginalManifestLocalPath=function(t){return o.getSettings().settingsFolder+t+"/"},r.prototype.getManifestInfoById=function(t){var e=this.getManifestById(t);if(e)return e.getJsonInfo()},r.prototype.removeFromCache=function(t){"number"!=typeof t&&"string"!=typeof t||(t=[String(t)]);for(var e=0,n=(t=t||[]).length;e<n;e++)delete this._manifests[t[e]]},r.prototype.removeFromCacheAll=function(){this._manifests=[]},r.prototype.saveOriginalManifestOnceOnly=function(t){var i=this.getOriginalManifestLocalPath(t),e=this;return new Promise(function(o,r){var s=e.getManifestById(t);s?u.checkForLocalFile(i+s.getManifestName(),function(t){if(t)o();else{var e,n=new a;try{e=n.serializeToString(s.getManifestXML())}catch(t){return void r(t)}d(i,s.getManifestName(),e,function(t){t?r(t):o()})}}):r(f.getError(f.e.manifests.NOT_FOUND,t))})},r.prototype.saveManifestWithChosenRepresentations=function(r,s,t){var i=t,a=this;return new Promise(function(e,n){var t=a.getManifestById(r);if(t){var o;try{o=l(t,s)}catch(t){return void n(t)}d(i,t.getManifestName(),o,function(t){t?n(t):e()})}else n(f.getError(f.e.manifests.NOT_FOUND,r))})},t.exports=r},function(t,e,n){"use strict";var v=n(19),E=n(15).Manifest,R=n(10).XMLSerializer;t.exports=function(t,e){var n=t.id,o=new R,r=t.getManifestUrl(),s=o.serializeToString(t.getManifestXML());(t=new E(n)).loadFromStr(s,r);for(var i=e.video,a=e.audio,l=e.text,u={video:{}},d=0,f=i.length;d<f;d++)u.video[i[d]]=!0;u.audio={};for(var c=0,h=a.length;c<h;c++)u.audio[a[c]]=!0;u.text={};for(var p=0,m=l.length;p<m;p++)u.text[l[p]]=!0;function g(t){for(var e=0,n=t.length;e<n;e++)for(var o=0,r=t[e].representationColl.length;o<r;o++){var s=t[e].representationColl[o].attributeList.id,i=-1!==(a=t[e].representationColl[o].attributeList.mimeType).indexOf("video")?"video":-1!==a.indexOf("audio")?"audio":"text";u[i][s]&&t[e].representationColl[o].markNodeForDownload(!0)}var a}function _(t){for(var e=0,n=t.length;e<n;e++){var o=t[e].currentNode.getElementsByTagName("BaseURL")[0];o&&o.textContent.match(v.regexpProtocolRemove)&&(o.textContent=o.textContent.replace(v.regexpProtocolRemove,""))}}return g(t.getVideoRepresentations()),g(t.getAudioRepresentations()),g(t.getTextRepresentations()),_(t.getVideoRepresentations()),_(t.getAudioRepresentations()),_(t.getTextRepresentations()),t.removeNode(),o.serializeToString(t.getManifestXML())}},function(t,e,n){"use strict";var s=n(13),i=n(3),a=n(4);t.exports=function(n,o,t,r){s(n).then(function(t){var e=a.resolve(n+"/"+o);i.writeFile(e,t,"utf-8",r)},function(t){r(t)})}},function(t,e,n){"use strict";var f=n(4),i=n(99),u=n(28),c=n(1),o=n(35),s=n(100),h=n(15).Manifest,p=n(8);function r(t){this._manifestController=t}r.prototype.getManifestsList=function(r){s(c.getSettings().settingsFolder,!0,!1).then(function(t){for(var e=[],n=0,o=t.length;n<o;n++)e.push(t[n]);r(null,e)},function(t){r(t)})},r.prototype.getManifestsListWithInfo=function(s,i){var a=this;this.getManifestsList(function(t,e){if(t)s(t);else{for(var n=[],o=0,r=e.length;o<r;o++)n.push(a.getManifestInfoPromise(e[o],i));Promise.all(n).then(function(t){for(var e=[],n=0,o=t.length;n<o;n++)t[n]&&e.push(t[n]);s(null,e)},function(t){s(t)})}})},r.prototype.getManifestInfo=function(a,l,u){var d=this;Promise.all([new o(a,c.getSettings().stores.MANIFEST),new o(a,c.getSettings().stores.DOWNLOADS.DOWNLOADED),new o(a,c.getSettings().stores.STATUS),new o(a,c.getSettings().stores.PERSISTENT),new o(a,c.getSettings().stores.DATA)]).then(function(t){var e={},n=t[0]||{},o=t[1]||[],r=t[2]||{},s=t[3]||"",i=t[4]||"";e.status=r.status||p.BROKEN,e.details=r.details||void 0,d.downloadStorage.keyExists(a)||e.status!==p.STARTED||(e.status=p.BROKEN),e.manifest=n,e.manifest.files&&(e.manifest.totalFiles=e.manifest.files.length,!1===u&&delete e.manifest.files),e.left=r.left||0,e.persistent=s,e.downloaded=o.length,u&&(e.downloadedFiles=o),e.data=i,function(t){var e=t.manifest.name,n=t.manifest.url,o=f.resolve(c.getSettings().settingsFolder+"/"+a+"/"+e),r=d._manifestController.getManifestById(a);r?(t.manifestInfo=r.getJsonInfo(),l(null,t)):(r=new h(a)).loadFromLocal(o,n).then(function(){d._manifestController.cacheManifest(r),t.manifestInfo=r.getJsonInfo(),l(null,t)},function(t){t&&"ENOENT"===t.code?l():l(t)})}(e)},l)},r.prototype.getManifestFolderInfo=function(r,s){Promise.all([new o(r,c.getSettings().stores.MANIFEST)]).then(function(t){var n={},e=(t[0]||{}).folder;e=e||c.getSettings().downloadsFolderPath;var o=f.join(e,r);n.folder=o,i(o,function(t,e){n.size=t?0:e,s(null,n)})},s)},r.prototype.getManifestInfoPromise=function(t,e){var r=this;return new Promise(function(n,o){r.getManifestInfo(t,function(t,e){t?o(t):n(e)},e)})},r.prototype.getManifestDataFile=function(t,e){new o(t,c.getSettings().stores.MANIFEST).then(function(t){e(t)},function(){e()})},r.prototype.remove=function(n,o,r){var s=c.getSettings().settingsFolder+n;this.getManifestDataFile(n,function(t){if(t){var e=t.folder;e=e||f.resolve(c.getSettings().downloadsFolderPath),u(e+"/"+n,function(t){t&&"ENOENT"!==t.code?r(t):u(s,function(t){t&&"ENOENT"!==t.code?r(t):o()})})}else u(s,function(t){t&&"ENOENT"!==t.code?r(t):o()})})},r.prototype.removePromise=function(n){var o=this;return new Promise(function(t,e){o.remove(n,t,e)})},r.prototype.removeAllPromise=function(){var l=this;return new Promise(function(s,i){var a=c.getSettings().settingsFolder;l.getManifestsList(function(t,e){if(t)i(t);else{for(var n=[],o=0,r=e.length;o<r;o++)n.push(l.removePromise(e[o]));Promise.all(n).then(function(){u(a,function(t){t&&"ENOENT"!==t.code?i(t):s()})},function(t){i(t)})}})})},r.prototype.restoreLocalManifest=function(o,r,s){var i=this;this.getManifestInfo(o,function(t,e){var n={};n.video=e.manifest.video,n.audio=e.manifest.audio,n.text=e.manifest.text,i._manifestController.saveManifestWithChosenRepresentations(o,n).then(r,s)})},r.prototype.setDownloadStorage=function(t){this.downloadStorage=t},t.exports=r},function(t,e){t.exports=c},function(t,e,n){"use strict";var d=n(3),o=n(4);function f(t,r,s,i){var e=o.resolve(t+"/"+r);return new Promise(function(n,o){d.stat(e,function(t,e){t?o(t):(e.isDirectory()?s||(r=void 0):i||(r=void 0),n(r))})})}t.exports=function(a,l,u){return void 0===l&&(l=!0),void 0===u&&(u=!0),new Promise(function(s,i){d.readdir(a,function(t,e){if(t)"ENOENT"===t.code||"ENOTDIR"===t.code?s([]):i(t.message);else{for(var n=[],o=0,r=e.length;o<r;o++)n.push(f(a,e[o],l,u));Promise.all(n).then(function(t){s(t.filter(function(t){return void 0!==t}))},function(t){i(t)})}})})}},function(t,e,n){"use strict";function o(){this._subscribers={}}o.prototype.addSubscriber=function(t){var e=t.getId();return this._subscribers[e]=t,e},o.prototype.removeSubscribersById=function(t){"string"==typeof t&&(t=[t]);for(var e=0,n=t.length;e<n;e++)this._subscribers[t[e]]&&(this._subscribers[t[e]].remove(),delete this._subscribers[t[e]])},o.prototype.removeAllManifestSubscribersById=function(t){var e=t&&this._subscribers[t];e&&this.unsubscribe(e.getManifestId())},o.prototype.unsubscribe=function(t){var e=[],n={};"string"==typeof t&&(t=[t]);for(var o=0,r=(t=t||[]).length;o<r;o++)n[t[o]]=!0;for(var s in this._subscribers)this._subscribers.hasOwnProperty(s)&&n[this._subscribers[s].getManifestId()]&&e.push(s);this.removeSubscribersById(e)},o.prototype.unsubscribeAll=function(){for(var t in this._subscribers)this._subscribers.hasOwnProperty(t)&&this._subscribers[t].remove();this._subscribers={}},t.exports=o},function(n,t,o){"use strict";(function(r){var t=o(103),s=o(4),i=o(3),a=o(105).fork,h=o(1),l=o(2).app,u="startServer.js";function e(t,e,n,o){this._offlineController=t,this._downloadController=e,this._maxOfflineContentPortRange=n,this._offlineContentPort=o,this.childProcess=void 0}e.prototype._startServer=function(t,f){var c=this,e=s.join(l.getAppPath(),"node_modules/downstream-electron");i.existsSync(s.join(e,u))||(e=s.join(l.getAppPath(),"node_modules/downstream-electron/api/server"),i.existsSync(s.join(e,u))||(e=l.getAppPath(),i.existsSync(s.join(e,u))||(e=r))),console.log("Server Path:",e);var n=s.join(e,u);console.log("Script for server:",n),c.childProcess=a(n,[]);var o={cmd:"init",routeName:h.getSettings().downloadsName,port:t};c.childProcess.send(o),c.childProcess.on("error",function(t){console.error(t)}),c.childProcess.on("message",function(t){if("log"===t.cmd&&console.log(t.log),"listening_port"===t.cmd&&f(t.port),"get_info"===t.cmd){var o=t.requestId,e=t.args.manifest;c._offlineController.getManifestInfo(e,function(t,e){if(t)return c.childProcess.send({error:t,requestId:o});var n=e.manifest.folder;return n=n||h.getSettings().downloadsFolderPath,c.childProcess.send({status:"OK",requestId:o,result:{folder:n,status:e.status}})})}if("is_downloading"===t.cmd){var n=t.requestId,r=t.args.manifest,s=t.args.file,i=c._downloadController.getDownloading(r,s),a=function(t){return t?c.childProcess.send({error:t,requestId:n}):c.childProcess.send({status:"OK",requestId:n})};if(!i)return a();c._downloadController.waitForDownload(i,a)}if("perform_seek"===t.cmd){var l=t.requestId,u=t.args.manifest,d=t.args.file;c._downloadController.performSeek(u,d,function(t){return t?c.childProcess.send({error:t,requestId:l}):c.childProcess.send({status:"OK",requestId:l})})}}),c.childProcess.on("close",function(t,e){null==t?console.log("Child process closed with signal:",e):console.log("Child process closed with code:",t)})},e.prototype.serveOfflineContent=function(o){var r=this;!function e(n){n>r._maxOfflineContentPortRange||t(n,function(t){t?e(++n):(console.log("Port found:",n),r._startServer(n,function(){r._offlineContentPort=n,o(r._offlineContentPort),console.info("Offline content served on port:",n)}))})}(this._offlineContentPort)},e.prototype.stop=function(){this.childProcess.kill("SIGTERM")},n.exports=e}).call(this,"/")},function(t,e,n){"use strict";var o=n(104);t.exports=function(t,e){var n=o.createServer().once("error",function(t){if(t)return e(t);e(null,!0)}).once("listening",function(){n.once("close",function(){e(null,!1)}).close()}).listen(t)}},function(t,e){t.exports=require("net")},function(t,e){t.exports=require("child_process")}],h.c=m,h.d=function(t,e,n){h.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},h.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},h.t=function(e,t){if(1&t&&(e=h(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(h.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)h.d(n,o,function(t){return e[t]}.bind(null,o));return n},h.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return h.d(e,"a",e),e},h.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},h.p="",h(h.s=38);function h(t){if(m[t])return m[t].exports;var e=m[t]={i:t,l:!1,exports:{}};return p[t].call(e.exports,e,e.exports,h),e.l=!0,e.exports}var p,m});