/*!
 * downstream-electron,0.3.5,2019-02-28 20:56:15.008,castlabs GmbH
 * 
 * Copyright (C) 2017 Castlabs GmbH.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("electron"),require("underscore"),require("xmldom"),require("mkdirp"),require("jsonfile"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("base64-js"),require("url-parse"),require("get-folder-size"));else if("function"==typeof define&&define.amd)define(["electron","underscore","xmldom","mkdirp","jsonfile","flake-idgen","biguint-format","moment/moment","base64-js","url-parse","get-folder-size"],e);else{var n="object"==typeof exports?e(require("electron"),require("underscore"),require("xmldom"),require("mkdirp"),require("jsonfile"),require("flake-idgen"),require("biguint-format"),require("moment/moment"),require("base64-js"),require("url-parse"),require("get-folder-size")):e(t.electron,t.underscore,t.xmldom,t.mkdirp,t.jsonfile,t["flake-idgen"],t["biguint-format"],t["moment/moment"],t["base64-js"],t["url-parse"],t["get-folder-size"]);for(var o in n)("object"==typeof exports?exports:t)[o]=n[o]}}(global,function(t,e,n,o,r,s,i,a,u,l,d){return function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=38)}([function(t,e,n){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=n(17),s=n(18),i=n(7),a=/%[A-Za-z0-9_-]+%/g,u={};function l(t,e){var n=t;return"object"===(void 0===n?"undefined":o(n))&&(n=n.msg),n=n?function(t,e){if((e=e||"")instanceof Array)for(var n=f(t.match(a)),r=0,s=Math.min(n.length,e.length);r<s;r++)t=t.replace(new RegExp(n[r],"g"),e[r]);else if("object"===(void 0===e?"undefined":o(e))){for(var i in e)e.hasOwnProperty(i)&&(t=t.replace(new RegExp("%"+i+"%","g"),e[i]));t=t.replace(a,e)}else"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e||(t=t.replace(a,e));return t}(n,e):"Internal Error"}function d(t){for(var e=[],n=1,o=t.length;n<o;n++)e.push(t[n]);return 0===e.length?e=void 0:1===e.length&&(e=e[0]),e}function f(t){for(var e={},n=[],o=0,r=(t=t||[]).length;o<r;o++)e[t[o]]||(e[t[o]]=!0,n.push(t[o]));return n}u.getError=function(t){var e=d(arguments),n=function(t,e){var n=t,r=[];if("object"===(void 0===n?"undefined":o(n))&&(n=n.msg),n)if(e instanceof Array)for(var s=f(n.match(a)),i=0,u=Math.min(s.length,e.length);i<u;i++){var l={};l[s[i].replace(/%/g,"")]=e[i],r.push(l)}else if("object"===(void 0===e?"undefined":o(e))){for(var d in e)if(e.hasOwnProperty(d)){var c={};c[d]=e[d],r.push(c)}}else if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)for(var h=n.match(a)||[],p=0,m=h.length;p<m;p++){var g={};g[h[p].replace(/%/g,"")]=e,r.push(g)}return r&&!r.length&&(r=void 0),r}(t,e),r=l(t,e);return{code:function(t){var e=(t=t||{}).code;return e||(e=i.GENERAL),e}(t),msg:r,keys:n}},u.getTranslation=function(t){return l(t,d(arguments))},u.e=r,u.t=s,t.exports=u},function(t,e,n){"use strict";var o=n(2).app,r=n(3),s={downloadingThreadsRules:{items:[{max:10,files:5},{max:100,files:10},{max:1e3,files:30},{max:1e5,files:50}],threads:[{size:10,number:1},{size:100,number:3},{size:1e3,number:4},{size:1e5,number:5}]},MAX_ERRORS_DOWNLOAD_RETRY:5,MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY:100,MAX_ERRORS_DOWNLOAD_CHUNK_RETRY:5,offlineDomain:"http://127.0.0.1",offlineContentPortStart:3010,maxOfflineContentPortRange:3030,numberOfManifestsInParallel:2,stopOnError:!1,stores:{DOWNLOADS:{LEFT:"left",DOWNLOADING:"downloading",DOWNLOADED:"downloaded",ERRORS:"errors"},STATUS:"status",PARAMS:"params",MANIFEST:"manifest",PERSISTENT:"persistent",DATA:"data"},saveToDisk:!0,times:{DOWNLOAD_TIMEOUT:5e3,RETRY_TIMEOUT:5e3},useChunkedEncoding:!1,useHeadRequests:!0,noCache:!1,defaultManifestRequestOptions:{headers:{Accept:"*/*","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.115 Electron/1.8.6 Safari/537.36"},timeout:5e3},customManifestIdFolderRegex:/^([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\-|\_){1,1}([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\ |\,|\.|\;|\'|\[|\]|\{|\}|\!|\@|\#|\$|\%|\&|\*|\(|\)|\-|\_|\=|\+?){0,49}$/i,openingTagForInvalidCustomManifestIdCharacter:"<span style='background-color:blue;'>",closingTagForInvalidCustomManifestIdCharacter:"</span>"};e.load=function(t){var e=o.getPath("userData"),n="settings",i="public",a="movies";t&&(t.appDir&&(e=t.appDir),t.settingsName&&(n=t.settingsName),t.publicName&&(i=t.publicName),t.downloadsName&&(a=t.downloadsName),t.offlineDomain&&(s.offlineDomain=t.offlineDomain),t.offlineContentPortStart&&(s.offlineContentPortStart=t.offlineContentPortStart),t.maxOfflineContentPortRange&&(s.maxOfflineContentPortRange=t.maxOfflineContentPortRange),t.numberOfManifestsInParallel&&(s.numberOfManifestsInParallel=t.numberOfManifestsInParallel),void 0!==t.stopOnError&&(s.stopOnError=t.stopOnError),t.customManifestIdFolderRegex&&(s.customManifestIdFolderRegex=t.customManifestIdFolderRegex),t.openingTagForInvalidCustomManifestIdCharacter&&(s.openingTagForInvalidCustomManifestIdCharacter=t.openingTagForInvalidCustomManifestIdCharacter),t.closingTagForInvalidCustomManifestIdCharacter&&(s.closingTagForInvalidCustomManifestIdCharacter=t.closingTagForInvalidCustomManifestIdCharacter),void 0!==t.useHeadRequests&&(s.useHeadRequests=t.useHeadRequests),t.times&&t.times.RETRY_TIMEOUT&&(s.times.RETRY_TIMEOUT=t.times.RETRY_TIMEOUT),t.MAX_ERRORS_DOWNLOAD_RETRY&&(s.MAX_ERRORS_DOWNLOAD_RETRY=t.MAX_ERRORS_DOWNLOAD_RETRY),t.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY&&(s.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY=t.MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY),t.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY&&(s.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY=t.MAX_ERRORS_DOWNLOAD_CHUNK_RETRY),t.noCache&&(s.noCache=t.noCache)),e=r.join(r.resolve(e),"/");var u=r.join(r.resolve(e+n)+"/","/"),l=r.join(r.resolve(e+i)+"/","/"),d=r.join(r.resolve(l+a)+"/","/");s.appDir=e,s.downloadsFolderPath=d,s.downloadsName=a,s.publicFolderPath=l,s.settingsFolder=u},e.getSettings=function(){return s}},function(e,n){e.exports=t},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";var o=n(4),r=n(1),s=Object.assign({start:0,end:null},r.getSettings().defaultManifestRequestOptions);t.exports={checkForLocalFile:function(t,e){o.stat(t,function(t,n){t?e(!1):e(!0,n.size)})},defaultOptions:s,errors:{ABORTED:"ABORTED",CHUNK_ERROR:"CHUNK_ERROR",CHUNK_SIZE_ERROR:"CHUNK_SIZE_ERROR",FILE_CREATING_ERROR:"FILE_CREATING_ERROR",FILE_WRITING_ERROR:"FILE_WRITING_ERROR",NO_SPACE_LEFT_ERROR:"NO_SPACE_LEFT_ERROR",INTERNET:"INTERNET",TIMEOUT:"TIMEOUT"}}},function(t,n){t.exports=e},function(t,e,n){"use strict";t.exports={GENERAL:-1,ERRORS:{INTERNAL_ERROR:1,BROKEN:11,FINISHED:12,UNFINISHED:13,STOPPED:14,CREATED:15,MISSING:16,RESUMED:17,STARTED:18,LOADING:19,REMOVED:20,INFO:21,EXISTS:22,NOT_FOUND:100}}},function(t,e,n){"use strict";t.exports={CREATED:"CREATED",STARTED:"STARTED",ERROR:"ERROR",STOPPED:"STOPPED",FINISHED:"FINISHED",BROKEN:"BROKEN",QUEUED:"QUEUED"}},function(t,e,n){"use strict";var o=n(40),r=n(41),s=new o,i=function(){function t(){}return t.getUUID=function(){var t=s.next();return r(t,"dec")},t}();e.SnowflakeId=i},function(t,e){t.exports=n},function(t,e,n){"use strict";t.exports=function(t,e,n){if(void 0!==n)for(var o=0,r=e.length;o<r;o++){var s=e[o],i=s.defaultValue,a=s.name||s;t[a]=void 0!==n[a]?n[a]:i}}},function(t,e,n){"use strict";var o=n(13),r=n(1),s=n(29),i=n(73);function a(t,e,n){this.manifestId=t,this.storageKey=e,this.items=n}a.prototype._saveToDisk=function(t,e){var n=this,i=r.getSettings().settingsFolder+this.manifestId+"/",a=i+(this.storageKey+".json");o(i,function(o){if(o)e(o);else{var r=u(n.storageKey,n.items);s.writeFile(a,r,function(n){n?e(n):t()})}})},a.prototype.save=function(){return new Promise(this._saveToDisk.bind(this))},t.exports=a;var u=function(t,e){var n=[],o=void 0;if("downloading"===t){for(var r in n=[],e)n.push(e[r]);e=n}if(e instanceof Array){o=[];for(var s=0,a=e.length;s<a;s++)o.push(new i(e[s]))}else o=e;return o}},function(t,e){t.exports=o},function(t,e){t.exports=require("events")},function(t,e,n){"use strict";var o=n(44),r=n(45),s=n(46),i=n(55),a=n(9),u=n(56),l=n(57),d=new o.ManifestLoader,f=n(58),c=n(59),h=function(){function t(t){this.id=t||String(a.SnowflakeId.getUUID())}return t.prototype._setUpUrl=function(t){var e=f(t).pathname;this.url=t,this.url_domain=t.substring(0,t.lastIndexOf("/")+1),this.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length)},t.prototype.load=function(t){var e=this;return new Promise(function(n,o){e._setUpUrl(t),d.load(t).then(function(t){var r=c.isUTF16(t.response);t.response=t.response.toString(r?"utf16le":"utf-8");var i=t.response;e.manifestXML=new s.ManifestXML,e.manifestXML.parse(i,function(){n()},function(t){throw o(t),new Error("Manifest parsing error")})},function(t){o(t)})})},t.prototype.loadWithManifest=function(t,e){var n=this;return new Promise(function(o,r){n._setUpUrl(t),n.manifestXML=new s.ManifestXML,n.manifestXML.parse(e,function(){o()},function(t){throw r(t),new Error("Manifest parsing error")})})},t.prototype.loadFromLocal=function(t,e){var n=this;return new Promise(function(o,i){e&&t?r(t).then(function(t){n._setUpUrl(e),n.manifestXML=new s.ManifestXML,n.manifestXML.parse(t,function(){o()},function(t){i(t)})},function(t){i(t)}):i("wrong parameter")})},t.prototype.loadFromStr=function(t,e){this.url_domain=e.substring(0,e.lastIndexOf("/")+1),this.manifest_name=e.substring(e.lastIndexOf("/")+1,e.length),this.manifestXML=new s.ManifestXML,this.manifestXML.parse(t)},t.prototype.getAdaptationSets=function(){var t=this.manifestXML.getVideoAdaptation(),e=this.manifestXML.getAudioAdaptation(),n=this.manifestXML.getTextAdaptation();return new i.AllAdaptationSets(t,e,n)},t.prototype.getVideoRepresentations=function(){return this.manifestXML.getVideoAdaptation()},t.prototype.getAudioRepresentations=function(){return this.manifestXML.getAudioAdaptation()},t.prototype.getTextRepresentations=function(){return this.manifestXML.getTextAdaptation()},t.prototype.getProtections=function(){var t={};return t.video=l(this.getVideoRepresentations()),t.audio=l(this.getAudioRepresentations()),t.text=l(this.getTextRepresentations()),t},t.prototype.getRemoteDomain=function(){return this.url_domain},t.prototype.getManifestName=function(){return this.manifest_name},t.prototype.getManifestUrl=function(){return this.url},t.prototype.getManifestXML=function(){return this.manifestXML.getManifestXML()},t.prototype.removeNode=function(){this.manifestXML.removeNode()},t.prototype.getJsonInfo=function(){var t={};return t.id=this.id,t.audio=u(this.getAudioRepresentations()),t.video=u(this.getVideoRepresentations()),t.text=u(this.getTextRepresentations()),t.protections=this.getProtections(),t},t}();e.Manifest=h},function(t,e,n){"use strict";var o=n(9),r=function(){function t(t,e){this.childCollection=[],this.attributeList={},this.setCurrentNode(t),this.setChildCollection(t.childNodes),this.buildAttributeList(t,this.attributeList),this.setParentNode(t.parentNode),this.xml=e,this.id=o.SnowflakeId.getUUID()}return t.prototype.setParentNode=function(t){this.parentNode=t},t.prototype.setChildCollection=function(t){this.childCollection=t},t.prototype.setCurrentNode=function(t){this.currentNode=t},t.prototype.buildAttributeList=function(t,e){this.writeAttributesToList(t,e)},t.prototype.writeAttributesToList=function(t,e){var n=t.attributes;for(var o in n)e[n[o].nodeName]||(e[n[o].nodeName]=n[o].nodeValue);null!==t.parentNode&&this.buildAttributeList(t.parentNode,e)},t.prototype.getCurrentNode=function(){return this.currentNode},t.prototype.markNodeForDownload=function(t){var e=this.xml.createAttribute("markForDownload");t?(e.value=t.toString(),this.currentNode.setAttributeNode(e)):this.currentNode.removeAttribute("markForDownload")},t.prototype.getAttributeList=function(){return this.attributeList},t}();e.ManifestNode=r},function(t,e,n){"use strict";var o=n(7),r={downloads:{_GENERAL:{code:o.ERRORS.INTERNAL_ERROR,msg:"Sorry we are unable to process your request - some internal error occurred"},ALREADY_FINISHED:{code:o.ERRORS.FINISHED,msg:"This download '%manifestId%' has been already finished."},ALREADY_REMOVED_ALL_UNFINISHED:{code:o.ERRORS.REMOVED,msg:"All unfinished downloads have been already removed, nothing left."},ALREADY_RESUMED:{code:o.ERRORS.RESUMED,msg:"This download '%manifestId%' has been already resumed."},ALREADY_STOPPED:{code:o.ERRORS.STOPPED,msg:"This download '%manifestId%' has been already stopped or has been already downloaded."},ALREADY_STOPPED_ALL:{code:o.ERRORS.STOPPED,msg:"There are no downloads to be stopped."},ALREADY_STARTED:{code:o.ERRORS.STARTED,msg:"This download '%manifestId%' has been already started."},BROKEN_CANNOT_BE_RESUMED:{code:o.ERRORS.BROKEN,msg:"This download '%manifestId%' is broken and cannot be resumed."},INFO_FAILED:{code:o.ERRORS.INFO,msg:"Gettting info of download '%manifestId%' failed."},REMOVING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all downloads failed."},REMOVING_ALL_UNFINISHED_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of all unfinished downloads failed."},REMOVING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Removing of download '%manifestId%' failed."},RESUMING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Resuming of download '%manifestId%' failed."},UPDATE_DOWNLOAD_FOLDER_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Updating of download folder for '%manifestId%' failed."},STOPPING_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping of download '%manifestId%' failed."},SAVING_PERSISTENT_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving persistent info for download '%manifestId%' failed."},SAVING_DATA_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Saving data for download '%manifestId%' failed."},STOPPING_ALL_FAILED:{code:o.ERRORS.INTERNAL_ERROR,msg:"Stopping all downloads failed."},UNFINISHED:{code:o.ERRORS.UNFINISHED,msg:"This download is not ready yet."}},manifests:{NOT_FOUND:{code:o.ERRORS.NOT_FOUND,msg:"Manifest with id='%manifestId%' not found."},LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load manifest from url '%manifestUrl%'."},LIST_LOADING_FAILED:{code:o.ERRORS.LOADING,msg:"Could not load list of manifests."},FOLDER_ALREADY_EXISTS:{code:o.ERRORS.EXISTS,msg:"Folder for manifest with id ='%manifestId%' already exists."},INVALID_ID:{code:o.ERRORS.BROKEN,msg:"Provided custom id for manifest is not valid: ('%invalid%')"}}};t.exports=r},function(t,e,n){"use strict";t.exports={test:"Hello world"}},function(t,e,n){"use strict";t.exports={regexpProtocolRemove:/^https{0,1}\:\/\//i}},function(t,e,n){"use strict";var o=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(16),s=n(48),i=function(t){function e(e,n){t.call(this,e,n),this.representationColl=[],this.contentProtections=[],this.parse()}return o(e,t),e.prototype.parse=function(){for(var t=this.currentNode.getElementsByTagName("Representation"),e=0;e<t.length;e++){var n=new s.RepresentationNode(t[e],this.xml);this.representationColl[e]=n,this.representationColl[0].hasMimeType()&&(this.attributeList.mimeType=this.representationColl[0].getMimeType())}for(var o=this.currentNode.getElementsByTagName("ContentProtection"),r=0;r<o.length;r++){var i=o[r].attributes,a=o[r].getElementsByTagName("cenc:pssh");if(i.getNamedItem("schemeIdUri")&&a.length){var u={schemeIdUri:i.getNamedItem("schemeIdUri").value,cencPSSH:a[0].childNodes[0].data};this.contentProtections.push(u)}}},e.prototype.getContentProtections=function(){return this.contentProtections},e.prototype.getWidevineProtection=function(){return this.contentProtections.filter(function(t){return"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===t.schemeIdUri})},e.prototype.isMimeType=function(t){return-1!=this.attributeList.mimeType.indexOf(t)},e.prototype.isContentType=function(t){return!(!this.attributeList.contentType||-1==this.attributeList.contentType.indexOf(t))},e}(r.ManifestNode);e.AdaptationSetNode=i},function(t,e,n){"use strict";var o=n(49),r=n(22),s=void 0;!function(t){t[t.FROM_TEMPLATE=0]="FROM_TEMPLATE",t[t.FROM_TIMELINE=1]="FROM_TIMELINE",t[t.FROM_SEGMENTLIST=2]="FROM_SEGMENTLIST",t[t.FROM_SEGMENT_BASE=3]="FROM_SEGMENT_BASE"}(s||(s={}));var i=function(){function t(e,n,o,i,a,u,l,d,f,c,h){this.hasSegmentBase=!1,this.baseUrl="",this.presentationDuration=0,this.bandwidth=0,this.startNumber=0,this.mediaUrls=[],this.whichUseCase=-1,this.mimeType="",t.count+=1,this.presentationDuration=e,this.mimeType=a,o&&(this.baseUrl=o),n&&(this.bandwidth=n),i&&(this.representationID=i),u&&(this.segmentBase=u,this.hasSegmentBase=!0,this.whichUseCase=s.FROM_SEGMENT_BASE),l&&(this.segmentTemplate=l,this.mediaTemplate=this.segmentTemplate.attributes.getNamedItem("media").nodeValue,this.mediaTemplate=this.replace$RepresentationID$(this.mediaTemplate,this.representationID),this.mediaTemplate=this.replace$Bandwidth$(this.mediaTemplate,this.bandwidth),this.startNumber=this.segmentTemplate.attributes.getNamedItem("startNumber")?parseInt(this.segmentTemplate.attributes.getNamedItem("startNumber").nodeValue):0,this.whichUseCase=s.FROM_TEMPLATE),d&&(this.segmentTimeline=d),f&&(this.timelineItemList=f,this.whichUseCase=s.FROM_TIMELINE),c&&(this.segmentList=c),h&&(this.segmentUrlList=h,this.whichUseCase=s.FROM_SEGMENTLIST);var p=!1,m="";switch(this.whichUseCase){case s.FROM_SEGMENTLIST:this.createFragmentFromUrlList(this.segmentUrlList),m=this.createInitSegment(this.segmentList.getElementsByTagName("Initialization")[0].attributes.getNamedItem("sourceURL").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType)),t.count;break;case s.FROM_SEGMENT_BASE:try{p=-1!==this.baseUrl.indexOf(".")}catch(t){}p&&this.mediaUrls.push(new r.MediaUrl(this.baseUrl,this.baseUrl,this.mimeType)),t.count;break;case s.FROM_TEMPLATE:this.createFragmentsFromTemplate(),m=this.createInitSegment(this.segmentTemplate.attributes.getNamedItem("initialization").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType));break;case s.FROM_TIMELINE:this.createFragmentUrlsFromTimeline(this.timelineItemList),m=this.createInitSegment(this.segmentTemplate.attributes.getNamedItem("initialization").nodeValue),this.mediaUrls.unshift(new r.MediaUrl(this.baseUrl,m,this.mimeType));break;default:try{p=-1!==this.baseUrl.indexOf(".")}catch(t){}p&&this.mediaUrls.push(new r.MediaUrl("",this.baseUrl,this.mimeType))}}return t.prototype.createFragmentUrlsFromTimeline=function(t){var e=this.segmentTemplate.attributes.getNamedItem("presentationTimeOffset");e=e?parseInt(e.nodeValue,10):0;for(var n=!1,o=0,s=0;s<t.length;s++){s>0&&t[s].attributes.getNamedItem("t")&&void 0!==t[s].attributes.getNamedItem("t").nodeValue?(n=!0,o=parseInt(t[s].attributes.getNamedItem("t").nodeValue)):n=!1;for(var i=t[s].attributes.getNamedItem("d")&&void 0!==t[s].attributes.getNamedItem("d").nodeValue?parseInt(t[s].attributes.getNamedItem("d").nodeValue):0,a=t[s].attributes.getNamedItem("r")&&void 0!==t[s].attributes.getNamedItem("r").nodeValue?parseInt(t[s].attributes.getNamedItem("r").nodeValue):0,u=1;u<=a;u++){var l=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;l=this.replace$RepresentationID$(l,this.representationID),l=this.replace$Time$(l,e),l=this.replace$Bandwidth$(l,this.bandwidth),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,l,this.mimeType)),n?e=o:e+=i}var d=this.segmentTemplate.attributes.getNamedItem("media").nodeValue;d=this.replace$RepresentationID$(d,this.representationID),d=this.replace$Time$(d,e),d=this.replace$Bandwidth$(d,this.bandwidth),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,d,this.mimeType)),n?e=o:e+=i}},t.prototype.createFragmentFromUrlList=function(t){for(var e=0;e<t.length;e++){var n=t[e].attributes.getNamedItem("media").nodeValue;this.mediaUrls.push(new r.MediaUrl(this.baseUrl,n,this.mimeType))}},t.prototype.createFragmentsFromTemplate=function(){for(var t=parseInt(this.segmentTemplate.attributes.getNamedItem("duration").nodeValue),e=this.segmentTemplate.attributes.getNamedItem("timescale")?parseInt(this.segmentTemplate.attributes.getNamedItem("timescale").nodeValue):1,n=Math.ceil(this.presentationDuration/(t/e)/1e3),s=this.mediaTemplate.split("$"),i=void 0,a=this.startNumber||0,u=0;u<s.length;u++)-1!=s[u].indexOf("Number")&&(i="$"+s[u]+"$");for(var l=o.ZeroPadding.getPaddingAmount(i),d=a;d<n+a;d++){var f=o.ZeroPadding.addPadding(d,l),c=void 0;c=0===l?this.replace$Number$(this.mediaTemplate,d):this.mediaTemplate.replace(i,f),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,c,this.mimeType))}},t.prototype.replace$RepresentationID$=function(t,e){return t.replace(new RegExp("\\$RepresentationID\\$","g"),e)},t.prototype.replace$Number$=function(t,e){return t.replace(new RegExp("\\$Number\\$","g"),e.toString())},t.prototype.replace$Bandwidth$=function(t,e){return t.replace(new RegExp("\\$Bandwidth\\$","g"),e.toString())},t.prototype.replace$Time$=function(t,e){return t.replace(new RegExp("\\$Time\\$","g"),e.toString())},t.prototype.createInitSegment=function(t){return t=this.replace$Bandwidth$(t,this.bandwidth),t=this.replace$RepresentationID$(t,this.representationID)},t.prototype.getMediaUrlList=function(){return this.mediaUrls},t.count=-1,t}();e.SegmentInformation=i},function(t,e,n){"use strict";var o=function(){function t(t,e,n,o){void 0===o&&(o=""),this.baseURL=t,this.mediaFile=-1!==e.indexOf("/")?this.truncateMediaFilePath(e):e,this.url_domain=o,this.mimeType=n}return t.prototype.truncateMediaFilePath=function(t){var e=t.lastIndexOf("/"),n=t.substring(0,e),o=t.substring(e+1,t.length);return this.baseURL+=n,o},t.prototype.getFileAddress=function(){return this.baseURL+this.mediaFile},t}();e.MediaUrl=o},function(t,e,n){"use strict";var o=n(50),r=function(){function t(){}return t.getDuration=function(t){return o.duration(t).asMilliseconds()},t.getDurationAsS=function(t){return o.duration(t).asSeconds()},t.getMoment=function(){return o},t}();e.IsoDurationParser=r},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["audioSamplingRate","bandwidth","id","lang","durationInS"],t)}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["bandwidth","id","height","lang","width","durationInS"],t)}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["bandwidth","id","lang","durationInS"],t)}},function(t,e,n){"use strict";var o=n(4),r=n(3),s=n(1);t.exports=function(t,e){var n=r.resolve(s.getSettings().settingsFolder+"/"+t+"/"),i=r.resolve(s.getSettings().downloadsFolderPath+"/"+t+"/");function a(t){return new Promise(function(e){o.stat(t,function(t,n){t?e():n.isDirectory()?e("Folder already exists"):e()})})}return e&&(i=r.resolve(e+"/"+t+"/")),new Promise(function(t,e){Promise.all([a(n),a(i)]).then(function(n){(n=n||[]).filter(function(t){return void 0!==t}).length?e(n):t()},e)})}},function(t,e,n){"use strict";var o=n(4),r=n(3),s=n(5);t.exports=function t(e,n,i){i=i||0;var a=10,u=500;if("string"!=typeof e)throw new Error("directory path required");if(void 0!==n&&"function"!=typeof n)throw new Error("callback must be function");var l=this,d=void 0,f=void 0;function c(o){if(o&&"ENOTEMPTY"===o.code&&i<a)return i++,console.error("ERROR ENOTEMPTY",e,i),void setTimeout(function(){t(e,n,i)},u);o&&"ENOENT"===o.code&&(arguments[0]=null),f||(f=arguments),n&&!d&&(d=!0,n.apply(l,f))}s.checkForLocalFile(e,function(n){if(!n)return c(null);function s(n,s){if(n)return c(n);var i=s.length;if(0===i)return o.rmdir(e,c);s.forEach(function(n){t(r.resolve(e,n),function(t){return t?c(t):0==--i?o.rmdir(e,c):void 0})})}o.stat(e,function(t,n){return t?c(t):n.isDirectory()?void o.readdir(e,s):o.unlink(e,c)})})}},function(t,e){t.exports=r},function(t,e){t.exports=require("util")},function(t,e,n){"use strict";function o(){this._items=[]}o.prototype.clear=function(){this._items=[]},o.prototype.concat=function(t){this._items=this._items.concat(t)},o.prototype.count=function(){return this._items.length},o.prototype.getItems=function(){return this._items},o.prototype.push=function(t){this._items.push(t)},o.prototype.shift=function(){return this._items.shift()},o.prototype.unshift=function(){return this._items.unshift.apply(this,arguments)},t.exports=o},function(t,e,n){"use strict";t.exports=function(t,e){function n(){var t,e=[],n=void 0;for(n=0,t=arguments.length;n<t;n++)e.push(arguments[n]);return e.unshift(this._storageKey),this._parent._itemAction.apply(this._parent,e)}for(var o in e.prototype)e.prototype.hasOwnProperty(o)&&(t[o]=n.bind(t,o))}},function(t,e,n){"use strict";function o(){this._items={}}o.prototype.clear=function(){this._items={}},o.prototype.count=function(){return this.getKeys().length},o.prototype.decrease=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]--},o.prototype.getItem=function(t){return this._items[t]},o.prototype.getItems=function(){return this._items},o.prototype.getKeys=function(){return Object.keys(this._items)},o.prototype.increase=function(t){"number"!=typeof this._items[t]&&(this._items[t]=0),this._items[t]++},o.prototype.removeItem=function(t){delete this._items[t]},o.prototype.setItem=function(t,e){this._items[t]=e},o.prototype.setItems=function(t){for(var e in t)t.hasOwnProperty(e)&&this.setItem(e,t[e])},t.exports=o},function(t,e,n){"use strict";function o(){for(var t="",e=0,n=arguments.length;e<n;e++)t+=arguments[e].replace(/^\.\//g,"/"),e<n-1&&(t+="/");return t=(t=(t=(t=t.replace(/\/{2,}/g,"/")).replace("https:/","https://")).replace("http:/","http://")).replace("file:/","file://")}t.exports={joinPath:function(){return o.apply(null,arguments)+"/"},joinPathWithFile:function(){return o.apply(null,arguments)}}},function(t,e,n){"use strict";var o=n(29),r=n(3),s=n(1);function i(t,e){if(!t)throw new Error("manifestId is missing");return this._manifestId=t,this._itemName=e,new Promise(this._read.bind(this))}i.prototype._read=function(t){var e=r.resolve(s.getSettings().settingsFolder+"/"+this._manifestId+"/"+this._itemName+".json");o.readFile(e,function(e,n){e?t():t(n)})},t.exports=i},,,function(t,e,n){t.exports=n(39)},function(t,e,n){"use strict";var o,r=n(6),s=n(9),i=n(1),a=n(42),u=n(83),l=n(96),d=n(99),f=n(102),c=n(103);(o=function(){this._offlineContentPort=i.getSettings().offlineContentPortStart,r.bindAll(this,"_onApiRequest","processSubscriber"),this._createControllers(),this._serveOfflineContent(),this._attachEvents()}).prototype.stop=function(){this.server.stop()},o.prototype._apiMethods=function(t,e,n,o){var i=this,a=n[0],u={};u.promiseId=e;(n=n||[]).unshift(o),n.unshift(function(e,l){var d=String(s.SnowflakeId.getUUID()),f=r.clone({errorId:d,methodName:t,args:n.slice(4),err:e,internalError:l});u.manifestId=a,u.status="ERROR",u.error=e||{},u.error.errorId=d,u.error.details=l,i._send(u,o);try{console.error(new Date,"Error occurred",JSON.stringify(f))}catch(t){}}),n.unshift(function(t,e){u.subscribersId=e,u.status="OK",u.result=t,u.manifestId=a,i._send(u,o)}),n.unshift(this);var l=this._getMethod(t);"function"==typeof l?l.apply(null,n):(u.status="ERROR",u.error="Provided method '"+t+"' doesn't exists",this._send(u,o),console.error("ERROR","Provided method '"+t+"' doesn't exists"))},o.prototype._attachEvents=function(){n(2).ipcMain.on("downstreamElectronBE",this._onApiRequest)},o.prototype._createControllers=function(){this.manifestController=new l,this.offlineController=new d(this.manifestController),this.downloadsController=new u(this.manifestController,this.offlineController),this.subscribersController=new f},o.prototype._getMethod=function(t){var e,n=t.split("."),o=void 0,r=void 0;for(r=a[n[0]],o=1,e=n.length;o<e;o++)r=r[n[o]];return r},o.prototype._onApiRequest=function(t,e,n){var o=e.promiseId,r=e.args||{},s=e.method;n=e.windowId;for(var i=[],a=0;r.hasOwnProperty(a);)i.push(r[a]),a++;this._apiMethods(s,o,i,n)},o.prototype._send=function(t,e){try{for(var o=n(2).BrowserWindow.getAllWindows(),r=0,s=o.length;r<s;r++)if(o[r].id===e){o[r].webContents.send("downstreamElectronFE",t);break}}catch(t){console.error("internal error ocurred",t)}},o.prototype._serveOfflineContent=function(){var t=this,e=i.getSettings().maxOfflineContentPortRange;this.server=new c(this.offlineController,this.downloadsController,e,this._offlineContentPort),this.server.serveOfflineContent(function(e){t._offlineContentPort=e})},o.prototype.getOfflinePath=function(t){var e=i.getSettings().offlineDomain,n=this._offlineContentPort;return n&&(e+=":"+n),e+="/"+encodeURIComponent(i.getSettings().downloadsName)+"/"+encodeURIComponent(t)+"/"},o.prototype.processSubscriber=function(t,e,n,o,r){var s={};s.subscriberId=t,s.status=e?"ERROR":"OK",s.err=e,s.result=n,s.subscriberFinished=r,this._send(s,o),r&&this.subscribersController.removeAllManifestSubscribersById(t)},t.exports={init:function(t){return i.load(t),new o}}},function(t,e){t.exports=s},function(t,e){t.exports=i},function(t,e,n){"use strict";var o={};o.create=n(43),o.createPersistent=n(61),o.getFolderInfo=n(62),o.getList=n(63),o.getListWithInfo=n(64),o.getOfflineLink=n(65),o.info=n(66),o.remove=n(67),o.removeAll=n(68),o.removeAllUnfinished=n(69),o.removePersistent=n(70),o.resume=n(71),o.saveData=n(72),o.savePersistent=n(74),o.start=n(75),o.stop=n(76),o.stopAll=n(77),o.subscribe=n(78),o.unsubscribe=n(80),o.updateDownloadFolder=n(81);var r=n(82);t.exports={downloads:o,removeSubscribers:r}},function(t,e,n){"use strict";var o=n(15).Manifest,r=n(0),s=n(27),i=n(60),a=n(1);t.exports=function(t,e,n,u,l,d,f){var c=!0;if(void 0!==d&&""!==d&&null!==d||(c=!1),c){if(void 0!==d&&"number"!=typeof d&&"string"!=typeof d)return void n(r.getError(r.e.manifests.INVALID_ID,d));var h=a.getSettings().customManifestIdFolderRegex;if(!d.match(h)){var p=i(d,h,a.getSettings().openingTagForInvalidCustomManifestIdCharacter,a.getSettings().closingTagForInvalidCustomManifestIdCharacter);return void n(r.getError(r.e.manifests.INVALID_ID,p))}}var m=new o(d);(f?m.loadWithManifest(l,f):m.load(l)).then(function(){c?s(d).then(function(){t.manifestController.cacheManifest(m),e(m.getJsonInfo())},function(t){n(r.getError(r.e.manifests.FOLDER_ALREADY_EXISTS,d),t)}):(t.manifestController.cacheManifest(m),e(m.getJsonInfo()))},function(t){n(r.getError(r.e.manifests.LOADING_FAILED,l),t)})}},function(t,e,n){"use strict";var o=n(2).net,r=n(1),s=function(){function t(){}return t.prototype.load=function(t){return this.sendXMLHttpRequest(t)},t.prototype.sendXMLHttpRequest=function(t){var e=Object.assign({url:t,method:"GET"},r.getSettings().defaultManifestRequestOptions);return new Promise(function(n,s){var i=o.request(e);i.chunkedEncoding=r.getSettings().useChunkedEncoding,i.on("error",function(t){s(t)}),i.on("response",function(e){e.on("error",function(t){s(new Error("MANIFEST LOAD FAILURE "+t))});var o=void 0;if(e.statusCode>=400&&(o=e.statusMessage),o)s(new Error("MANIFEST LOAD FAILURE "+o));else{var r=[];e.on("data",function(t){r.push(t)}).on("end",function(){r=Buffer.concat(r),n({response:r,url:t})})}}),i.end()})},t}();e.ManifestLoader=s},function(t,e,n){"use strict";var o=n(4),r=n(3);t.exports=function(t){return new Promise(function(e,n){o.readFile(r.resolve(t),"utf-8",function(t,o){t?n(t):e(o)})})}},function(t,e,n){"use strict";var o=n(47),r=n(51);o.ManifestXML.prototype.getManifestType=function(t){return 0!==t.getElementsByTagName("SmoothStreamingMedia").length?"MSS":"DASH"},o.ManifestXML.prototype.getAdaptationSetNodeName=function(){return"MSS"===this.manifestType?"StreamIndex":"AdaptationSet"},o.ManifestXML.prototype.getRepresentationNodeName=function(){return"MSS"===this.manifestType?"QualityLevel":"Representation"},o.ManifestXML.prototype.parseStreams=function(){for(var t=this.xml.getElementsByTagName("StreamIndex"),e=0;e<t.length;e++){var n=new r.StreamIndexNode(t[e],this.xml);this.adaptationSetColl[e]=n}},o.ManifestXML.prototype._parseAdaptations=o.ManifestXML.prototype.parseAdaptations,o.ManifestXML.prototype.parseAdaptations=function(){return this.manifestType=this.getManifestType(this.xml),"MSS"===this.manifestType?this.parseStreams():this._parseAdaptations()},e.ManifestXML=o.ManifestXML},function(t,e,n){"use strict";var o=n(20),r=n(10).DOMParser,s=function(){function t(){}return t.prototype.parse=function(t,e,n){var o=void 0;o="function"==typeof e&&"function"==typeof n?new r({errorHandler:{warning:function(){},error:n,fatalError:n}}):new r,this.adaptationSetColl=[],this.xml=o.parseFromString(t,"application/xml"),this.parseAdaptations(),"function"==typeof e&&e()},t.prototype.getAdaptationSetNodeName=function(){return"AdaptationSet"},t.prototype.getRepresentationNodeName=function(){return"Representation"},t.prototype.parseAdaptations=function(){for(var t=this.xml.getElementsByTagName("AdaptationSet"),e=0;e<t.length;e++){var n=new o.AdaptationSetNode(t[e],this.xml);this.adaptationSetColl[e]=n}},t.prototype.getVideoAdaptation=function(){return this.getAdaptations("video")},t.prototype.getAudioAdaptation=function(){return this.getAdaptations("audio")},t.prototype.getTextAdaptation=function(){return this.getAdaptations("text")},t.prototype.getManifestXML=function(){return this.xml},t.prototype.getAdaptations=function(t){return this.adaptationSetColl.map(function(t){return t}).filter(function(e){if(e.isMimeType(t)||e.isContentType(t))return!0})},t.cloneXML=function(t){var e=t.implementation.createDocument(t.namespaceURI,null,null),n=e.importNode(t.documentElement,!0);return e.appendChild(n),e},t.prototype.removeNode=function(){for(var t=this,e=this.xml.documentElement.getElementsByTagName(this.getRepresentationNodeName()),n=this.xml.documentElement.getElementsByTagName(this.getAdaptationSetNodeName()),o=[],r=[],s=0;s<e.length;s++)o[s]=e[s];o.forEach(function(t){!(!t.attributes.getNamedItem("markForDownload")||"true"!=t.attributes.getNamedItem("markForDownload").value)||t.parentNode.removeChild(t),t.removeAttribute("markForDownload")},this);for(var i=0;i<n.length;i++)r[i]=n[i];r.forEach(function(e){e.getElementsByTagName(t.getRepresentationNodeName()).length||e.parentNode.removeChild(e)})},t}();e.ManifestXML=s},function(t,e,n){"use strict";var o=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(16),s=n(21),i=n(23),a=function(t){function e(e,n){t.call(this,e,n),this.markNodeForDownload(!1)}return o(e,t),e.prototype.createSegmentInformation=function(){var t=i.IsoDurationParser.getDuration(this.attributeList.mediaPresentationDuration),e=void 0,n=void 0,o=void 0,r=this.attributeList.id;if(this.segmentTemplate&&this.segmentTemplate.hasChildNodes())for(var a=0;a<this.segmentTemplate.childNodes.length;a++)"SegmentTimeline"==this.segmentTemplate.childNodes[a].nodeName&&(e=this.segmentTemplate.childNodes[a]);try{n=e.getElementsByTagName("S")}catch(t){}try{o=this.segmentList.getElementsByTagName("SegmentURL")}catch(t){}this.bandwidth=this.attributeList.bandwidth?parseInt(this.attributeList.bandwidth):-1,this.segmentInformation=new s.SegmentInformation(t,this.bandwidth,this.baseURL,r,this.attributeList.mimeType,this.segmentBase,this.segmentTemplate,e,n,this.segmentList,o)},e.prototype.writeAttributesToList=function(e,n){for(var o=e.attributes,r=0;r<e.childNodes.length;r++)this.baseURL||"BaseURL"!=e.childNodes[r].nodeName||(this.baseURL=e.childNodes[r].firstChild.nodeValue),this.segmentBase||"SegmentBase"!=e.childNodes[r].nodeName||(this.segmentBase=e.childNodes[r]),this.segmentTemplate||"SegmentTemplate"!=e.childNodes[r].nodeName||(this.segmentTemplate=e.childNodes[r]),this.segmentList||"SegmentList"!=e.childNodes[r].nodeName||(this.segmentList=e.childNodes[r]);for(var s in o)n[o[s].nodeName]||(n[o[s].nodeName]=o[s].nodeValue);void 0!==n.mediaPresentationDuration&&(n.durationInS=i.IsoDurationParser.getDurationAsS(this.attributeList.mediaPresentationDuration)),null!==e.parentNode?this.buildAttributeList(e.parentNode,n):this.segmentInformation||this.createSegmentInformation(),t.prototype.writeAttributesToList.call(this,e,n)},e.prototype.getMimeType=function(){return this.attributeList.mimeType||this.attributeList.contentType},e.prototype.hasMimeType=function(){return!(!this.attributeList.mimeType&&!this.attributeList.contentType)},e.prototype.getMediaUrlList=function(){return this.segmentInformation.getMediaUrlList()},e.prototype.getRepresentationId=function(){return this.id},e}(r.ManifestNode);e.RepresentationNode=a},function(t,e,n){"use strict";var o=function(){function t(){}return t.addPadding=function(t,e){for(var n=t.toString().split("");n.length<e;)n.unshift("0");return n.join("")},t.getPaddingAmount=function(t){var e=t.indexOf("%"),n=t.lastIndexOf("$"),o=parseInt(t.substring(e+1,n-1));return o=isNaN(o)?0:o},t}();e.ZeroPadding=o},function(t,e){t.exports=a},function(t,e,n){"use strict";var o=n(52),r=n(10).DOMParser,s=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},i=n(20),a=n(53),u=function(t){function e(e,n){t.call(this,e,n)}return s(e,t),e.prototype.parse=function(){for(var t=this.currentNode.getElementsByTagName("QualityLevel"),e=0;e<t.length;e++){var n=new a.QualityLevelNode(t[e],this.xml);this.representationColl[e]=n,this.representationColl[0].hasMimeType()&&(this.attributeList.mimeType=this.representationColl[0].getMimeType()),this.representationColl[0].hasContentType()&&(this.attributeList.mimeType=this.representationColl[0].getContentType())}var o=this.xml.getElementsByTagName("Protection")[0];if(void 0!==o){var r=o.getElementsByTagName("ProtectionHeader")[0],s=r.firstChild.data.replace(/\n|\r/g,""),i=this.getKIDFromProtectionHeader(r),u={schemeIdUri:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",cencPSSH:s};this.contentProtections.push(u);var l={schemeIdUri:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",cencPSSH:this.createWidevinePssh(i)};this.contentProtections.push(l)}},e.prototype.getKIDFromProtectionHeader=function(t){var e,n=void 0,s=void 0;return e=o.toByteArray(t.firstChild.data),n=this.getWRMHeaderFromPRHeader(e),n=new Uint16Array(n.buffer),n=String.fromCharCode.apply(null,n),s=(new r).parseFromString(n,"application/xml").getElementsByTagName("KID")[0].textContent,s=o.toByteArray(s),this.convertUuidEndianness(s),s},e.prototype.convertUuidEndianness=function(t){this.swapBytes(t,0,3),this.swapBytes(t,1,2),this.swapBytes(t,4,5),this.swapBytes(t,6,7)},e.prototype.swapBytes=function(t,e,n){var o=t[e];t[e]=t[n],t[n]=o},e.prototype.getWRMHeaderFromPRHeader=function(t){var e=void 0,n=void 0,o=void 0,r=0;for(r+=4,r+=2;r<t.length;)if(e=256*t[r+1]+t[r],r+=2,1===e)return n=256*t[r+1]+t[r],r+=2,(o=new Uint8Array(n)).set(t.subarray(r,r+n)),o;return null},e.prototype.createWidevinePssh=function(t){var e=new Uint8Array(2+t.length);e[0]=18,e[1]=16,e.set(t,2);var n=32+e.length,r=new Uint8Array(n),s=0;return r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=n,r.set([112,115,115,104,0,0,0,0],s),s+=8,r.set([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237],s),s+=16,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=e.length,r.set(e,s),r=o.fromByteArray(r)},e}(i.AdaptationSetNode);e.StreamIndexNode=u},function(t,e){t.exports=u},function(t,e,n){"use strict";var o=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(16),s=n(23),i=n(54),a=function(t){function e(e,n){t.call(this,e,n)}return o(e,t),e.prototype.createSegmentInformation=function(){var t=s.IsoDurationParser.getDuration(parseFloat(this.attributeList.Duration/1e7)),e=this.attributeList.id;this.bandwidth=this.attributeList.bandwidth?parseInt(this.attributeList.bandwidth):-1,this.segmentTemplate=this.mapMssSegmentTemplate(),this.segmentInformation=new i.FragmentInformation(t,this.bandwidth,this.baseURL,e,this.attributeList.mimeType,this.segmentTemplate)},e.prototype.mapMssSegmentTemplate=function(){var t={},e=void 0;return e=(e=this.attributeList.Url.replace("{bitrate}","$Bandwidth$")).replace("{start time}","$Time$"),t.media=e,t.timescale=1e7,t.SegmentTimeline=this.mapMssSegmentTimeline(),t},e.prototype.mapMssSegmentTimeline=function(){var t={},e=this.currentNode.parentNode.getElementsByTagName("c"),n=[],o=void 0,r=void 0,s=void 0,i=void 0,a=0;for(i=0;i<e.length;i++)o={},s=e[i].getAttribute("t"),o.tManifest=parseFloat(s),o.t=parseFloat(s),o.d=parseFloat(e[i].getAttribute("d")),0!==i||o.t||(o.t=0),i>0&&((r=n[n.length-1]).d||(r.tManifest?r.d=parseFloat(s)-parseFloat(r.tManifest):r.d=o.t-r.t),o.t||(r.tManifest?(o.tManifest=parseFloat(r.tManifest)+r.d,o.t=parseFloat(o.tManifest)):o.t=r.t+r.d)),a+=o.d,n.push(o);return t.S=n,t.S_asArray=n,t.duration=a/1e7,t},e.prototype.writeAttributesToList=function(e,n){for(var o=e.attributes,r=0;r<e.childNodes.length;r++)this.baseURL||"BaseURL"!=e.childNodes[r].nodeName||(this.baseURL=e.childNodes[r].firstChild.nodeValue),this.segmentBase||"SegmentBase"!=e.childNodes[r].nodeName||(this.segmentBase=e.childNodes[r]),this.segmentTemplate||"SegmentTemplate"!=e.childNodes[r].nodeName||(this.segmentTemplate=e.childNodes[r]),this.segmentList||"SegmentList"!=e.childNodes[r].nodeName||(this.segmentList=e.childNodes[r]);for(var s in o)n[o[s].nodeName]||(n[o[s].nodeName]=o[s].nodeValue);if(void 0!==n.Type){n.contentType=n.Type,n.mimeType={video:"video/mp4",audio:"audio/mp4",text:"application/mp4"}[n.contentType],n.bandwidth=n.Bitrate,n.width=n.MaxWidth,n.height=n.MaxHeight,n.lang=n.Language||"und";var i=n.Name?n.Name:n.Type;n.id=i+"_"+n.Index,"audio"===n.Type&&(n.audioSamplingRate=n.SamplingRate)}void 0!==n.Duration&&(n.durationInS=this.attributeList.Duration/1e7),null!==e.parentNode?this.buildAttributeList(e.parentNode,n):this.segmentInformation||this.createSegmentInformation(),t.prototype.writeAttributesToList.call(this,e,n)},e.prototype.getMimeType=function(){return this.attributeList.mimeType},e.prototype.hasMimeType=function(){return!!this.attributeList.mimeType},e.prototype.getContentType=function(){return this.attributeList.contentType},e.prototype.hasContentType=function(){return!!this.attributeList.contentType},e}(r.ManifestNode);e.QualityLevelNode=a},function(t,e,n){"use strict";var o=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);function o(){this.constructor=t}t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},r=n(22),s=function(t){function e(e,n,o,r,s,i){t.call(this,e,n,o,r,s),i&&(this.segmentTemplate=i,this.mediaTemplate=this.segmentTemplate.media,this.mediaTemplate=this.replace$Bandwidth$(this.mediaTemplate,this.bandwidth)),this.segmentTemplate.media&&(this.timelineItemList=this.segmentTemplate.SegmentTimeline),this.createFragmentUrlsFromTimeline(this.timelineItemList)}return o(e,t),e.prototype.createFragmentUrlsFromTimeline=function(t){for(var e=0;e<t.S.length;e++){var n=this.mediaTemplate;n=this.replace$Time$(n,t.S[e].t),this.mediaUrls.push(new r.MediaUrl(this.baseUrl,n,this.mimeType))}},e}(n(21).SegmentInformation);e.FragmentInformation=s},function(t,e,n){"use strict";var o=function(){return function(t,e,n){this.videoAdaptation=t,e&&(this.audioAdaptation=e),n&&(this.textAdaptation=n)}}();e.AllAdaptationSets=o},function(t,e,n){"use strict";var o=n(24),r=n(25),s=n(26);t.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++)for(var a=t[n].representationColl,u=0,l=a.length;u<l;u++){var d=a[u].attributeList,f=d.contentType||d.mimeType;switch(f=f.indexOf("video")>=0?"video":f.indexOf("audio")>=0?"audio":"text"){case"audio":e.push(new o(d));break;case"video":e.push(new r(d));break;default:e.push(new s(d))}}return e}},function(t,e,n){"use strict";var o=n(24),r=n(25),s=n(26);t.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++)for(var a=t[n].representationColl,u=0,l=a.length;u<l;u++){var d=a[u].attributeList,f=d.contentType||d.mimeType;switch(f=f.indexOf("video")>=0?"video":f.indexOf("audio")>=0?"audio":"text"){case"audio":e.push(new o(d));break;case"video":e.push(new r(d));break;default:e.push(new s(d))}e[u].protections=t[n].contentProtections.slice()}return e}},function(t,e){t.exports=l},function(t,e,n){"use strict";t.exports={isUTF16:function(t){var e,n,o,r,s=0,i=t&&t.length,a=null;if(i<2){if(t[0]>255)return!1}else{if(e=t[0],n=t[1],255===e&&254===n)return!0;if(254===e&&255===n)return!0;for(;s<i;s++){if(0===t[s]){a=s;break}if(t[s]>255)return!1}if(null===a)return!1;if(void 0!==(o=t[a+1])&&o>0&&o<128)return!0;if(void 0!==(r=t[a-1])&&r>0&&r<128)return!0}return!1}}},function(t,e,n){"use strict";function o(t,e){var n=void 0;return n=t.substr(0,e-1),t.length>e&&(n+=t.substr(e,t.length)),n}t.exports=function(t,e,n,r){for(var s=String(t),i=!0,a=1;i;)s.substr(0,a).match(e)?a++:s=o(s,a),a>s.length&&(i=!1);for(var u=s.split(""),l=0,d=t.length;l<d;l++)(l>=u.length||t[l]!==u[l])&&u.splice(l,0,n+t[l]+r);return u.join("")}},function(t,e,n){"use strict";t.exports=function(t,e){e()}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s){t.offlineController.getManifestFolderInfo(s,function(t,r){t?n(o.getError(o.e.manifests.INFO_FAILED,s),t):e(r)})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n){t.offlineController.getManifestsList(function(t,r){t?n(o.getError(o.e.manifests.LIST_LOADING_FAILED),t):e(r)})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s){t.offlineController.getManifestsListWithInfo(function(t,r){t?n(o.getError(o.e.manifests.LIST_LOADING_FAILED),t):e(r)},s)}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s){t.offlineController.getManifestInfo(s,function(r,i){r?n(o.getError(o.e.downloads._GENERAL),r):e({offlineLink:t.getOfflinePath(s)+i.manifest.name,persistent:i.persistent})})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s,i){t.offlineController.getManifestInfo(s,function(t,r){t?n(o.getError(o.e.manifests.INFO_FAILED,s),t):e(r)},i)}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s){t.offlineController.getManifestInfo(s,function(r,i){t.downloadsController.removePromise(s).then(function(){t.offlineController.removePromise(s).then(function(){t.subscribersController.unsubscribe(s),t.manifestController.removeFromCache(s),e(i)},function(t){n(o.getError(o.e.downloads.REMOVING_FAILED,s),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_FAILED,s),t)})})}},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(r,s){if(r)n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),r);else{for(var i=s.map(function(t){return t.manifestInfo.id}),a=[],u=0,l=i.length;u<l;u++)a.push(t.downloadsController.removePromise(i[u]));Promise.all(a).then(function(){t.offlineController.removeAllPromise().then(function(){t.subscribersController.unsubscribeAll(),t.manifestController.removeFromCacheAll(),e(s)},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_FAILED),t)})}})}},function(t,e,n){"use strict";var o=n(0),r=n(8);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(s,i){if(s)n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),s);else{var a=[],u=[];if(!i.length)return void n(o.getError(o.e.downloads.ALREADY_REMOVED_ALL_UNFINISHED));for(var l=0,d=i.length;l<d;l++){var f=i[l].status,c=i[l].manifestInfo.id;f!==r.FINISHED&&(u.push(c),a.push(t.downloadsController.removePromise(c)))}Promise.all(a).then(function(){for(var r=[],s=0,i=u.length;s<i;s++)r.push(t.offlineController.removePromise(u[s]));Promise.all(r).then(function(){t.subscribersController.unsubscribe(u),t.manifestController.removeFromCache(u),e(u)},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})},function(t){n(o.getError(o.e.downloads.REMOVING_ALL_UNFINISHED_FAILED),t)})}})}},function(t,e,n){"use strict";var o=n(1),r=n(0),s=n(28);t.exports=function(t,e,n,i,a){t.offlineController.getManifestInfo(a,function(t,i){if(t)n(r.getError(r.e.manifests.NOT_FOUND,a),t);else{var u=o.getSettings().settingsFolder+a+"/"+o.getSettings().stores.PERSISTENT+".json";s(u,function(t){t&&"ENOENT"!==t.code?n(r.getError(r.e.downloads.REMOVING_PERSISTENT_FAILED,a),t):e(i)})}})}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r,s){t.downloadsController.resume(r,s,e,n)}},function(t,e,n){"use strict";var o=n(1),r=n(0),s=n(12);t.exports=function(t,e,n,i,a,u){t.offlineController.getManifestInfo(a,function(t){t?n(r.getError(r.e.manifests.NOT_FOUND,a),t):new s(a,o.getSettings().stores.DATA,u).save().then(function(){e()},function(t){n(r.getError(r.e.downloads.SAVING_DATA_FAILED,a),t)})})}},function(t,e,n){"use strict";var o=n(11);t.exports=function(t){o(this,["id","contentType","bandwidth","remoteUrl","stats","localUrl"],t)}},function(t,e,n){"use strict";var o=n(1),r=n(0),s=n(12);t.exports=function(t,e,n,i,a,u){t.offlineController.getManifestInfo(a,function(t){t?n(r.getError(r.e.manifests.NOT_FOUND,a),t):new s(a,o.getSettings().stores.PERSISTENT,u).save().then(function(){e()},function(t){n(r.getError(r.e.downloads.SAVING_PERSISTENT_FAILED,a),t)})})}},function(t,e,n){"use strict";var o=n(0),r=n(27);t.exports=function(t,e,n,s,i,a,u){function l(){t.downloadsController.storage.getItem(i).then(function(r){r?n(o.getError(o.e.downloads.ALREADY_STARTED,i)):t.downloadsController.start(i,a,u,e,function(t){n(o.getError(o.e.downloads._GENERAL),t)})},function(t){n(o.getError(o.e.downloads._GENERAL),t)})}t.manifestController.getManifestById(i)?r(i,u).then(function(){l()},function(e){var r=(e=e||[])[1];e.length&&r?n(o.getError(o.e.manifests.FOLDER_ALREADY_EXISTS,i)):t.offlineController.getManifestDataFile(i,function(t){t?n(o.getError(o.e.manifests.FOLDER_ALREADY_EXISTS,i)):l()})}):n(o.getError(o.e.manifests.NOT_FOUND,i))}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.downloadsController.stop(r,e,n)}},function(t,e,n){"use strict";var o=n(0),r=n(8);t.exports=function(t,e,n){t.offlineController.getManifestsListWithInfo(function(s,i){if(s)n(o.getError(o.e.downloads.STOPPING_ALL_FAILED),s);else{for(var a=[],u=[],l=0,d=i.length;l<d;l++){var f=i[l].status,c=i[l].manifestInfo.id;f!==r.FINISHED&&(u.push(c),a.push(t.downloadsController.stopPromise(c,!0)))}u.length>0?Promise.all(a).then(function(){e(u)},function(t){n(o.getError(o.e.downloads.STOPPING_ALL_FAILED),t)}):n(o.getError(o.e.downloads.ALREADY_STOPPED_ALL))}})}},function(t,e,n){"use strict";var o=n(0),r=n(79);t.exports=function(t,e,n,s,i,a){"string"==typeof i?function(t,e,n,s,i,a){var u=t.manifestController.getManifestById(i),l=void 0,d=void 0,f=void 0;u?(f=[],l=new r(function(){return t.downloadsController.downloadStats.getStats(i)},t.processSubscriber,s,i,a),f.push(t.subscribersController.addSubscriber(l)),(d=new r(function(){return t.downloadsController.isDownloadFinishedAndSynced(i)},t.processSubscriber,s,i,a,!0)).onFinish(function(e){l.remove(),t.offlineController.getManifestInfo(i,function(t,n){e(t,n)})}),f.push(t.subscribersController.addSubscriber(d)),e(u.getJsonInfo(),f)):n(o.getError(o.e.manifests.NOT_FOUND,i))}(t,e,n,s,i,a):function(t,e,n,o,s,i){var a=void 0,u=void 0,l=void 0,d=s.sort().join(",");l=[],a=new r(function(){return t.downloadsController.downloadStats.getStats(s)},t.processSubscriber,o,d,i),l.push(t.subscribersController.addSubscriber(a)),(u=new r(function(){for(var e=!0,n=0,o=s.length;n<o;n++)e=e&&t.downloadsController.isDownloadFinishedAndSynced(s[n]);return e},t.processSubscriber,o,d,i,!0)).onFinish(function(e){a.remove();for(var n=[],o=0,r=s.length;o<r;o++)n.push(t.offlineController.getManifestInfoPromise(s[o]));Promise.all(n).then(function(t){e(null,t)},function(t){e(t)})}),l.push(t.subscribersController.addSubscriber(u)),e(null,l)}(t,e,0,s,i,a)}},function(t,e,n){"use strict";var o=n(9),r=n(6);function s(t,e,n,s,i,a){this._process=t,this._callback=e,this._manifestId=s,this._id=String(o.SnowflakeId.getUUID()),this._onceOnly=a,this._target=n,this.onInterval=function(){var t=this._process(),e=this;t&&(this._onceOnly?(this.remove(),"function"==typeof this._callbackOnFinish?this._callbackOnFinish(function(t,n){e._callback(e._id,t,n,e._target,!0)}):this._callback(this._id,null,t,e._target)):this._callback(this._id,null,t,e._target))},r.bindAll(this,"onInterval"),this._intervalTimer=setInterval(this.onInterval,i)}s.prototype.getId=function(){return this._id},s.prototype.getManifestId=function(){return this._manifestId},s.prototype.onFinish=function(t){this._callbackOnFinish=t},s.prototype.remove=function(){clearInterval(this._intervalTimer)},t.exports=s},function(t,e,n){"use strict";var o=n(0);t.exports=function(t,e,n,r,s){"string"==typeof s?function(t,e,n,r,s){t.manifestController.getManifestById(s)?(t.subscribersController.unsubscribe(s),e()):n(o.getError(o.e.manifests.NOT_FOUND,s))}(t,e,n,0,s):(t.subscribersController.unsubscribe(s),t.subscribersController.unsubscribe(s.sort().join(",")))}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r,s){t.downloadsController.updateDownloadFolder(r,s,e,n)}},function(t,e,n){"use strict";t.exports=function(t,e,n,o,r){t.subscribersController.removeSubscribersById(r),e()}},function(t,e,n){"use strict";var o=n(6),r=n(84),s=n(1),i=n(0),a=n(85),u=n(90),l=n(94),d=n(95),f=n(8),c=n(7),h=n(19),p=n(34),m=n(3),g=n(35),_=n(12),v=n(5);function E(t,e){this._manifestsDownloadOrder=[],this._manifestsDownloadOrderObj={},this._manifestController=t,this._offlineController=e,this.storage=new u,this._offlineController.setDownloadStorage(this.storage),this._names={downloadInProgress:"downloadInProgress",options:"options",maxDownloadInProgress:"maxDownloadInProgress"},this._STATS_TIME_GENERATION=1e3,this.downloadStats=new d(this.storage),o.bindAll(this,"_onDownloadEnd","_onDownloadError","isDownloadFinished")}E.prototype._addDownloads=function(t,e,n,o){var r=!0;for(this._prepareStartOptions(t,e,n,o);r;){var s=e.length?Math.round(n.length/e.length):1,i=e.length?Math.round(o.length/e.length):1;this._addNextItemToQueue(t,o,i),this._addNextItemToQueue(t,n,s),this._addNextItemToQueue(t,e),r=!!(o.length||e.length||n.length)}},E.prototype._addNextItemToQueue=function(t,e,n){var o=void 0;if(n||(n=1),e.length)for(;n>0;)(o=e.shift()).manifestId=t,this.storage.left.push(t,o),n--},E.prototype._downloadOrderAddManifest=function(t,e){return!this._downloadOrderManifestExists(t)&&(this._manifestsDownloadOrderObj[t]=!0,e?this._manifestsDownloadOrder.unshift(t):this._manifestsDownloadOrder.push(t),!0)},E.prototype._downloadOrderGetManifestId=function(t){return this._manifestsDownloadOrder[t]},E.prototype._indexOfManifest=function(t){return this._manifestsDownloadOrder.indexOf(t)},E.prototype._downloadOrderManifestExists=function(t){return this._manifestsDownloadOrderObj[t]},E.prototype._downloadOrderRemoveManifest=function(t){var e,n=!1,o=void 0;for(delete this._manifestsDownloadOrderObj[t],o=0,e=this._manifestsDownloadOrder.length;o<e;o++)if(this._manifestsDownloadOrder[o]===t){this._manifestsDownloadOrder.splice(o,1),n=!0;break}return n},E.prototype._finish=function(t,e,n){this.downloadStats.refresh(),this._downloadOrderRemoveManifest(t),this._manifestsDownloadOrder.length||this.downloadStats.stop(),this.storage.removeItem(t).then(e,n)},E.prototype._getDownloadHash=function(t){return t.remoteUrl+"-"+t.localUrl},E.prototype._markDownloadItem=function(t){var e=this,n=t.manifestId,o=e._getDownloadHash(t),r=[],s=void 0;t.events.removeListener("end",e._onDownloadEnd),t.events.removeListener("error",e._onDownloadError),1===e.storage.downloading.count(n)&&0===e.storage.left.count(n)&&(this.downloadStats.refresh(),s=!0),t.status===f.FINISHED?(e.storage.downloaded.push(n,t),r.push(this.storage.stores.DOWNLOADS.DOWNLOADED)):e.storage.errors.push(n,t),e.storage.downloading.removeItem(n,o),e.isDownloadFinished(n)&&(0===e.storage.errors.count(n)?e.storage.status.setItem(n,"status",f.FINISHED):e.storage.status.setItem(n,"status",f.ERROR),r.push(this.storage.stores.STATUS)),e.storage.sync(n,r).then(function(){e.storage.params.decrease(n,e._names.downloadInProgress),s?e._finish(n,function(){e.startQueue(),console.info("FINISHED",n)},function(){e.startQueue()}):e.startQueue()},function(t){console.error("ERROR",t)})},E.prototype._stopWithStatus=function(t,e,n,o,r){var s=this;s._downloadOrderRemoveManifest(t),s.storage.getItem(t).then(function(a){if(a){var u=s.storage.downloading.getKeys(t),l=void 0;console.info("STOPPING",t,u.length);for(var d=[],f=0,c=u.length;f<c;f++)(l=s.storage.downloading.getItem(t,u[f])).events.removeListener("end",s._onDownloadEnd),l.events.removeListener("error",s._onDownloadError),d.push(l.stopPromise());s.storage.status.setItem(t,"status",o),r&&s.storage.status.setItem(t,"details",r),d.push(s.storage.sync(t,[s.storage.stores.DOWNLOADS.DOWNLOADED,s.storage.stores.STATUS])),Promise.all(d).then(function(){s._finish(t,e,n)},function(e){n(i.getError(i.e.downloads.STOPPING_FAILED,t),e)})}else n(i.getError(i.e.downloads.ALREADY_STOPPED,t))},function(e){n(i.getError(i.e.downloads.STOPPING_FAILED,t),e)})},E.prototype._onDownloadError=function(t,e){console.error("ERROR",t.remoteUrl,e),this._markDownloadItem(t),(e===v.errors.NO_SPACE_LEFT_ERROR||s.getSettings().stopOnError)&&this._stopWithStatus(t.manifestId,function(){console.info("stopped")},function(t){console.info(t)},f.ERROR,e)},E.prototype._onDownloadEnd=function(t){this._markDownloadItem(t)},E.prototype._prepareStartOptions=function(t,e,n,o){var r=e.length+n.length+o.length;console.info("ADDING ->>> ",t+",",r,"fragments");var i={};this.storage.params.setItem(t,this._names.downloadInProgress,0);for(var a=void 0,u=s.getSettings().downloadingThreadsRules,l=0,d=u.items.length;l<d;l++)if(r<=u.items[l].max){i[u.threadName]=u.items[l].threads,a=u.items[l].files;break}this.storage.params.setItem(t,this._names.options,i),this.storage.params.setItem(t,this._names.maxDownloadInProgress,a),this._downloadOrderAddManifest(t)},E.prototype.isDownloadFinished=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)},E.prototype.isDownloadFinishedAndSynced=function(t){return!this.storage.left.count(t)&&!this.storage.downloading.count(t)&&!this.storage.keyExists(t)},E.prototype.getDownloading=function(t,e){var n=this.storage.downloading.getItems(t);if(!n)return null;for(var o in n)if(n.hasOwnProperty(o)){var r=n[o];if(m.normalize(r.localUrl)===m.normalize(e))return r}return null},E.prototype.waitForDownload=function(t,e){var n=void 0,o=void 0,r=function(t){t.events.removeListener("end",n),t.events.removeListener("error",o)};n=function(t){r(t),e()},o=function(t,n){r(t),e(n)},t.events.on("end",n),t.events.on("error",o)},E.prototype.performSeek=function(t,e,n){var o=void 0;if(o=this.getDownloading(t,e))this.waitForDownload(o,n);else{var r=this.storage.left.getItems(t);if(r){var s=r.findIndex(function(t){return m.normalize(t.localUrl)===m.normalize(e)});if(s>-1){var i=r.slice(0,s),a=r.slice(s);this.storage.left.clear(t),this.storage.left.concat(t,a),this.storage.left.concat(t,i),r=this.storage.left.getItems(t),this.startQueue(this._indexOfManifest(t),!0),(o=this.getDownloading(t,e))?this.waitForDownload(o,n):n("No download found")}else n("No download found")}else n("No download found")}},E.prototype.start=function(t,e,n,a,u,d,c){var g=this;this.downloadStats.start();var _=this._manifestController.getManifestById(t);if(_){var v=(e=e||{}).video||[],E=e.audio||[],R=e.text||[],y=_.getVideoRepresentations(),I=_.getAudioRepresentations(),w=_.getTextRepresentations(),S=m.resolve(s.getSettings().downloadsFolderPath);n&&(S=m.resolve(n));var T=m.resolve(S+"/"+t+"/"),N=_.getManifestUrl(),O=_.getManifestName();Promise.all([this._offlineController.getManifestInfoPromise(t,!0),this.storage.getItem(t),r(T)]).then(function(e){var n=e[0];if(!e[1]||g.isDownloadFinished(t)){n.manifest.video&&(v=o.union(v,n.manifest.video)),n.manifest.audio&&(E=o.union(E,n.manifest.audio)),n.manifest.text&&(R=o.union(R,n.manifest.text));for(var r=n.downloadedFiles||[],m={},D=0,b=r.length;D<b;D++)m[r[D].localUrl]=r[D];var A=function(t,e){var n=void 0,o=t.getElementsByTagName("MPD")[0];if(o)for(var r=0,s=o.childNodes.length;r<s;r++)if("BaseURL"===o.childNodes[r].nodeName){(n=o.childNodes[r].textContent).match(h.regexpProtocolRemove)||(n=p.joinPath(e,n));break}return n||(n=e),n}(_.manifestXML.xml,_.url_domain),L=l.getDownloadLinks(t,T,A,v,y,m),M=l.getDownloadLinks(t,T,A,E,I,m),P=l.getDownloadLinks(t,T,A,R,w,m),F=l.getAllLinks(t,T,A,v,y),C=l.getAllLinks(t,T,A,E,I),x=l.getAllLinks(t,T,A,R,w),U=F.concat(C,x);g.storage.createIfNotExists(t).then(function(){g.storage.manifest.setItem(t,"ts",(new Date).getTime()),g.storage.manifest.setItem(t,"url",N),g.storage.manifest.setItem(t,"name",O),g.storage.manifest.setItem(t,"video",v),g.storage.manifest.setItem(t,"audio",E),g.storage.manifest.setItem(t,"text",R),g.storage.manifest.setItem(t,"files",U),g.storage.manifest.setItem(t,"folder",S),g.storage.downloaded.clear(t),g.storage.downloaded.concat(t,r),g.storage.errors.clear(t),d?g.storage.status.setItem(t,"status",c):g.storage.status.setItem(t,"status",f.CREATED),Promise.all([g.storage.sync(t,[g.storage.stores.MANIFEST,g.storage.stores.STATUS]),g._manifestController.saveOriginalManifestOnceOnly(t),g._manifestController.saveManifestWithChosenRepresentations(t,{video:v,audio:E,text:R},T)]).then(function(){g._addDownloads(t,L,M,P),g._indexOfManifest(t)>s.getSettings().numberOfManifestsInParallel-1?g.storage.status.setItem(t,"status",f.QUEUED):g.storage.status.setItem(t,"status",f.STARTED),g.storage.status.setItem(t,"left",g.storage.left.count(t)),g.storage.sync(t,[g.storage.stores.DOWNLOADS.DOWNLOADED,g.storage.stores.STATUS]).then(function(){g.downloadStats.refresh(),g.isDownloadFinished(t)?(g.storage.status.setItem(t,"status",f.FINISHED),g.storage.sync(t,g.storage.stores.STATUS).then(function(){g._finish(t,a,u)},u)):(g.downloadStats.start(),g.startQueue(),a())},u)},u)},u)}else u(d?i.getError(i.e.downloads.ALREADY_RESUMED,t):i.getError(i.e.downloads.ALREADY_STARTED,t))})}else u(i.getError(i.e.manifests.NOT_FOUND,t))},E.prototype.resume=function(t,e,n,o){var r=this;this._offlineController.getManifestInfo(t,function(a,u){if(a)o(i.getError(i.e.downloads.RESUMING_FAILED,t),a);else{var l=u.manifest.folder;l||(l=m.resolve(s.getSettings().downloadsFolderPath)),r.start(t,e,l,n,o,!0,u.status)}})},E.prototype.updateDownloadFolder=function(t,e,n,o){Promise.all([new g(t,s.getSettings().stores.MANIFEST)]).then(function(r){var a=r[0];a?(a.folder=e,new _(t,s.getSettings().stores.MANIFEST,a).save().then(function(){n()},function(e){o(i.getError(i.e.downloads.SAVING_DATA_FAILED,t),e)})):o(i.getError(i.e.manifests.NOT_FOUND,t))},function(e){o(i.getError(i.e.downloads.UPDATE_DOWNLOAD_FOLDER_FAILED,t),e)})},E.prototype.stop=function(t,e,n){this._stopWithStatus(t,e,n,f.STOPPED)},E.prototype.stopPromise=function(t,e){var n=this;return new Promise(function(o,r){n.stop(t,o,function(t){if(t){if(e&&t.code===c.ERRORS.STOPPED)return void o();r(t)}else o()})})},E.prototype.removePromise=function(t){var e=this;return new Promise(function(n,o){e.stopPromise(t).then(function(){e.storage.removeItem(t).then(n,o)},function(r){r&&r.code===c.ERRORS.STOPPED?e.storage.removeItem(t).then(n,o):o(r)})})},E.prototype._addLinkToDownload=function(t,e){var n=Object.assign({},e),o=new a(n,this.storage.params.getItem(t,this._names.options)),r=this._getDownloadHash(e);return this.storage.downloading.setItem(t,r,o),this.storage.status.setItem(t,"left",this.storage.left.count(t)+this.storage.errors.count(t)),this.storage.sync(t,this.storage.stores.STATUS),o.events.on("end",this._onDownloadEnd),o.events.on("error",this._onDownloadError),o.start(),o},E.prototype.startQueue=function(t,e){var n,o=void 0,r=void 0;if(void 0===t&&(t=0),!(n=this._downloadOrderGetManifestId(t))||!this.isDownloadFinished(n))if(t>=s.getSettings().numberOfManifestsInParallel)n&&this.storage.status.setItem(n,"status",f.QUEUED);else if(this.storage.status.setItem(n,"status",f.STARTED),n)this.storage.params.getItem(n,this._names.downloadInProgress)<this.storage.params.getItem(n,this._names.maxDownloadInProgress)-1||e?((r=this.storage.left.shift(n))?(this.storage.params.increase(n,this._names.downloadInProgress),this._addLinkToDownload(n,r)):t++,this.startQueue(t)):s.getSettings().numberOfManifestsInParallel>1&&t<s.getSettings().numberOfManifestsInParallel&&(t++,this.startQueue(t));else{o=0;var i,a,u=void 0;for(u=0,i=(a=this.storage.getKeys()).length;u<i;u++)o+=this.storage.params.count(a[u],this._names.downloadInProgress);0===o&&this.downloadStats.stop()}},t.exports=E},function(t,e,n){"use strict";var o=n(13);t.exports=function(t){return new Promise(function(e,n){o(t,function(t){t?n(t):e()})})}},function(t,e,n){"use strict";var o=n(6),r=n(86),s=n(87),i=n(88),a=n(13),u=n(1),l=n(14).EventEmitter,d=n(8);function f(t,e){this._defaults={},this._defaults.threads=u.getSettings().downloadingThreadsRules.threads,this.status=d.CREATED,Object.assign(this,t),this._options=Object.assign(this._defaults,e),this._options.maxDownloadRetry=u.getSettings().MAX_ERRORS_DOWNLOAD_RETRY,this._options.maxDownloadChunkRetry=u.getSettings().MAX_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.maxDownloadChunkInternetRetry=u.getSettings().MAX_INTERNET_ERRORS_DOWNLOAD_CHUNK_RETRY,this._options.timeout=u.getSettings().times.DOWNLOAD_TIMEOUT,this._options.retryTimeout=u.getSettings().times.RETRY_TIMEOUT,this._options.useChunkedEncoding=u.getSettings().useChunkedEncoding,this._options.useHeadRequests=u.getSettings().useHeadRequests,this._options.noCache=u.getSettings().noCache,this.stats={available:0,downloaded:0,file_size:0,writeProgress:0},o.bindAll(this,"_onError","_onEnd","_onData","_updateStats","_attachEvents","_removeEvents","_removeEventsOnStop"),this.events=new l}f.prototype._attachEvents=function(){this._dl.on("error",this._onError),this._dl.on("end",this._onEnd),this._dl.on("data",this._onData)},f.prototype._createLocalPath=function(t){var e=this.localUrl.split("/");e=(e=e.slice(0,e.length-1)).join("/"),a(e,t)},f.prototype._onData=function(){this._updateStats()},f.prototype._onEnd=function(){this.status=d.FINISHED,this._updateStats(),this._removeEvents(),this.events.emit("end",this)},f.prototype._onError=function(t){this.status=d.ERROR;var e=(t=t||{}).message||"";this._removeEvents(),this._updateStats(),this.events.listeners("error").length&&this.events.emit("error",this,e)},f.prototype._onDomainError=function(t){var e=this,n=(t=t||{}).message||"";e._dl?"net::ERR_NETWORK_CHANGED"===n?e.stop(function(){e.start()}):e.stop(function(){e._onError(t)}):e._onError(t)},f.prototype._removeEvents=function(){"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd),this._dl.removeListener("data",this._onData))},f.prototype._removeEventsOnStop=function(){this._dl&&"function"==typeof this._dl.removeListener&&(this._dl.removeListener("error",this._onError),this._dl.removeListener("end",this._onEnd))},f.prototype._updateStats=function(){this.status===d.FINISHED?(this.stats.available=this._dl.file_size,this.stats.writeProgress=1):(this.stats.available=this._dl.available,this.stats.writeProgress=this._dl.writeProgress),this.stats.downloaded=this._dl.downloaded,this.stats.file_size=this._dl.file_size},f.prototype.start=function(){var t=this;this.status=d.STARTED,this._createLocalPath(function(e){if(e)t._onError(e);else{var n=r.create();n.on("error",function(e){var o="";e&&(o=e.code||e.message||""),"function"==typeof n.dispose&&n.dispose(),t._onDomainError({message:o})}),n.run(function(){t._dl=t.createDownloader(t.remoteUrl,t.localUrl,t._options),t._attachEvents(),t._dl.start()})}})},f.prototype.createDownloader=function(t,e,n){return this._options.useHeadRequests?new i(t,e,n):new s(t,e,n)},f.prototype.stop=function(t){var e=this;if(this.status=d.STOPPED,this._removeEventsOnStop(),"function"!=typeof t&&(t=function(){}),this._dl){var n=r.create();n.on("error",function(){t()}),n.run(function(){e._dl.on("error",function(){t()}),e._dl.on("end",function(){t()}),e._dl.stop()})}else t()},f.prototype.stopPromise=function(){var t=this;return new Promise(function(e){t.stop(function(){e()})})},t.exports=f},function(t,e){t.exports=require("domain")},function(t,e,n){"use strict";var o=n(4),r=n(2).net,s=n(14).EventEmitter,i=n(30),a=n(5);function u(t,e,n){this._url=t,this._destFile=e,this._options=n,this._resetValues()}i.inherits(u,s),u.prototype._reset=function(t){var e=this;t=t||function(){},e._closeStreamAndRequest(function(){e._resetValues(),t()})},u.prototype._resetValues=function(){this.available=0,this.downloaded=0,this.file_size=0,this.writeProgress=0},u.prototype._createFileStream=function(t){var e=this;if(this.fileStream)t();else{var n=this._destFile;e.fileStream=o.createWriteStream(n,{flags:"w"}),e.fileStream.on("error",t),e.fileStream.on("open",function(){e.fileStream=this,this.removeListener("error",t),this.on("error",function(t){"ENOSPC"===t.code?e.emit("error",{message:a.errors.NO_SPACE_LEFT_ERROR,data:t}):e._retry(a.errors.FILE_WRITING_ERROR,function(n){n||e.emit("error",{message:a.errors.FILE_WRITING_ERROR,data:t})})}),this.on("finish",function(){e.isDownloaded()?(e.writeProgress=1,e.emit("end")):e._retry(a.errors.CHUNK_SIZE_ERROR,function(t){t||e._closeStreamAndRequest(function(){e.emit("error",{message:a.errors.CHUNK_SIZE_ERROR})})})}),t()})}},u.prototype.isDownloaded=function(){return this.downloaded===this.file_size},u.prototype._retry=function(t,e){var n=this,o=void 0;this._errors=this._errors||{},this._errors[t]=this._errors[t]||0,this._errors[t]++,o=t===a.errors.INTERNET?this._options.maxDownloadChunkInternetRetry:this._options.maxDownloadRetry,this._errors[t]<=o?(n._timer&&clearTimeout(n._timer),e(!0),n._timer=setTimeout(function(){n._reset(function(){n.start()})},n._options.retryTimeout)):e(!1)},u.prototype._closeStreamAndRequest=function(t){var e=this,n=void 0;function o(){clearTimeout(n),e.fileStream&&(e.fileStream.destroy(),delete e.fileStream),delete e._req,t()}this._req&&this._req.removeAllListeners(),this.fileStream&&this.fileStream.removeAllListeners(),this._req&&(this._req.abort(),this._req.timeoutTimer&&(clearTimeout(this._req.timeoutTimer),this._req.timeoutTimer=null)),this.fileStream?(n=setTimeout(function(){o()},300),this.fileStream.end(),this.fileStream.close(o)):(delete this._req,t())},u.prototype.start=function(){var t=this,e={timeout:this._options.timeout,url:this._url};return this._options.noCache&&(e.headers={"Cache-Control":"no-cache"}),t._createFileStream(function(n){n?t._retry(a.errors.FILE_CREATING_ERROR,function(e){e||t._closeStreamAndRequest(function(){t.emit("error",{message:a.errors.FILE_CREATING_ERROR})})}):(e.headers=e.headers||{},t._req=r.request(e),t._req.on("response",function(e){e.on("error",function(e){console.error("ERROR ("+t._url+") :"+e),"ESOCKETTIMEDOUT"===e.code||"ENOTFOUND"===e.code||"ETIMEDOUT"===e.code?t._retry(a.errors.INTERNET,function(n){n||t._closeStreamAndRequest(function(){t.emit("error",{message:a.errors.TIMEOUT,data:e})})}):t._retry(a.errors.INTERNET,function(n){n||t._closeStreamAndRequest(function(){t.emit("error",{message:a.errors.CHUNK_ERROR,data:e})})})}),e&&e.statusCode>=400?t._retry(a.errors.INTERNET,function(n){n||t._closeStreamAndRequest(function(){console.error("HTTP DOWNLOAD ERROR url: "+t._url+", statusCode: "+e.statusCode),t.emit("error",{message:a.errors.CHUNK_ERROR,data:e})})}):(t._headers=e.headers,t.file_size=Number(t._headers["content-length"]),e.on("data",function(n){200!==e.statusCode&&206!==e.statusCode||(t.available+=n.length,t.downloaded+=n.length)}),e.pipe(t.fileStream))}),t._req.end())}),this._promise},u.prototype.stop=function(){var t=this;this._reset(function(){t.emit("error",{message:a.errors.ABORTED})})},t.exports=u},function(t,e,n){"use strict";var o=n(4),r=n(2).net,s=n(14).EventEmitter,i=n(30),a=n(5),u=n(89);function l(t,e,n){this._url=t,this._destFile=e,this._options=n,this._resetValues()}i.inherits(l,s),l.prototype._calculateChunksNumber=function(t){for(var e=0,n=this._options.threads.length;e<n;e++)if(t<1048576*this._options.threads[e].size)return this._options.threads[e].number;return 1},l.prototype._concatChunks=function(){var t=this,e=500;function n(){t.writeProgress=t._chunks.reduce(function(t,e){return t+e.writeProgress},0)/t._chunksNumber,t.emit("data")}function r(){return o.createWriteStream(t._chunks[0].destFile,{flags:"a"})}function s(e,o){t._chunks[o].writeProgress=e.bytesWritten/t._chunks[o].available,t._chunks[o].writeProgress>1&&(t._chunks[o].writeProgress=1),n()}t._chunks[0].writeProgress=1,t._chunks.length>1?function i(a,u){var l=t._chunks[u];if(l){var d=setInterval(function(){s(a,u)},e),f=o.createReadStream(l.destFile);f.pipe(a),a.on("close",function(){clearInterval(d),s(a,u),a.removeAllListeners(),f.unpipe(a),f.destroy(),o.unlink(l.destFile,function(e){e?t.emit("error",e):(a.destroy(),i(r(),u+1))})})}else n(),a.removeAllListeners(),a.destroy(),o.rename(t._chunks[0].destFile,t._destFile,function(e){e?t.emit("error",e):t.emit("end")})}(r(),1):(n(),t.emit("end"))},l.prototype._initChunk=function(t){var e={};e.bytesRangeNotAvailable=this._bytesRangeNotAvailable,e.destFile=this._destFile,e.maxDownloadRetry=this._options.maxDownloadChunkRetry,e.maxDownloadInternetRetry=this._options.maxDownloadChunkInternetRetry,e.timeout=this._options.timeout,e.retryTimeout=this._options.retryTimeout,e.useChunkedEncoding=this._options.useChunkedEncoding;var n=this.file_size;if(this._chunksNumber>1){var o=parseInt(n/this._chunksNumber,10);e.startPosition=t*o,e.multiChunks=!0,t===this._chunksNumber-1?e.endPosition=n-1:e.endPosition=e.startPosition+o-1}else e.startPosition=0,e.endPosition=n-1;var r=new u(this._url,e);r.events.on("download",this._onChunkDownload.bind(this)),this._chunks.push(r)},l.prototype._onDownloadFailure=function(t,e){if(this._promises=null,e){for(var n=!1,o=0,r=t.length;o<r;o++)if(t[o]&&t[o]===a.errors.NO_SPACE_LEFT_ERROR){n=!0;break}n&&(t={message:a.errors.NO_SPACE_LEFT_ERROR}),this.emit("error",t)}else this._errors=this._errors||0,this._errors++,this._errors<=this._options.maxDownloadRetry?this._retryDownload():this.emit("error",t)},l.prototype._onDownloadSuccess=function(t){var e=void 0,n=void 0;this._promises=null;for(var o=0,r=(t=t||[]).length;o<r;o++)t[o]&&(t[o]!==a.errors.ABORTED&&t[o]!==a.errors.NO_SPACE_LEFT_ERROR||(e=!0),n=!0);n?this._onDownloadFailure(t,e):this._concatChunks()},l.prototype._onChunkDownload=function(t){this.downloaded+=t,this.available=this._chunks.reduce(function(t,e){return t+e.available},0),this.emit("data")},l.prototype._retryDownload=function(){this._resetValues(),this.start()},l.prototype._resetValues=function(){this.available=0,this.downloaded=0,this.progress=0,this.file_size=0,this.writeProgress=0,this._chunks=[]},l.prototype._startChunks=function(){for(var t=[],e=0,n=this._chunks.length;e<n;e++)t.push(this._chunks[e].start());this._promises=t,Promise.all(this._promises).then(this._onDownloadSuccess.bind(this),this._onDownloadFailure.bind(this))},l.prototype._startAllChunks=function(){for(var t=0,e=this._chunksNumber;t<e;t++)this._initChunk(t);this._startChunks()},l.prototype.start=function(){var t=this,e=Object.assign({url:this._url,method:"HEAD"},a.defaultOptions);this._options.noCache&&(e.headers=e.headers||{},e.headers["Cache-Control"]="no-cache");var n=r.request(e);n.chunkedEncoding=this._options.useChunkedEncoding,n.on("response",function(e){if(e&&e.statusCode>=400){var n=e.statusMessage;if(n)return void t._onDownloadFailure(n,!1)}e.on("error",function(e){e&&t._onDownloadFailure(e,!1)}),t._headers=e.headers,t.file_size=Number(t._headers["content-length"]),t._chunksNumber=t._calculateChunksNumber(t.file_size),a.checkForLocalFile(t._destFile,function(e,n){e?n===t.file_size?t.emit("end"):n>t.file_size?(o.unlink(t._destFile,function(t){if(t)throw t}),t._startAllChunks()):n<t.file_size&&t._chunksNumber>1?(o.unlink(t._destFile,function(t){if(t)throw t}),t._startAllChunks()):t._startAllChunks():t._startAllChunks()})}),n.end()},l.prototype.stop=function(){for(var t=[],e=0,n=this._chunks.length;e<n;e++)this._chunks[e].stop(),this._chunks[e]._promise&&t.push(this._chunks[e]._promise);function o(){this.emit("end","")}this._promises||Promise.all(t).then(o.bind(this),o.bind(this))},t.exports=l},function(t,e,n){"use strict";var o=n(5),r=n(4),s=n(2).net,i=n(14).EventEmitter;function a(t,e){var n=this;return this.url=t,this.options=e,this.endPosition=e.endPosition,this.startPosition=e.startPosition,this.bytesRangeNotAvailable=e.bytesRangeNotAvailable,this.reset(),this.events=new i,this._promise=new Promise(function(t,e){n.resolve=t,n.reject=e}),this}a.prototype._retry=function(t,e){var n=this,r=void 0;this._errors=this._errors||{},this._errors[t]=this._errors[t]||0,this._errors[t]++,r=t===o.errors.INTERNET?this.options.maxDownloadInternetRetry:this.options.maxDownloadRetry,this._errors[t]<=r?(n._timer&&clearTimeout(n._timer),e(!0),n._timer=setTimeout(function(){n.reset(function(){n.start()})},n.options.retryTimeout)):e(!1)},a.prototype.createFileStream=function(t){var e=this;if(this.fileStream)t();else{var n=this.options.destFile;this.options.multiChunks&&(n=n+"."+this.startPosition+"."+this.endPosition),o.checkForLocalFile(n,function(s,i){e.destFile=n,s&&i<=e.endPosition-e.startPosition&&(e.resumeFile=s,e.available=i,e.offsetStartPosition=i),e.fileStream=r.createWriteStream(n,{flags:e.resumeFile?"a":"w"}),e.fileStream.on("error",t),e.fileStream.on("open",function(){e.fileStream=this,this.removeListener("error",t),this.on("error",function(t){"ENOSPC"===t.code?e.resolve(o.errors.NO_SPACE_LEFT_ERROR,t):e._retry(o.errors.FILE_WRITING_ERROR,function(n){n||e.resolve(o.errors.FILE_WRITING_ERROR,t)})}),this.on("finish",function(){e.isDownloaded()?e.closeStreamAndRequest(e.resolve):e._retry(o.errors.CHUNK_SIZE_ERROR,function(t){t||e.closeStreamAndRequest(function(){e.resolve(o.errors.CHUNK_SIZE_ERROR)})})}),t()})})}},a.prototype.isDownloaded=function(){return this.endPosition-this.startPosition-this.offsetStartPosition+1===this.downloaded},a.prototype.start=function(){var t=this,e={timeout:this.options.timeout,url:this.url};return t.createFileStream(function(n){n?t._retry(o.errors.FILE_CREATING_ERROR,function(e){e||t.closeStreamAndRequest(function(){t.resolve(o.errors.FILE_CREATING_ERROR,n)})}):(e.headers=e.headers||{},t.bytesRangeNotAvailable||(e.headers.range="bytes="+(t.startPosition+t.offsetStartPosition)+"-"+t.endPosition),t._req=s.request(e),t._req.chunkedEncoding=t.options.useChunkedEncoding,t._req.on("response",function(e){e.on("error",function(e){"ESOCKETTIMEDOUT"===e.code||"ENOTFOUND"===e.code||"ETIMEDOUT"===e.code?t._retry(o.errors.INTERNET,function(n){n||t.closeStreamAndRequest(function(){t.resolve(o.errors.TIMEOUT,e)})}):t.closeStreamAndRequest(function(){t.resolve(o.errors.CHUNK_ERROR)})}),e.on("data",function(n){200!==e.statusCode&&206!==e.statusCode||(t.available+=n.length,t.downloaded+=n.length,t.events.emit("download",n.length))}),e.pipe(t.fileStream)}),t._req.end())}),this._promise},a.prototype.closeStreamAndRequest=function(t){var e=this,n=void 0;function o(){clearTimeout(n),e.fileStream&&(e.fileStream.destroy(),delete e.fileStream),delete e._req,t()}this._req&&this._req.removeAllListeners(),this.fileStream&&this.fileStream.removeAllListeners(),this._req&&(this._req.abort(),this._req.timeoutTimer&&(clearTimeout(this._req.timeoutTimer),this._req.timeoutTimer=null)),this.fileStream?(n=setTimeout(function(){o()},300),this.fileStream.end(),this.fileStream.close(o)):(delete this._req,t())},a.prototype.reset=function(t){var e=this;t=t||function(){},e.closeStreamAndRequest(function(){e.offsetStartPosition=0,e.available=0,e.downloaded=0,e.writeProgress=0,e.resumeFile=!1,t()})},a.prototype.stop=function(){var t=this;this.reset(function(){t.resolve(o.errors.ABORTED)})},t.exports=a},function(t,e,n){"use strict";var o=n(6),r=n(1),s=n(31),i=n(91),a=n(12),u=n(33),l=n(92),d=n(93);function f(){this.stores=r.getSettings().stores,this._items={},this._syncItems=[],this._FLUSH_TIME=50,this._flushThrottled=o.throttle(this._flush,this._FLUSH_TIME,{leading:!1}),this._createDummyStorageBridge()}f.prototype._createArrayStorage=function(t,e){this[e]||this._createArrayStorageBridge(e),this._items[t][e]=new s},f.prototype._createArrayStorageBridge=function(t){this[t]=new i(this,t)},f.prototype._createDummyStorageBridge=function(){this._createArrayStorageBridge(this.stores.DOWNLOADS.LEFT),this._createArrayStorageBridge(this.stores.DOWNLOADS.DOWNLOADED),this._createStorageBridge(this.stores.DOWNLOADS.DOWNLOADING),this._createArrayStorageBridge(this.stores.DOWNLOADS.ERRORS),this._createStorageBridge(this.stores.PARAMS),this._createStorageBridge(this.stores.MANIFEST),this._createStorageBridge(this.stores.STATUS)},f.prototype._createStorage=function(t,e){this[e]||this._createStorageBridge(e),this._items[t][e]=new u},f.prototype._createStorageBridge=function(t){this[t]=new l(this,t)},f.prototype._flush=function(){var t,e=this,n=this._syncItems.splice(0,this._syncItems.length),o=void 0,r=void 0,s=void 0,i=void 0,u=void 0,l=void 0,d=void 0,f=void 0,c=void 0;function h(t,n){return e._items[t]&&e._items[t][n]?e._items[t][n].getItems():[]}for(c={},s=0,t=n.length;s<t;s++)for(c[(i=n[s]).manifestId]=c[i.manifestId]||{},u=0,l=i.storageKeys.length;u<l;u++)c[i.manifestId][i.storageKeys[u]]=!0;for(d in r=[],c)for(f in c[d])try{o=new a(d,f,h(d,f)),r.push(o.save())}catch(t){console.error("ERROR",f)}Promise.all(r).then(function(){var t,e=void 0;for(e=0,t=n.length;e<t;e++)n[e].resolve()},function(){var t,e=void 0;for(e=0,t=n.length;e<t;e++)n[e].reject()})},f.prototype._getAllStorageKeys=function(t){var e=[];for(var n in t=t||this.stores)t.hasOwnProperty(n)&&("string"==typeof t[n]?n!==this.stores.PARAMS&&e.push(t[n]):e=e.concat(this._getAllStorageKeys(t[n])));return e},f.prototype._itemAction=function(t,e,n){var o,r=[],s=void 0;for(s=3,o=arguments.length;s<o;s++)r.push(arguments[s]);return this._items[n]&&this._items[n][t]&&this._items[n][t][e]?this._items[n][t][e].apply(this._items[n][t],r):void(this._items[n]&&console.error("ERROR",n,t,e,r))},f.prototype.clear=function(t,e){var n=this;return new Promise(function(o,r){if(e=e||n._getAllStorageKeys(),n._items[t])for(var s=0,i=e.length;s<i;s++){var a=n._items[t][e[s]];a&&a.clear()}delete n._items[t],n.sync(t,e).then(o,r)})},f.prototype.create=function(t){var e=this;return new Promise(function(n,o){e._items[t]={},e._createArrayStorage(t,e.stores.DOWNLOADS.LEFT),e._createArrayStorage(t,e.stores.DOWNLOADS.DOWNLOADED),e._createStorage(t,e.stores.DOWNLOADS.DOWNLOADING),e._createArrayStorage(t,e.stores.DOWNLOADS.ERRORS),e._createStorage(t,e.stores.PARAMS),e._createStorage(t,e.stores.MANIFEST),e._createStorage(t,e.stores.STATUS),e.sync(t,[e.stores.DOWNLOADS.DOWNLOADED,e.stores.MANIFEST,e.stores.STATUS]).then(n,o)})},f.prototype.createIfNotExists=function(t){var e=this;return new Promise(function(n,o){e.getItem(t).then(function(r){r?n():e.create(t).then(n,o)},o)})},f.prototype.getItem=function(t){var e=this;return new Promise(function(n){n(e._items[t])})},f.prototype.getKeys=function(){return Object.keys(this._items)},f.prototype.keyExists=function(t){return!!this._items[t]},f.prototype.removeItem=function(t){var e=this;return new Promise(function(n){delete e._items[t],n()})},f.prototype.sync=function(t,e){var n=this;return new Promise(function(o,s){void 0!==e?("string"==typeof e&&(e=[e]),r.getSettings().saveToDisk?(n._syncItems.push(new d(o,s,t,e)),n._flushThrottled()):o()):s("Storage key is missing")})},f.prototype.syncAll=function(t){var e=this;return new Promise(function(n,o){if(r.getSettings().saveToDisk){var s=e._getAllStorageKeys();e._syncItems.push(new d(n,o,t,s)),e._flushThrottled()}else n()})},t.exports=f},function(t,e,n){"use strict";var o=n(31),r=n(32);t.exports=function(t,e){this._parent=t,this._storageKey=e,r(this,o)}},function(t,e,n){"use strict";var o=n(33),r=n(32);t.exports=function(t,e){this._parent=t,this._storageKey=e,r(this,o)}},function(t,e,n){"use strict";t.exports=function(t,e,n,o){this.resolve=t,this.reject=e,this.manifestId=n,this.storageKeys=o}},function(t,e,n){"use strict";var o=n(19),r=n(34),s={getAllLinks:function(t,e,n,o,r){return s.getDownloadLinks(t,e,n,o,r)},getDownloadLinks:function(t,e,n,i,a,u){var l,d=s.getChosenRepresentations(i,a),f=void 0,c=void 0,h=void 0,p=void 0,m=void 0,g=void 0,_=void 0,v=void 0,E=void 0,R=void 0,y=void 0,I=void 0,w=void 0;for(v=[],u=u||{},p=0,l=d.length;p<l;p++)for(c=d[p].attributeList.mimeType,f=+d[p].attributeList.bandwidth,c=0===c.indexOf("video")?"video":0===c.indexOf("audio")?"audio":"text",y=(w=d[p].segmentInformation).mediaUrls,m=w.representationID,g=0,_=y.length;g<_;g++)(E=y[g].mediaFile)!==(R=(R=(R=y[g].baseURL).replace(/\.\.\//g,"")).replace(/\.\./g,""))&&n!==R||(R=""),R.match(o.regexpProtocolRemove)?(I=r.joinPathWithFile(R,E),h=r.joinPathWithFile(e,R.replace(o.regexpProtocolRemove,""),E)):(I=r.joinPathWithFile(n,R,E),h=r.joinPathWithFile(e,R,E)),u[h]&&(u[h]||u[h].remoteUrl===I)||(v[g]||(v[g]=[]),v[g].push({id:m,bandwidth:f,contentType:c,remoteUrl:I,localUrl:h}));return v.reduce(function(t,e){return t.concat(e)},[])},getChosenRepresentations:function(t,e){var n=[],o={};t=t||[],e=e||[];for(var r=0,s=t.length;r<s;r++)o[String(t[r])]=!0;for(var i=0,a=e.length;i<a;i++)for(var u=e[i].representationColl,l=0,d=u.length;l<d;l++){var f=u[l];o[String(f.attributeList.id)]&&n.push(f)}return n}};t.exports=s},function(t,e,n){"use strict";var o=n(6);function r(t){this._storage=t,this._stats={},this._statsPrevious={},this._STATS_TIME_GENERATION=1e3,o.bindAll(this,"_generate")}r.prototype._convertToBytes=function(t,e,n,o){return n=void 0!==n?n:e,o=void 0!==o?o:e,t<1e5?this._convertToKB(t,e):t<1073741824?this._convertToMB(t,n):this._convertToGB(t,o)},r.prototype._convertToKB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1024)/n+"kB"},r.prototype._convertToMB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1048576)/n+"MB"},r.prototype._convertToGB=function(t,e){e=void 0!==e?e:0;var n=Math.pow(10,e);return Math.round(t*n/1073741824)/n+"GB"},r.prototype._clearSpeed=function(){for(var t=Object.keys(this._stats)||[],e=0,n=t.length;e<n;e++){var o=t[e];!this._storage.keyExists(o)&&this._stats[o]&&this._stats[o].speed&&(this._stats[o].speed=0,this._stats[o].speedBytes=this._convertToBytes(this._stats[o].speed,3,2))}},r.prototype._generate=function(t){var e={},n=this._storage.getKeys();function r(t){for(var e=0,n=0,o=t.length;n<o;n++){e+=t[n].bandwidth||1}return e}function s(t,e){var n=0;for(var o in t)if(t.hasOwnProperty(o)){var r=t[o];n+=(e?r.stats.available/(r.stats.file_size||1):1)*(r.bandwidth||1)}return n}function i(t){var e=[];for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];e.push(o)}return e}this._clearSpeed();var a={downloading:0,downloaded:0,available:0,left:0,downloadingAvailableBytes:0,downloading_file_size:0,downloadingBytes:0,downloadedBytes:0,availableBytes:0,writeProgress:0,writeProgressDownloading:0,writeProgressDownloaded:0,errors:0,progress:0,speed:0,status:""},u=(new Date).getTime();this._statsTime||(this._statsTime=u);for(var l=0,d=n.length;l<d;l++){var f=n[l];e[f]=o.clone(a),e[f].left=this._storage.left.count(f),e[f].leftI=this._storage.left.getItems(f),e[f].errors=this._storage.errors.count(f),e[f].errorsI=this._storage.errors.getItems(f);var c=this._storage.downloading.getKeys(f);e[f].downloading=c.length,e[f].downloadingI=this._storage.downloading.getItems(f);for(var h=c.length,p=0,m=c.length;p<m;p++){var g=this._storage.downloading.getItem(f,c[p]);e[f].downloadingBytes+=g.stats.downloaded,e[f].downloading_file_size+=g.stats.file_size,e[f].downloadingAvailableBytes+=g.stats.available,e[f].writeProgressDownloading+=g.stats.writeProgress}c=this._storage.downloaded.getItems(f),e[f].downloaded=c.length,e[f].downloadedI=c;for(var _=c.length,v=0,E=c.length;v<E;v++){var R=c[v];e[f].downloadedBytes+=R.stats.downloaded,e[f].writeProgressDownloaded+=R.stats.writeProgress}e[f].writeProgressDownloading=e[f].writeProgressDownloading*(e[f].downloadingAvailableBytes/(e[f].downloadedBytes+e[f].downloading_file_size)||1),e[f].writeProgressDownloading=e[f].writeProgressDownloading/(h||1),e[f].writeProgressDownloaded=e[f].writeProgressDownloaded*(e[f].downloadedBytes/(e[f].downloadedBytes+e[f].downloading_file_size)||1),e[f].writeProgressDownloaded=e[f].writeProgressDownloaded/(_||1),e[f].writeProgress=e[f].writeProgressDownloading+e[f].writeProgressDownloaded;var y=this._getDiff("downloadingBytes",f,e,this._statsPrevious);y=1e3*(y+=this._getDiff("downloadedBytes",f,e,this._statsPrevious))/(u-this._statsTime||1),e[f].speed=y,e[f].status=this._storage.status.getItem(f,"status"),e[f].details=this._storage.status.getItem(f,"details");var I=r(e[f].leftI),w=r(e[f].downloadedI),S=s(e[f].downloadingI),T=s(e[f].downloadingI,!0),N=I+w+S+s(e[f].errorsI);e[f].progress=(w+T)/(N||1),e[f].progress=.9*e[f].progress,e[f].progress+=.1*e[f].writeProgress,e[f].downloadedBytesTotal=Math.round(1e4*e[f].progress)/100,e[f].downloadedBytesTotal+="%";var O=function(t,e){return t[e.id]||(t[e.id]=[]),t[e.id].push(e),t},D=e[f].downloadedI.reduce(O,{}),b=i(e[f].downloadingI).reduce(O,{}),A=e[f].leftI.reduce(O,{}),L=i(e[f].errorsI).reduce(O,{}),M=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]||(t[n]=[]),t[n]=t[n].concat(e[n]));return t},P={};M(P,D),M(P,b),M(P,A),M(P,L);var F={},C=void 0;for(C in P)P.hasOwnProperty(C)&&(F[C]=s(D[C])/(s(P[C])||1));var x={};for(C in F)F.hasOwnProperty(C)&&(x[C]=Math.round(1e4*F[C])/100+"%");e[f].progressById=F,e[f].progressByIdPercent=x}for(var U={},k=0,B=n.length;k<B;k++){var q=n[k];U[q]={};var W=e[q].downloadedBytes+e[q].downloadingAvailableBytes;U[q].progress=e[q].progress,U[q].progressPercentage=e[q].downloadedBytesTotal,U[q].progressById=e[q].progressById,U[q].progressByIdPercent=e[q].progressByIdPercent,U[q].downloadedBytesTotal=this._convertToBytes(W,1,2,2),U[q].downloaded=e[q].downloaded,U[q].left=e[q].left,U[q].errors=e[q].errors,e[q].speed<0&&(e[q].speed=0),U[q].speed=e[q].speed,U[q].speedBytes=this._convertToBytes(e[q].speed,3,2),U[q].status=e[q].status,U[q].details=e[q].details}for(var G in U)U.hasOwnProperty(G)&&(this._stats[G]=U[G]);if(!t)for(var H in this._statsTime=u,e)e.hasOwnProperty(H)&&(this._statsPrevious[H]=e[H])},r.prototype._getDiff=function(t,e,n,o){return(n[e]&&n[e][t]||0)-(o[e]&&o[e][t]||0)},r.prototype.getStats=function(t){var e=void 0;if(this._stats)if("string"==typeof t)e=this._stats[t];else{e=[];for(var n=0,o=t.length;n<o;n++){var r=this._stats[t[n]];r&&e.push(r)}}return e},r.prototype.refresh=function(){this._generate(!0)},r.prototype.start=function(){this._interval||(this._interval=setInterval(this._generate,this._STATS_TIME_GENERATION),this._generate())},r.prototype.stop=function(){clearInterval(this._interval),this._interval=null,this._generate(),this._statsPrevious={}},t.exports=r},function(t,e,n){"use strict";var o=n(10).XMLSerializer,r=n(1),s=n(97),i=n(5),a=n(98),u=n(0);function l(){this._manifests={}}l.prototype.cacheManifest=function(t){this._manifests[t.id]=t},l.prototype.getManifests=function(t){var e=void 0;if(void 0===t)e=this._manifests;else if("number"==typeof t||"string"==typeof t)e=[this._manifests[String(t)]];else{e=[];for(var n=0,o=t.length;n<o;n++)this._manifests[t[n]]&&e.push(this._manifests[t[n]])}return e},l.prototype.getManifestById=function(t){if("number"==typeof t||"string"==typeof t)return this._manifests[String(t)]},l.prototype.getManifestsInfo=function(t){for(var e=[],n=this.getManifests(t),o=0,r=n.length;o<r;o++)e.push(n[o].getJsonInfo());return e},l.prototype.getOriginalManifestLocalPath=function(t){return r.getSettings().settingsFolder+t+"/"},l.prototype.getManifestInfoById=function(t){var e=this.getManifestById(t);if(e)return e.getJsonInfo()},l.prototype.removeFromCache=function(t){"number"!=typeof t&&"string"!=typeof t||(t=[String(t)]);for(var e=0,n=(t=t||[]).length;e<n;e++)delete this._manifests[t[e]]},l.prototype.removeFromCacheAll=function(){this._manifests=[]},l.prototype.saveOriginalManifestOnceOnly=function(t){var e=this.getOriginalManifestLocalPath(t),n=this;return new Promise(function(r,s){var l=n.getManifestById(t);l?i.checkForLocalFile(e+l.getManifestName(),function(t){if(t)r();else{var n=new o,i=void 0;try{i=n.serializeToString(l.getManifestXML())}catch(t){return void s(t)}a(e,l.getManifestName(),i,function(t){t?s(t):r()})}}):s(u.getError(u.e.manifests.NOT_FOUND,t))})},l.prototype.saveManifestWithChosenRepresentations=function(t,e,n){var o=n,r=this;return new Promise(function(n,i){var l=r.getManifestById(t);if(l){var d=void 0;try{d=s(l,e)}catch(t){return void i(t)}a(o,l.getManifestName(),d,function(t){t?i(t):n()})}else i(u.getError(u.e.manifests.NOT_FOUND,t))})},t.exports=l},function(t,e,n){"use strict";var o=n(19),r=n(15).Manifest,s=n(10).XMLSerializer;function i(t){return-1!==t.indexOf("video")?"video":-1!==t.indexOf("audio")?"audio":"text"}t.exports=function(t,e){var n=t.id,a=new s,u=t.getManifestUrl(),l=a.serializeToString(t.getManifestXML());(t=new r(n)).loadFromStr(l,u);for(var d=e.video,f=e.audio,c=e.text,h={video:{}},p=0,m=d.length;p<m;p++)h.video[d[p]]=!0;h.audio={};for(var g=0,_=f.length;g<_;g++)h.audio[f[g]]=!0;h.text={};for(var v=0,E=c.length;v<E;v++)h.text[c[v]]=!0;function R(t){for(var e=0,n=t.length;e<n;e++)for(var o=0,r=t[e].representationColl.length;o<r;o++){var s=t[e].representationColl[o].attributeList.id,a=i(t[e].representationColl[o].attributeList.mimeType);h[a][s]&&t[e].representationColl[o].markNodeForDownload(!0)}}function y(t){for(var e=0,n=t.length;e<n;e++){var r=t[e].currentNode.getElementsByTagName("BaseURL")[0];r&&r.textContent.match(o.regexpProtocolRemove)&&(r.textContent=r.textContent.replace(o.regexpProtocolRemove,""))}}return R(t.getVideoRepresentations()),R(t.getAudioRepresentations()),R(t.getTextRepresentations()),y(t.getVideoRepresentations()),y(t.getAudioRepresentations()),y(t.getTextRepresentations()),t.removeNode(),a.serializeToString(t.getManifestXML())}},function(t,e,n){"use strict";var o=n(13),r=n(4),s=n(3);t.exports=function(t,e,n,i){o(t,function(o){if(o)i(o);else{var a=s.resolve(t+"/"+e);r.writeFile(a,n,"utf-8",i)}})}},function(t,e,n){"use strict";var o=n(3),r=n(100),s=n(28),i=n(1),a=n(35),u=n(101),l=n(15).Manifest,d=n(8);function f(t){this._manifestController=t}f.prototype.getManifestsList=function(t){u(i.getSettings().settingsFolder,!0,!1).then(function(e){for(var n=[],o=0,r=e.length;o<r;o++)n.push(e[o]);t(null,n)},function(e){t(e)})},f.prototype.getManifestsListWithInfo=function(t,e){var n=this;this.getManifestsList(function(o,r){if(o)t(o);else{for(var s=[],i=0,a=r.length;i<a;i++)s.push(n.getManifestInfoPromise(r[i],e));Promise.all(s).then(function(e){for(var n=[],o=0,r=e.length;o<r;o++)e[o]&&n.push(e[o]);t(null,n)},function(e){t(e)})}})},f.prototype.getManifestInfo=function(t,e,n){var r=this;Promise.all([new a(t,i.getSettings().stores.MANIFEST),new a(t,i.getSettings().stores.DOWNLOADS.DOWNLOADED),new a(t,i.getSettings().stores.STATUS),new a(t,i.getSettings().stores.PERSISTENT),new a(t,i.getSettings().stores.DATA)]).then(function(s){var a={},u=s[0]||{},f=s[1]||[],c=s[2]||{},h=s[3]||"",p=s[4]||"";a.status=c.status||d.BROKEN,a.details=c.details||void 0,r.downloadStorage.keyExists(t)||a.status!==d.STARTED||(a.status=d.BROKEN),a.manifest=u,a.manifest.files&&(a.manifest.totalFiles=a.manifest.files.length,!1===n&&delete a.manifest.files),a.left=c.left||0,a.persistent=h,a.downloaded=f.length,n&&(a.downloadedFiles=f),a.data=p,function(n){var s=n.manifest.name,a=n.manifest.url,u=o.resolve(i.getSettings().settingsFolder+"/"+t+"/"+s),d=r._manifestController.getManifestById(t);d?(n.manifestInfo=d.getJsonInfo(),e(null,n)):(d=new l(t)).loadFromLocal(u,a).then(function(){r._manifestController.cacheManifest(d),n.manifestInfo=d.getJsonInfo(),e(null,n)},function(t){t&&"ENOENT"===t.code?e():e(t)})}(a)},e)},f.prototype.getManifestFolderInfo=function(t,e){Promise.all([new a(t,i.getSettings().stores.MANIFEST)]).then(function(n){var s={},a=(n[0]||{}).folder;a||(a=i.getSettings().downloadsFolderPath);var u=o.join(a,t);s.folder=u,r(u,function(t,n){s.size=t?0:n,e(null,s)})},e)},f.prototype.getManifestInfoPromise=function(t,e){var n=this;return new Promise(function(o,r){n.getManifestInfo(t,function(t,e){t?r(t):o(e)},e)})},f.prototype.getManifestDataFile=function(t,e){new a(t,i.getSettings().stores.MANIFEST).then(function(t){e(t)},function(){e()})},f.prototype.remove=function(t,e,n){var r=i.getSettings().settingsFolder+t;this.getManifestDataFile(t,function(a){if(a){var u=a.folder;u||(u=o.resolve(i.getSettings().downloadsFolderPath)),s(u+"/"+t,function(t){t&&"ENOENT"!==t.code?n(t):s(r,function(t){t&&"ENOENT"!==t.code?n(t):e()})})}else s(r,function(t){t&&"ENOENT"!==t.code?n(t):e()})})},f.prototype.removePromise=function(t){var e=this;return new Promise(function(n,o){e.remove(t,n,o)})},f.prototype.removeAllPromise=function(){var t=this;return new Promise(function(e,n){var o=i.getSettings().settingsFolder;t.getManifestsList(function(r,i){if(r)n(r);else{for(var a=[],u=0,l=i.length;u<l;u++)a.push(t.removePromise(i[u]));Promise.all(a).then(function(){s(o,function(t){t&&"ENOENT"!==t.code?n(t):e()})},function(t){n(t)})}})})},f.prototype.restoreLocalManifest=function(t,e,n){var o=this;this.getManifestInfo(t,function(r,s){var i={};i.video=s.manifest.video,i.audio=s.manifest.audio,i.text=s.manifest.text,o._manifestController.saveManifestWithChosenRepresentations(t,i).then(e,n)})},f.prototype.setDownloadStorage=function(t){this.downloadStorage=t},t.exports=f},function(t,e){t.exports=d},function(t,e,n){"use strict";var o=n(4),r=n(3);function s(t,e,n,s){var i=r.resolve(t+"/"+e);return new Promise(function(t,r){o.stat(i,function(o,i){o?r(o):i.isDirectory()?(n||(e=void 0),t(e)):(s||(e=void 0),t(e))})})}t.exports=function(t,e,n){return void 0===e&&(e=!0),void 0===n&&(n=!0),new Promise(function(r,i){o.readdir(t,function(o,a){if(o)"ENOENT"===o.code||"ENOTDIR"===o.code?r([]):i(o.message);else{for(var u=[],l=0,d=a.length;l<d;l++)u.push(s(t,a[l],e,n));Promise.all(u).then(function(t){r(t.filter(function(t){return void 0!==t}))},function(t){i(t)})}})})}},function(t,e,n){"use strict";function o(){this._subscribers={}}o.prototype.addSubscriber=function(t){var e=t.getId();return this._subscribers[e]=t,e},o.prototype.removeSubscribersById=function(t){"string"==typeof t&&(t=[t]);for(var e=0,n=t.length;e<n;e++)this._subscribers[t[e]]&&(this._subscribers[t[e]].remove(),delete this._subscribers[t[e]])},o.prototype.removeAllManifestSubscribersById=function(t){var e=t&&this._subscribers[t];e&&this.unsubscribe(e.getManifestId())},o.prototype.unsubscribe=function(t){var e=[],n={};"string"==typeof t&&(t=[t]);for(var o=0,r=(t=t||[]).length;o<r;o++)n[t[o]]=!0;for(var s in this._subscribers)this._subscribers.hasOwnProperty(s)&&n[this._subscribers[s].getManifestId()]&&e.push(s);this.removeSubscribersById(e)},o.prototype.unsubscribeAll=function(){for(var t in this._subscribers)this._subscribers.hasOwnProperty(t)&&this._subscribers[t].remove();this._subscribers={}},t.exports=o},function(t,e,n){"use strict";(function(e){var o=n(104),r=n(3),s=n(4),i=n(106).fork,a=n(1),u=n(2).app;function l(t,e,n,o){this._offlineController=t,this._downloadController=e,this._maxOfflineContentPortRange=n,this._offlineContentPort=o,this.childProcess=void 0}l.prototype._startServer=function(t,n){var o=this,l=r.join(u.getAppPath(),"node_modules/downstream-electron");s.existsSync(r.join(l,"startServer.js"))||(l=r.join(u.getAppPath(),"node_modules/downstream-electron/api/server"),s.existsSync(r.join(l,"startServer.js"))||(l=u.getAppPath(),s.existsSync(r.join(l,"startServer.js"))||(l=e))),console.log("Server Path:",l);var d=r.join(l,"startServer.js");console.log("Script for server:",d),o.childProcess=i(d,[]);var f={cmd:"init",routeName:a.getSettings().downloadsName,port:t};o.childProcess.send(f),o.childProcess.on("error",function(t){console.error(t)}),o.childProcess.on("message",function(t){if("log"===t.cmd&&console.log(t.log),"listening_port"===t.cmd&&n(t.port),"get_info"===t.cmd){var e=t.requestId,r=t.args.manifest;o._offlineController.getManifestInfo(r,function(t,n){if(t)return o.childProcess.send({error:t,requestId:e});var r=n.manifest.folder;return r||(r=a.getSettings().downloadsFolderPath),o.childProcess.send({status:"OK",requestId:e,result:{folder:r,status:n.status}})})}if("is_downloading"===t.cmd){var s=t.requestId,i=t.args.manifest,u=t.args.file,l=o._downloadController.getDownloading(i,u),d=function(t){return t?o.childProcess.send({error:t,requestId:s}):o.childProcess.send({status:"OK",requestId:s})};if(!l)return d();o._downloadController.waitForDownload(l,d)}if("perform_seek"===t.cmd){var f=t.requestId,c=t.args.manifest,h=t.args.file;o._downloadController.performSeek(c,h,function(t){return t?o.childProcess.send({error:t,requestId:f}):o.childProcess.send({status:"OK",requestId:f})})}}),o.childProcess.on("close",function(t,e){null==t?console.log("Child process closed with signal:",e):console.log("Child process closed with code:",t)})},l.prototype.serveOfflineContent=function(t){var e=this;!function n(r){r>e._maxOfflineContentPortRange||o(r,function(o){o?n(++r):(console.log("Port found:",r),e._startServer(r,function(){e._offlineContentPort=r,t(e._offlineContentPort),console.info("Offline content served on port:",r)}))})}(this._offlineContentPort)},l.prototype.stop=function(){this.childProcess.kill("SIGTERM")},t.exports=l}).call(this,"/")},function(t,e,n){"use strict";var o=n(105);t.exports=function(t,e){var n=o.createServer().once("error",function(t){if(t)return e(t);e(null,!0)}).once("listening",function(){n.once("close",function(){e(null,!1)}).close()}).listen(t)}},function(t,e){t.exports=require("net")},function(t,e){t.exports=require("child_process")}])});